# Automated Market Making for Energy Sharing [∗]

#### Michele Fabi [†] Viraj Nadkarni [‡] Leonardo Leone [§] Matheus X.V. Ferreira [¶] December 2025

**Abstract**


We develop an axiomatic theory for Automated Market Makers (AMMs) in local


energy sharing markets and analyze the Markov Perfect Equilibrium of the result

ing economy with a Mean-Field Game. In this game, heterogeneous prosumers solve


a Bellman equation to optimize energy consumption, storage, and exchanges. Our


axioms identify a class of mechanisms with linear, Lipschitz continuous payment func

tions, where prices decrease with the aggregate supply-to-demand ratio of energy. We


prove that implementing batch execution and concentrated liquidity allows standard


design conditions from decentralized finance—quasi-concavity, monotonicity, and ho

motheticity—to construct AMMs that satisfy our axioms. The resulting AMMs are


budget-balanced and achieve ex-ante efficiency, contrasting with the strategy-proof, ex

post optimal VCG mechanism. Since the AMM implements a Potential Game, we solve


its equilibrium by first computing the social planner’s optimum and then decentralizing


the allocation. Numerical experiments using data from the Paris administrative region


suggest that the prosumer community can achieve gains from trade up to 40% relative


to the grid-only benchmark.


∗We are grateful to Ulysse Griffon for his research assistance. We also thank the audiences at the following
events for their feedback: The guest lecture in the _CS 6501: Economics of Distributed Systems_ course at the
University of Virginia (Fall 2024), seminars at Ecole Polytechnique (January 2025), the University of Virginia [´]
Computer Science Theory Seminar (February 2025), the UCSB DeFi Seminar (April 2025), the TLDR
Conference at Columbia Business School (May 2025), the Second Tech4Finance Conference at Universit´e
Paris Dauphine (March 2025), T´el´ecom Paris (June 2025), Princeton DeCenter (June and November 2025),
ANR BlockFi Workshop Grenoble (December 2025). We also thank Julien Prat, Alfred Lehar, Ciamac
Moallemi, Alkis Georgiadis-Harris for their valuable comments. Financial support from the Fellowship “The
Latest in Decentralized Finance” (TLDR, 2024/2025 cohort) is gratefully acknowledged.
†Telecom Paris, CREST, IP Paris. Mail: michele.fabi@telecom-paris.fr
‡Princeton University. Mail: viraj@princeton.edu
§Telecom Paris. Mail: leonardo.leone@telecom-paris.fr
¶University of Virginia. Mail: matheus@virginia.edu


1


### **1 Introduction**

The traditional architecture of the electric power grid is increasingly strained by the prolif
eration of Distributed Energy Resources (DERs), such as rooftop solar, electric vehicles, and

residential batteries. Designed primarily for uni-directional power flows from centralized gen
erators, the existing infrastructure struggles to accommodate the volatility and bi-directional

flows inherent to markets with significant DER penetration. Central to this landscape is the

figure of the power producer-consumer, or _prosumer_ . As the legacy grid model falters, these

actors offer the potential to reduce reliance on centralized generation and provide essential

distributed flexibility. This necessity is underscored by recent instability events, such as the

April 2025 blackout in the Iberian Peninsula (ENTSO-E, 2025) triggered by disturbances at

large-scale solar farms. This event exposed the fragility inherit in centralized power architec
tures, highlighting the need for decentralized markets mechanisms that coordinate prosumer

behavior to absorb such systemic shocks. In response to these challenges, this paper investi
gates the potential of Automated Market Makers (AMMs) to facilitate decentralized market

clearing within prosumer communities. We propose a design where the AMM functions as an

algorithmic intermediary that coordinates prosumers by quoting dynamic price curves based

on aggregate supply and demand. Our contribution is to provide an axiomatic characteri
zation of this mechanism and to analyze the properties of the resulting market equilibrium

within a mean-field game.

The AMM mechanism introduced in this paper is fundamentally different from AMMs in

decentralized finance (DeFi). First and foremost, the proposed energy AMM does not hold

an inventory, and thus does not rely on liquidity providers. It rather utilizes the main grid

as a buyer and seller of last resort. This configuration allows one to designate a coordinator

node within the local power grid to offer effectively “infinite liquidity” for residual imbalances.

The economic logic of the mechanism is to profit from operating within the spread between

the grid’s retail price—purchase price—and the feed-in tariff (FIT)—sale price. This margin

is often substantial; indeed, in many jurisdictions (such as Brazil) the FIT is effectively zero
(Empresa de Pesquisa Energ´etica, 2022). [1 2]


1In Brazil, the selling price is effectively zero for cash flows under the 2022 regulation. This policy reflects
a broader issue of renewable curtailment—exceeding 10% in some regions (Operador Nacional do Sistema
El´etrico, 2024)—caused by transmission congestion and insufficient local demand during peak generation
hours. By signaling abundance through lower prices, the AMM incentivizes local consumption and storage,
mitigating the need for such curtailment.
2In the European Union, 2023 data show that substantial spreads at peak-hours, e.g.: Spain (Buy €0.32
vs. Sell €0.06–0.10/kWh), France (Buy €0.25 vs. Sell €0.13–0.18/kWh), and the Netherlands (Buy €0.32
vs. Sell €0.08–0.12/kWh). Similarly, in the United States, the shift from Net Metering to Net Billing (e.g.,
California’s NEM 3.0) seems to have widened this gap, with export rates dropping to cost-avoidance levels
($0.05/kWh) against retail rates exceeding $0.30–0.40/kWh.


2


#### **1.1 Contribution and Paper Structure**

This paper makes both conceptual and quantitative contributions to the design and anal
ysis of local energy sharing markets. In the first part of the paper, Sections 2 and 3, we

demonstrate that design principles from blockchain-based Constant Function Market Makers

(CFMMs) apply in this context. In particular, price curves derived from trading functions

(i.e., potentials) that are suited for blockchain applications—namely those quasi-concave,

homothetic, and monotone—are compliant with market design axioms that guarantee an

efficient operation of local electricity markets. These axioms impose anonymous execution

of local trade, which distinguishes the AMM from order books and bilateral P2P matching

where the order of bids and the identity of the bidders matters. Furthermore, a coalition
proofness requirement implies that the AMM payment function is _linear_ in the prosumer’s

power flows and quotes marginal buying and selling prices that are bounded and decreasing

in the aggregate supply-to-demand ratio of power. The resulting AMM operates through

three distinct phases: (1) dynamic re-anchoring the trading function to align it in real-time

with the energy price (buying price) and the feed-in-tariff (selling price); (2) determination

of the internal clearing price via batch execution and concentrated liquidity; and (3) distri
bution of power export revenues and import costs proportionally to prosumers’ contribution

to the community power balance.

In the second part of the paper, Sections 4 and 5, we move from the definition of the

market mechanism to the analysis of strategic behavior _within_ the market. We model the

prosumer community interaction as a dynamic stochastic game involving a large population

of price-taking prosumers. Within this environment, each prosumer solves a dynamic op
timization problem to determine their net power profile—jointly optimizing consumption,

battery usage, and trading decisions—to maximize expected discounted profits over discrete

trading sessions.

As prosumers interact, market prices (and rational expectations on them) arise endoge
nously from the aggregate net flows induced by the mixed-strategy Markov Perfect Equi
librium (MPE) of the game. Solving for such equilibrium can, in principle, be challenging

due to the curse of dimensionality. However, a central finding of our paper establishes an

equivalence between the decentralized MPE and a centralized Social Planner problem. We

prove that the AMM frames the strategic environment as a _potential game_ : the mechanism

acts as a coordination device where the gradient of prosumers’ profit functions aligns with

the gradient of a global potential function, representing the prosumer community’s expected

gains from trading with the power grid (importing and exporting electricity). Under our

axioms, the “invisible hand” of the market is at work: a sub-optimal clearing of internal


3


supply and demand leads to arbitrage opportunities over quoted prices, which prosumers are

incentivized to exploit to restore efficiency.

The capability of coordinating prosumers purely by market forces, combined with its

simplicity, position the AMM as a practical alternative to market designs that have strug
gled to gain traction in recent years. For instance, pilot programs based on double auctions

often struggle to scale because they require residential users to actively bid and commit

to consumption schedules _before_ the actual power flows occur—a feature which may dis
courage non tech-savvy residential households. Conversely, while the Vickrey-Clarke-Groves

(VCG) mechanism achieves a stronger notion of efficiency (ex-post efficiency) and satisfies

strategy-proofness, it again requires full type disclosure ahead of power flows, and generally

runs a budget deficit. The AMM instead is budget-balanced and charges prosumers right

_after_ power exchanges occur based solely on on real-time metering data—making it more

suitable for possible integrations with automated smart-home energy management systems.

Moreover, by decentralizing the power flow optimization on the user side, the AMM fosters

the development of an open marketplace where energy startups can develop and offer power

profile optimization tools.

Besides conceptual relevance, our main equivalence result has practical implications. In

fact, we use it to develop a procedure that computes the equilibrium and simulates the

behavior of a representative prosumer community. A key property for doing so is the scale
invariance (homogeneity of degree one) of the AMM payment function. This property al
lows us to circumvent numerical integration over a high dimensional type space by making

the Planner’s Problem asymptotically equivalent to its deterministic mean-field limit—the

certainty-equivalent surplus of a representative prosumer. Based on this, we compute the

MPE by approximating the equilibrium mixed strategy of the infinite-dimensional population

via state-dependent representative types and “Monte-Carlo decentralization”—a procedure

that solves the equilibrium mixing weights for representative prosumers, then simulates the

distribution of induced actions it via Monte-Carlo sampling and Euclidean projection onto

the actual prosumers’ action spaces to enforce feasibility. Furthermore, we approximate

the infinite-horizon Bellman equation of the Planner by employing Model Predictive Con
trol (MPC) with a finite lookahead window, a technique established in battery optimization

theory and practice.

Finally, in the last part of our paper (Section 6), we bring the model to data to quantify

the benefits for both individual prosumers and their community. Using real-world weather
and consumption data from the [ˆ] Ile-de-France (Paris) region, we simulate a heterogeneous

community of 1,000 agents over a full year (2023), allowing them to optimize their strate
gies over discrete 15-minute intervals (96 decision time-steps per day). The population is


4


composed of 40% pure consumers, 30% solar prosumers (equipped with 1.6 _m_ [2] panels at

15% efficiency), and 30% wind prosumers (using 1.9m-blade turbines), all managing 20 kWh

residential batteries and a demand profile with 30% flexible load.

Our experiments reveal that the AMM generates substantial value by arbitrating the

spread between electricity retail tariffs and the community’s flexible needs. While the main

grid charges a peak rate of 21.46 c€/kWh and offers a meager feed-in tariff (FIT) of 8.86

c€/kWh, the AMM allows prosumers to trade internally at dynamic clearing prices that

frequently settle near 13–15 c€/kWh. This allows prosumers to satisfy demand at roughly

half the cost of peak grid power, while simultaneously selling surplus generation at a premium

of 50–60% over the standard FIT. By enabling agents to shift 30% of their flexible load and

synchronize 20 kWh batteries to these internal prices, the mechanism reduces the average

daily energy cost per agent from €1.24 to €0.72—a 60% reduction in individual spend—and

achieving community’s gains from internal trade of 42% relative to uncoordinated trading

with the power grid.

#### **Related Work**


To the best of our knowledge, this work represents the first effort to bridge literatures on the

economics and optimization of power systems, computational game theory, and decentralized

finance (DeFi).


**Distributed Optimization in Power Systems.** A substantial body of literature applies

the Alternating Direction Method of Multipliers (ADMM) and related decomposition tech
niques to Optimal Power Flow (OPF) and grid coordination problems (Boyd et al., 2011;

Erseghe, 2014; Moret et al., 2024). These approaches typically decompose the global op
timization problem into coupled subproblems solved iteratively by network agents. While

effective for computation, standard ADMM-based schemes do not generally ensure incentive

compatibility during the iterative process, nor do they offer a clear economic interpretation

of the intermediate “prices” (dual variables) prior to convergence. In contrast, the market

mechanism proposed herein relies on axiomatic pricing rules which guarantee that prices

remain economically meaningful even when the community has not yet reached its equilib
rium.

There is also an extensive literature on battery optimization techniques. We draw upon

recent advances in finite-horizon approximations for storage scheduling; in particular, (Prat

et al., 2024) show that (under mild regularity conditions) the quality of approximation to

the solution of an infinite-horizon Bellman equation using a rolling-horizon Model Predictive

Control (MPC) improves exponentially with the size of the MPC lookahead window.


5


**Equilibrium Analysis of Power Systems.** Strategic bidding and market clearing in

power systems populated by DERs have traditionally been modeled as bilevel optimization

problems or Mathematical Programs with Equilibrium Constraints (MPECs) (Hobbs, 2000;

Hasan et al., 2008; Gabriel et al., 2012). Our equilibrium analysis, however, diverges from

that paradigm and shares closer similarities with routing and congestion games. In these

frameworks, agents optimize flows over a network subject to costs that depend on aggregate

usage, often admitting a potential function that guarantees the existence and uniqueness of

an equilibrium (Rosenthal, 1973; Monderer and Shapley, 1996a).


**Automated Market Makers and Decentralized Finance.** Constant Function Market

Makers (CFMMs) have emerged as the dominant design paradigm for on-chain decentralized

exchanges. The axiomatic foundations of these mechanisms have been extensively studied,

demonstrating that trading functions which are quasi-concave, monotonic and homothetic

induce markets with desirable properties (Angeris et al., 2020, 2023; Schlegel et al., 2023;

Fabi and Prat, 2025). In this paper we show that such trading functions can be implemented

in this context to generate prices that effectively coordinate a community of prosumers.

AMMs with batch order execution—a feature of our proposed design—has been analyzed as

a possible way to implement execution fairness (Canidio and Fritsch, 2023; He et al., 2024).

We adapt these principles to the energy domain, replacing token inventories with grid-backed

liquidity.

The implementation of an AMM for energy grids falls into the scope of Decentral
ized Physical Infrastructure Networks (DePIN). While recent work has addressed incentive
compatible signal recovery in DePIN systems—such as verifying bandwidth claims (Milionis

et al., 2025)—our work assumes reliable smart meter data and focuses on the economic

behavior of agents.


**Peer-to-Peer Markets and Prosumer Economics.** The rise of the ”prosumer” has

necessitated new economic models for distributed energy interaction (Gautier et al., 2018,

2024). Extensive surveys on peer-to-peer (P2P) energy trading and local flexibility markets

highlight the diversity of proposed pricing mechanisms (Sousa et al., 2019; Crowley et al.,

2025; Pinson et al., 2020; Alfaverh et al., 2023). Our analysis demonstrates that many exist
ing P2P pricing rules can be recovered as special cases of the generalized trading functions

presented in this paper (Morstyn et al., 2019a,b), providing a unified theoretical framework

for local energy exchange.


6


**Mean-Field Games.** Our equilibrium results derived under large population approxima
tions by The theory of Mean Field Games (MFG) (Lasry and Lions, 2007; Gu´eant et al.,

2011), which deals with limits of games when the number of agents goes to infinity and pay
off externalities occur only through aggregate statistics of population actions, such as the

ratio of supply to demand in our case. While the core literature is focused on continuous
time stochastic games, our approach builds on recent discrete-time formulations (e.g., Doncel

et al., 2019; Guo et al., 2024). Our algorithm combines MPC and “Monte Carlo decentral
ization” to solve numerically the Master Equation of the game, given by the Social Planner’s

value function, together with the evolving distribution of battery States of Charge (SoC)

across the population.

### **2 Axiomatic Design of an Energy Sharing Market**


This section develops a formal model for a peer-to-peer (P2P) energy sharing market and

introduces a set of axioms that characterize a desirable pricing mechanism. For the purpose

of this axiomatic analysis, we treat individual energy flows as exogenously given; these flows

will be endogenized as solutions to prosumer optimization programs and as Markov Perfect

Nash Equilibrium (MPE) outcomes in Sections 4 and 5.

#### **2.1 The Microgrid**


We consider a local energy community (i.e., a microgrid) composed of a set _N_ = _{_ 1 _,_ 2 _, . . ., N_ _}_

of **prosumers** . These prosumers interact through a central **aggregator**, which facilitates

local energy trades to import or export power. The aggregator is also connected to the main
electrical grid. [3]


Within this framework, the aggregator operates as the community’s local **market maker** .

Its function is to pool all energy supply and demand from the prosumers and to set a single,

uniform price for buying and selling energy within the community, based on a determinis
tic function of these aggregates. This pooling mechanism provides “infinite” liquidity and

abstracts away the need for direct, bilateral negotiations between prosumers.

By complementing the local market maker, the main grid functions as the **market of**

**last resort** . It is an infinitely liquid external venue that guarantees the local community

can always balance its _net_ energy position after all internal trading has been resolved by the


3In principle, we can allow every prosumer to be also connected to the main grid, forming a double-star
network. However, the axoms defined later on in this section impose a participation (individual-rationality)
constraint such that prosumers always prefer to trade with the aggregator rather than directly with the
external gird.


7


_n_ 1


_n_ 2


_n_ 3


_n_ 4



A Grid



Figure 1: Microgrid Network Representation


aggregator. The main grid will buy any community-wide surplus and supply any community
wide deficit. For most of our analysis, we assume the grid’s capacity to do so is not binding.

The main grid, operated by a retailer (or a competitive retail market), sets two distinct

prices at each time _t_ for trading electricity. It buys energy from the community at an

exogenous **Feed-in Tariff (FiT)**, denoted by _λ_ ~~_t_~~, and sells energy to the community at a
higher **retail price**, _λt > λt_ . These two prices form the external benchmark and the price

boundaries for the local market.

#### **2.2 Market Definition**


We now formally define the local energy market and its properties. Market interactions

involve each prosumer _n ∈_ _N_ submitting a net energy flow, or _netput xn ∈_ R, to the

aggregator. Since we will describe pricing at a given time step, for notational simplicity, we

omit the time index _t_ . A positive flow ( _xn >_ 0) represents a net supply to the local market,
while a negative flow ( _xn <_ 0) represents a net demand. The collection of these individual
flows constitutes the market’s **allocation vector**, _**x**_ = ( _x_ 1 _, . . ., xN_ ) _∈_ R _[N]_ .

Although our full model is dynamic, with trades _xnt_ ( _e_ ) occurring at discrete trading

sessions _t_ within epochs _e_ (e.g., days), the definition of market and payment rules applies

to any single trading session. For this reason, for now we adopt a static view and omit the

time and epoch index for simplicity.

The mechanism’s function is to map this allocation to a vector of payments:


**Definition 1** (Market Mechanism) **.** _A market mechanism for energy sharing is a pair_

( _**x**_ _,_ _**P**_ ( _**x**_ )) _, where:_


 - _**x**_ = ( _x_ 1 _, . . ., xN_ ) _∈_ R _[N]_ _is the energy_ _**allocation vector**_ _._


 - _**P**_ : R _[N]_ _→_ R _[N]_ _is the_ _**payment function**_ _, which maps an allocation_ _**x**_ _to a payment_

_vector_ _**P**_ ( _**x**_ ) = ( _P_ 1( _**x**_ ) _, . . ., PN_ ( _**x**_ )) _._


8


_A positive payment Pn_ ( _**x**_ ) _>_ 0 _represents a revenue for prosumer n, while a negative payment_

_Pn_ ( _**x**_ ) _<_ 0 _represents a cost._


For our analysis, it is useful to decompose the net flows and payments into more intuitive

components. Specifically, An individual prosumer’s net flow _xn_ can be split into non-negative
**supply (** _sn_ **)** and **demand (** _dn_ **)** :


_xn_ = _sn −_ _dn,_ where _sn_ = max _{xn,_ 0 _}_ and _dn_ = max _{−xn,_ 0 _}._ (1)



Summing these across all prosumers gives the **aggregate local supply (** _s_ **)** and **aggregate**

**local demand (** _d_ **)** :
_s_ =             - _[s][n][,]_ and _d_ =             - _[d][n][.]_ (2)



and _d_ =     _n∈N_ _[s][n][,]_



(2)
_n∈N_ _[d][n][.]_



The community’s net position relative to the main grid is _xA_ = _s−d_ . This can be decomposed
into the total energy **exported to (** _sA_ **)** or **imported from (** _dA_ **)** the main grid:


_sA_ = max _{s −_ _d,_ 0 _},_ and _dA_ = max _{d −_ _s,_ 0 _}._ (3)


Similarly, each prosumer’s net payment _Pn_ ( _**x**_ ) is the difference between a non-negative **rev-**

**enue function** _Rn_ ( _**x**_ ) and a non-negative **cost function** _Cn_ ( _**x**_ ):


_Pn_ ( _**x**_ ) = _Rn_ ( _**x**_ ) _−_ _Cn_ ( _**x**_ ) _._ (4)

#### **2.3 Axiomatic Characterization**


Our goal is now to define design a mechanism based on a set of desirable features, detailed

by the axioms that will follow.


**2.3.1** **Anonymity**


In many P2P markets, such as those based on limit order books, the identity and arrival

time of an order can influence its execution price. This creates opportunities for preferential

treatment or strategic exploitation like front-running. To avoid this, a local energy sharing

market should be **anonymous** . Informally, this means that a prosumer’s payment should

depend only on their own energy contribution and the collective contributions of others, not

on anyone’s identity.


**Axiom 1** (Anonymity) **.** _A market mechanism_ ( _**x**_ _,_ _**P**_ ( _**x**_ )) _is_ _**anonymous**_ _if for any prosumer_


9


_n ∈_ _N and any permutation π of the other prosumers, the payment to n remains unchanged:_


_Pn_ ( _xn,_ _**x**_ _−n_ ) = _Pn_ ( _xn, π_ ( _**x**_ _−n_ )) _,_


_where_ _**x**_ _−n is the vector of allocations for all prosumers other than n, and π_ ( _**x**_ _−n_ ) _is the_

_vector with those allocations permuted._


**Anonymity and Batched Pricing.** The axiom of anonymity forces the payment function

to disregard the identities of the prosumers, meaning all trades can be processed as a single

batch. Formally, a prosumer’s payment can only depend on their own allocation, _xn_, and

the _multiset_ of all other allocations, denoted Σ( _**x**_ _−n_ ).


**Proposition 1.** _A market is anonymous if and only if there exists a function_ Φ : R _×_
Multiset(R _[N]_ _[−]_ [1] ) _→_ R _such that for any prosumer n:_


_Pn_ ( _xn,_ _**x**_ _−n_ ) = Φ( _xn,_ Σ( _**x**_ _−n_ )) _._


This functional form is the essence of an Automated Market Maker (AMM) in this con
text. Because the rules are anonymous, the mechanism is stripped of any discretion; it

cannot rely on subjective information about participants (e.g., identity, reputation, or past

behavior). Pricing must be determined solely from the submitted quantitative data via a

pre-defined, deterministic rule. This rule is, in effect, an algorithm, which is precisely what

makes the market maker ”automated.” Consequently, mechanisms that rely on order arrival

or identity, like limit order books and bilateral matching, are precluded.

Notice also that Anonymity is equivalent to the principle of **Fairness**, which requires

that prosumers who contribute identically are paid identically. A market is fair if _xn_ =
_xm_ = _⇒_ _Pn_ ( _**x**_ ) = _Pm_ ( _**x**_ ) for any two prosumers _n_ and _m_ .


**Equivalence to Fairness and Aggregation.** While the function Φ could depend on the

full distribution of trades, a powerful simplification is to make payments depend only on the

total aggregate supply ( _s_ ) and demand ( _d_ ). This leads to a more tractable pricing rule, Ψ:


_Pn_ ( _**x**_ ) = Ψ( _xn, s, d_ ) _._


The mechanisms constructed in this paper will adhere to this aggregation-based pricing

principle.


10


**2.3.2** **Coalition-Proofness**


A robust market mechanism should not incentivize strategic manipulation by groups of

participants. The axiom of **coalition-proofness** ensures that a group of prosumers (e.g.,

all sellers or all buyers) cannot benefit by merging their individual trades into a single,

larger trade, or by splitting a large trade into several smaller ones. This guarantees that the

mechanism treats individual contributions additively.


**Axiom 2** (Coalition-Proofness) **.** _A market mechanism is_ _**coalition-proof**_ _if for any coali-_

_tion of pure sellers I ⊆{n ∈_ _N | xn >_ 0 _} and any coalition of pure buyers J ⊆{n ∈_ _N |_
_xn <_ 0 _}, the following additivity conditions hold:_







_,_ - Ψ( _−dn, s, d_ ) = Ψ

_n∈J_








- Ψ( _sn, s, d_ ) = Ψ

_n∈I_





 - _sn, s, d_

_n∈I_





_−_ - _dn, s, d_

_n∈J_



(5)



This additivity requirement implies a linearity restriction on the functional form of the

payment function:


**Proposition 2** (Linear Payment Function) **.** _A market mechanism satisfying aggregation-_

_based pricing is coalition-proof if and only if the payment function Pn is linear in the pro-_
_sumer’s own supply sn and demand dn. Specifically, there exist price functions r_ ( _s, d_ ) _and_

_c_ ( _s, d_ ) _such that:_

_Pn_ ( _**x**_ ) = _sn · r_ ( _s, d_ ) _−_ _dn · c_ ( _s, d_ ) _,_


_where s_ = [�] _n∈N_ _[s]_ _n_ _[and][ d]_ [ =][ �] _n∈N_ _[d]_ _n_ _[are the aggregate supply and demand.]_


This proposition is a crucial step in our design. It proves that any anonymous, coalition
proof mechanism must operate by establishing a uniform **marginal selling price**, _r_ ( _s, d_ ),

for all sellers and a uniform **marginal buying price**, _c_ ( _s, d_ ), for all buyers. This result

dramatically simplifies our analysis: instead of reasoning about a complex, high-dimensional

payment function _**P**_ ( _**x**_ ), we can now focus on the properties of these two intuitive, one
dimensional price functions. All remaining axioms will be defined as constraints on the

behavior of _r_ ( _s, d_ ) and _c_ ( _s, d_ ).


**2.3.3** **Core Economic Axioms**


Having established that a rational market mechanism must use linear pricing, we now in
troduce three fundamental axioms that govern the behavior of the marginal price functions,

_r_ ( _s, d_ ) and _c_ ( _s, d_ ). These axioms ensure the mechanism is internally consistent, financially

viable, and economically beneficial to its participants.


11


**No-Arbitrage.** First, the mechanism must be free from internal arbitrage. A participant

must not be able to generate a risk-free profit by simultaneously buying and selling energy

from the aggregator. This requires that the marginal selling price can never exceed the

marginal buying price.


**Axiom 3** (No-Arbitrage) **.** _A market mechanism satisfies no-arbitrage if for any pair_ ( _s, d_ ) _:_


_r_ ( _s, d_ ) _≤_ _c_ ( _s, d_ ) _._ (6)


**Budget-Balance.** A core requirement for a self-sustaining market is that it must be fi
nancially viable without external subsidies. The axiom of budget-balance ensures this by

requiring that the total payments collected from buyers are at least as great as the total

revenues paid out to sellers.


**Axiom 4** (Budget-Balance) **.** _A market mechanism is budget-balanced if for any state_ ( _s, d_ ) _:_


_d · c_ ( _s, d_ ) _≥_ _s · r_ ( _s, d_ ) _._ (7)


_If the condition holds with equality, the mechanism is_ _**exactly budget-balanced**_ _._


**Individual Rationality (IR).** Finally, the mechanism must provide an incentive for pro
sumers to participate over their outside option of trading directly with the grid. The prices

offered by the local market must be strictly better than the grid’s prices when local sup
ply and demand can be matched, and they should converge to the grid’s prices when the

community has a net surplus or deficit that must be cleared externally.


**Axiom 5** (Individual Rationality) **.** _A market mechanism satisfies Individual Rationality_

_(IR) if the price functions r_ ( _s, d_ ) _and c_ ( _s, d_ ) _adhere to the following boundary conditions:_









_r_ ( _s, d_ ) _≥_ _λ,_ _if s < d,_



_and_
_r_ ( _s, d_ ) = _λ,_ _if s ≥_ _d,_














_c_ ( _s, d_ ) _≤_ _λ,_ _if s > d,_



(8)
_c_ ( _s, d_ ) = _λ,_ _if s ≤_ _d._








This IR condition is the economic justification for the local market’s existence and is

achieved in AMMs via **concentrated liquidity** .


**Remark on Continuity.** A direct consequence of Individual Rationality is that the total

cost and revenue functions, _Cn_ ( _**x**_ ) and _Rn_ ( _**x**_ ), must be Lipschitz continuous with constants


12


_λ_ and _λ_ respectively, implying that for any two allocations _**x**_ and _**x**_ _[′]_ that differ only for

prosumer _n_ :


_|Cn_ ( _**x**_ ) _−_ _Cn_ ( _**x**_ _[′]_ ) _| ≤_ _λ · |dn −_ _d_ _[′]_ _n_ _[|]_

_|Rn_ ( _**x**_ ) _−_ _Rn_ ( _**x**_ _[′]_ ) _| ≥_ _λ · |sn −_ _s_ _[′]_ _n_ _[|]_


**2.3.4** **Axioms on Qualitative Price Properties**


The final set of axioms governs the dynamic behavior of the price functions, ensuring they

respond to market conditions in an economically intuitive way.


**Monotonicity (Positive Prices).** To ensure that trades are meaningful, selling energy

must generate revenue and buying energy must incur a cost. This is guaranteed if the

marginal prices are strictly positive.


**Axiom 6** (Monotonicity) **.** _A market mechanism is_ _**monotonic**_ _if its price functions are_

_strictly positive:_

_r_ ( _s, d_ ) _>_ 0 _and_ _c_ ( _s, d_ ) _>_ 0 _,_ (9)


_for all s, d >_ 0 _._


**Responsiveness.** A well-behaved market should naturally counteract imbalances through

price signals. When aggregate supply increases, prices should strictly decrease to encourage

demand, and when aggregate demand increases, prices should strictly increase to encour
age supply. These conditions ensure that prosumers’ actions are **strategic substitutes**,

preventing extreme coordination failures. This property also provides incentives for **peak**

**shaving** .


**Axiom 7** (Responsiveness) **.** _A mechanism is_ _**responsive**_ _if its price functions’ partial_

_derivatives satisfy:_


_∂c_ _∂c_ _∂r_ _∂r_
_and_ (10)
_∂s_ _[<]_ [ 0] _[,]_ _∂d_ _[>]_ [ 0] _[,]_ _∂s_ _[<]_ [ 0] _[,]_ _∂d_ _[>]_ [ 0] _[.]_


Notice that Responsiveness combined with Individual Rationality (Eq. (8)) imply that in
ternal prices are strictly more favorable than the grid bounds whenever the community is in

a net imbalance:









_r_ ( _s, d_ ) _> λ,_ if _s < d,_



and
_r_ ( _s, d_ ) = _λ,_ if _s ≥_ _d,_














_c_ ( _s, d_ ) _< λ,_ if _s > d,_



(11)
_c_ ( _s, d_ ) = _λ,_ if _s ≤_ _d._








13


**Remark on Concavity.** The Responsiveness axiom does not, by itself, imply the convex
ity or concavity of the prosumers’ total cost and revenue functions, However, the axiom is

closely related to the geometric properties of the underlying market mechanism. For exam
ple, in the AMM constructions introduced later in Section 3 it is a direct consequence of

implementing a strictly **quasi-concave bonding curve** .


**Homogeneity.** For many theoretical models, it is useful to assume that prices depend only

on the _ratio_ of supply to demand, not on their absolute scale. A market with 100 kWh of

supply and 50 kWh of demand should have the same price as one with 10 kWh of supply

and 5 kWh of demand. This is the property of homogeneity of degree zero.


**Axiom 8** (Homogeneity) **.** _A mechanism is_ _**homogeneous**_ _if its price functions are homo-_

_geneous of degree zero, meaning for any scaling factor α >_ 0 _:_


_r_ ( _αs, αd_ ) = _r_ ( _s, d_ ) _and_ _c_ ( _αs, αd_ ) = _c_ ( _s, d_ ) _._ (12)


_This implies the prices can be written as a function of the supply-to-demand ratio, s/d._


The Homogeneity axiom plays a key role in Section 5 (Equilibrium Analysis) since scale

invariance of prices implies proportional scaling of the total prosumer community welfare

in the population size _N_ . This property is thus a necessary condition to approximate the

stochastic finite-player game implemented by the AMM with its deterministic Mean-Field

limit as _N →∞_ .

### **3 AMM Construction and Applications**


We now present a procedure to construct _Automated Market Makers (AMMs)_ for energy

trading that satisfies the design principles outlined in Section 2. While other market mech
anisms exist, an AMM offers a streamlined solution for local energy markets. Prices are

quoted automatically after energy transfers occur, making the market user-friendly as pro
sumers do not need to commit to a trade schedule ahead of time. Furthermore, AMMs

mitigate the lack of liquidity common in small residential communities by pooling supply

and demand, which can lead to tighter bid-ask spreads and faster matching than bilateral

exchange mechanisms.


**CFMM-style construction.** Our approach is to derive prices from a _trading function_,

_ψ_ ( _E, M_ ), which defines a potential over the money ( _M_ ) and energy ( _E_ ) in the AMM’s

pool. This logic is akin to the Constant-Function Market Makers (CFMMs) popular in


14


decentralized finance (e.g., Angeris and Chitra, 2020; Angeris et al., 2022). The core of a

CFMM is an invariant relationship, _ψ_ ( _E, M_ ) = _K_, where _K_ is constant for a trading session.

Standard CFMM theory indicates that the marginal price of energy, _P_, is the slope of the

function’s level sets:



_._
�����



_ρ_ ( _E, M_ ) =



_∂Eψ_
����� _∂M_ _ψ_



A canonical starting point is the constant-product function _ψCPMM_ ( _E, M_ ) = _E · M ≡_

_K_, used by the original Uniswap protocol, which yields a price of _ρ_ = _M/E_ . While this

specific function is not directly compatible with our axioms, its underlying principle forms

the foundation for our adapted models.


**Infrastructural and Operational Adaptations.** Adapting a financial CFMM to a phys
ical commodity market requires two key modifications. First, an energy AMM must be em
bedded in physical infrastructure. Unlike purely digital assets, energy is delivered through a

distribution grid, and prosumers’ contributions are mediated by trusted devices like **smart**

**meters** that record net energy flows. The AMM must also remain consistent with the

external market, importing deficits and exporting surpluses at the grid’s prices.

Second, the operational logic is fundamentally different. An energy market lacks the

traditional liquidity providers (LPs) of DeFi, as prosumers themselves supply the energy

that initializes the pool for each session. This inspires our mechanism guided by a dynamic

bonding curve. Through a process of **“re-anchoring,”** the level set of the trading function

is shifted at the start of each session based on the available energy and market conditions.

The market clearing process then proceeds in two steps: (1) internal matching of ∆ _E_ =

min _{dt, st}_ units of energy along the newly anchored curve, and (2) external balancing of

any residual with the grid.


**Remark on Implementation.** While we often consider a blockchain setting where a

smart contract can automate this process, the construction does not require it. The AMM

can be constructed by any trusted operator able to measure aggregate flows and apply

the pricing rules. These physical requirements—and the need to prevent sensor manipula
tion—are key challenges in the broader field of Decentralized Physical Infrastructure (DePIN)

projects (Milionis et al., 2025).

#### **3.1 Energy Provision and Trade**


We will now construct the AMM starting from the constant-product invariant and adjusting

it progressively. As mentioned previously, the bonding curve is now dynamic and adjusted at


15


each trading session. We let _{ψt_ ( _·, ·_ ) _}t∈T_ denote a family of trading functions parameterized
by time and _Kt_ the value achieved at the target level set for time _t_ .


**Concentrated Liquidity** To prevent arbitrage with the main grid’s feed-in tariff _λt_ and
retail price _λt_, the AMM must _concentrate liquidity_ and quote a local price _ρt_ ( _E, M_ ) _∈_

[ _λ_ ~~_t_~~ _, λt_ ]. Figure 2 shows how we shift the bonding curve to ensure the (internal) energy price

cannot exceed or drop below these boundary rates.


Figure 2: Constraining the AMM with Upper/Lower Bound Prices


**Batching and re-anchoring** At the beginning of the trading session _t_, prosumers charge

the pool with the total energy supplied _st_ . The pool starts with no monetary reserves, so its

initial state is ( _E_ 0 _, M_ 0) = ( _st,_ 0). We use this initial state along with the main grid’s prices

( _λt, λt_ ) to calculate a session-specific level set


Ä ä
_Kt ≡_ _K_ _st, λ_ ~~_t_~~ _, λt_ _._


thus fixing a bonding curve for the trading session:


        - Ä        ( _E, M_ ) _∈_ R [2] + [:] _[ ψ][t]_ [(] _[E, M]_ [) =] _[ K]_ _st, λ_ ~~_t_~~ _, λt_ ) _._


The bonding curve determines the amount of money the pool collects as a function of

the energy reserve (given the energy available at the start of the trading session). Once the

session’s bonding curve is fixed, we can derive how much money will the AMM collect from

prosumers:
Ä ä
_M_ ( _E_ 0 _,_ ∆ _E_ ) = _ψE_ _[−]_ = [1] _E_ 0 _−_ ∆ _E_ _K_ ( _st, λ_ ~~_t_~~ _, λt_ ) _,_ (13)

16


this can be computed given the initial supply _E_ 0 = _st_ can be calculated from Eq. (13) setting
∆ _E_ = min _{st, dt}_ . Figure 3 illustrates how capacity is deposited and depleted for the case of

three sell orders and two buy orders, starting with an empty battery and no initial capital.


Figure 3: (Left) Pool Initialization with Supply; (Right) Depletion of Capacity in Exchange
for Money


**Imbalance Management** After the internal P2P exchange is complete, the AMM must

settle any net energy imbalance by trading with the main grid. This process handles two

distinct scenarios, both of which can be understood geometrically using tangent lines to the

bonding curve, as illustrated in Figure 4.

When local supply exceeds demand, an energy surplus of ( _st−dt_ ) remains after all internal
demand has been met. At this point, the pool’s state is ( _st −_ _dt, Mt_ ( _st, dt_ )). This surplus is
then sold to the main grid at the feed-in tariff _λt_ . The additional revenue generated from
this external sale is _λ_ ~~_t_~~ ( _st_ _−_ _dt_ ). Geometrically, this corresponds to the monetary value gained

by moving along the tangent line from the final internal trading state, as shown in the left

panel of Figure 4.

When local demand exceeds supply, the entire internal supply _st_ is consumed. The
internal trading phase concludes with the pool in a state of full depletion: (0 _, Mt_ ( _st, st_ )). To
satisfy the remaining demand, the AMM must import the energy shortfall of ( _dt −_ _st_ ) from
the main grid at the retail price _λt_ . The additional cost incurred is _λt_ ( _dt_ _−st_ ). Geometrically,

this cost is represented by the tangent line at the point of full depletion, as illustrated in the

right panel of Figure 4.


17


Figure 4: Managing Surpluses (left) and Deficits (right) via Tangent-Line Shifts


**Payments.** Finally, the AMM distributes costs and revenues among prosumers. The smart

contract first categorizes prosumers as net buyers or net sellers based on their energy contri
bution. It then calculates the total costs for buyers and total revenues for sellers, distributing

them proportionally based on each prosumer’s share of the total demand ( _dnt/dt_ ) or supply

( _snt/st_ ), respectively. This distribution process depends on the net energy balance of the

community, leading to three distinct cases:

**Case I:** _dt_ = _st_ **(Balanced Market).** The total cost and revenue are equal to the pool’s
final monetary value, _Ctotal_ = _Rtotal_ = _Mt_ ( _st, st_ ). The resulting per-unit prices are:



_ct_ ( _st, dt_ ) = _[M][t]_ [(] _[s][t][, s][t]_ [)]




_[s][t][, s][t]_ [)]

_,_ _rt_ ( _st, dt_ ) = _[M][t]_ [(] _[s][t][, s][t]_ [)]
_dt_ _st_



(14)
_st_



**Case II:** _dt < st_ **(Excess Supply).** The total cost for buyers is determined by the internal
trade, _Ctotal_ = _Mt_ ( _st, dt_ ). The total revenue for sellers includes this amount plus the income
from selling the surplus ( _st −_ _dt_ ) to the grid at price _λ_ ~~_t_~~ . The prices are:




_[s][t][, d][t]_ [)]

_,_ _rt_ ( _st, dt_ ) = _[M][t]_ [(] _[s][t][, d][t]_ [) +] _[ λ][t]_ [(] _[s][t][ −]_ _[d][t]_ [)]
_dt_ _st_



_ct_ ( _st, dt_ ) = _[M][t]_ [(] _[s][t][, d][t]_ [)]



(15)
_st_



**Case III:** _dt > st_ **(Excess Demand).** The total revenue for sellers is determined by the full
depletion of their supply, _Rtotal_ = _Mt_ ( _st, st_ ). The total cost for buyers includes this amount
plus the cost of importing the deficit ( _dt −_ _st_ ) from the grid at price _λt_ . The prices are:



_ct_ ( _st, dt_ ) = _[M][t]_ [(] _[s][t][, s][t]_ [) +] _[ λ][t]_ [(] _[d][t][ −]_ _[s][t]_ [)]



(16)
_st_




_[ λ][t]_ [(] _[d][t][ −]_ _[s][t]_ [)]

_,_ _rt_ ( _st, dt_ ) = _[M][t]_ [(] _[s][t][, s][t]_ [)]
_dt_ _st_



18


While payments can be generalized to other repartition schemes, the proportional method

is unique in ensuring the market is coalition-proof, as established in the previous section.

Furthermore, if the AMM is not required to be strictly budget-balanced in every session, a

dynamic fee can be introduced based on aggregate supply or demand.

#### **3.2 Bonding Curves and Other Pricing Functions**


We now present three applications of the general construction from the previous section:

linear, hyperbolic, and logarithmic bonding curves. Figure 5 compares the resulting buy ( _ct_ )
and sell ( _rt_ ) price curves for each model as a function of the supply-demand ratio _yt_ = _st/dt_ .


Figure 5: Comparison of Bonding Curves


Figure 6: Comparison of buy ( _c_ ) and sell ( _r_ ) price curves for the Constant Price (MMR),
Hyperbolic (CP-EMM), and SDR price mechanism, plotted against the supply-demand ratio.


19


**Linear Bonding Curve (Constant Internal Price)**


To implement a constant internal price _ρt_ ( _E, M_ ) = _ρt ∈_ [ _λt, λt_ ] for all internally matched

energy, we use a linear trading function. The trading function and corresponding session

invariant are:

_ψt_ ( _M, E_ ) = _M_ + _ρtE,_ _Kt_ = _ρtst._ (17)


Solving for the monetary reserve _M_ yields a simple, linear Pool Value Function:


_Mt_ ( _st,_ ∆ _E_ ) = _ρt_ ∆ _E._


This simple form gives rise to the following price functions after accounting for imbalances

with the grid:


_ct_ ( _y_ ) = _ρt_ + ( _λt −_ _ρt_ ) (1 _−_ _y_ ) [+] _,_ _rt_ ( _y_ ) = _ρt −_ ( _ρt −_ _λt_ ) [�] 1 _−_ 1 _/y_ [�][+] _._ (18)


**Hyperbolic Bonding Curve (CP-EMM)**


This AMM is constructed from a hyperbolic trading function adapted from the standard
constant-product formula. We first define a session-specific parameter [4]




~~�~~



_χt ≡_



_λtλ_ ~~_t_~~

~~�~~



_._
_λt −_ ~~_[√]_~~ _λ_ ~~_t_~~



The trading function and session invariant are then defined as:



ä [�]
_Ktλt_







_ψt_ ( _M, E_ ) = Ä _M_ + ~~�~~



_E_ +



_Kt_

_λt_



_,_ _Kt_ = ( _stχt_ ) [2] _._ (19)



This construction gives rise to pricing based on an adjusted geometric-market-rate. When

the market is balanced ( _y_ = 1), it implements an over-provision penalty to incentivize an


4The symbol _χ_ will be redefined later on to represent collections of Lagrange multipliers and representative prosumer types.


20


efficient match between local generation and consumption. The final price functions are:







_rt_ ( _y_ ) = _χt_



_χt_
(1 _−_ 1 _/y_ ) [+] + ~~_√_~~ _χt_



_t_ _−_ ~~�~~


_λt_



_λ_ ~~_t_~~





~~~~ + (1 _−_ 1 _/y_ ) [+] _λt,_ (20)










_ct_ ( _y_ ) = _y · χt_



_χt_
(1 _−_ 1 _/y_ ) [+] + ~~_√_~~ _χt_



_t_ _−_ ~~�~~


_λt_



_λ_ ~~_t_~~



~~~~ + (1 _−_ _y_ ) [+] _λt._ (21)



In CREF APPENDIX, we show that the hyperbolic trading function gives rise to pricing

based on an _adjusted_ geometric-market-rate (GMR): when the market is perfectly balanced

( _st_ = _dt_ ), the effective price for internally traded energy is the geometric mean of the grid
~~»~~
prices, _λ_ [geo] _t_ = _λt ·_ _λ_ [¯] _t_ . When supply exceeds demand ( _st > dt_ ), the AMM implements

an over-provision penalty to incentivize an efficient match between local generation and

consumption.


**Logarithmic Bonding Curve**


This model is derived from a price function that depends on the ratio of total supply to
demand withdrawn. [5] The marginal price for internal trades is:


_ρt_ ( _E_ 0 _, M_ ( _E_ 0 _,_ ∆ _E_ )) = _λtλt_
( _λt −_ _λ_ ~~_t_~~ )(1 _−_ ∆ _E/E_ 0) [+] + _λ_ ~~_t_~~


Integrating this price function yields the Money Reserve function:



_λt_
( _λt −_ _λ_ ~~_t_~~ )(1 _−_ ∆ _E/E_ 0) [+] + _λ_ ~~_t_~~



Ç



å



_Mt_ ( _E_ 0 _,_ ∆ _E_ ) = _E_ 0



_λtλt_ ln
_λt −_ _λt_



The final per-unit prices for sellers ( _rt_ ) and buyers ( _ct_ ) are determined by substituting this
_Mt_ into the general payment rules:



å



_rt_ ( _y_ ) = _λtλ_ ~~_t_~~ _·_ ln
_λt −_ _λ_ ~~_t_~~



Ç _λt_

( _λt −_ _λ_ ~~_t_~~ )(1 _−_ 1 _/y_ ) [+] + _λt_



_λt_
( _λt −_ _λ_ ~~_t_~~ )(1 _−_ 1 _/y_ ) [+] + _λ_ ~~_t_~~



_ct_ ( _y_ ) = _y ·_ _λtλ_ ~~_t_~~ ln
_λt −_ _λ_ ~~_t_~~



Ç



+ (1 _−_ 1 _/y_ ) [+] _λ_ ~~_t_~~ (22)


å

+ (1 _−_ _y_ ) [+] _λt_ (23)



5The expression is derived from a price function of the form _P_ ( _E_ 0 _−_ ∆ _E, M_ ( _E_ 0 _,_ ∆ _E_ )) =

- _a_ (1 _−_ ∆ _E/E_ 0) + _b_ - _−_ 1, where the constants _a, b ∈_ R are determined by the boundary conditions _P_ ( _E_ 0 _,_ 0) =
_λ_ ~~_t_~~ and _P_ (0 _, M_ ( _E_ 0 _, E_ 0)) = _λt_ .

21


The behavior of this pricing rule is similar to the Hyperbolic one. While a corresponding

trading function _ψt_ exists, its form is convoluted. It is therefore more intuitive in this case

to define the mechanism directly via its bonding curve.

#### **3.3 Other Pricing Rules from the Literature**


We now review several common pricing mechanisms from the energy sharing literature and

evaluate them against our axiomatic framework. We will see that some of them can be

generated by the above trading functions.


**Bill Sharing (BS).** An intuitive mechanism, Bill Sharing (BS) assigns the community’s

total grid costs to buyers and total grid revenues to sellers Xiong et al. (2022). The effective
prices are _ct_ ( _y_ ) = _λt_ (1 _−_ _y_ ) [+] and _rt_ ( _y_ ) = _λt_ (1 _−_ 1 _/y_ ) [+] . While simple, this mechanism is

structurally flawed. It violates **Individual Rationality**, as a prosumer is not guaranteed

a better price than their outside option. For example, a seller receives zero revenue if the

community has a net deficit.


**Mid-Market Rate (MMR).** The Mid-Market Rate (MMR) rule sets the internal trading

price to the average of the grid’s bid and ask prices Muntasir et al. (2023). This mechanism

is a special case of our **Linear Bonding Curve** model where the internal price is set to

the arithmetic mean, _ρt_ = ( _λt_ + _λt_ ) _/_ 2. When imbalances occur, the cost or revenue is

shared proportionally. The linear model is a general framework that also allows for other

                  constant-price rules, such as the Geometric-Market-Rate (GMR), by setting _ρt_ = _λtλt_ .


**Supply-Demand Ratio (SDR).** The SDR mechanism defines a responsive price that

interpolates between the grid’s prices based on the supply-demand ratio _y_ Xiong et al.

(2022). The selling price is a decreasing function of market surplus, and the buying price is

determined by the budget-balance condition:



_λt · λt_
if 0 _≤_ _y ≤_ 1 _,_
( _λt −_ _λt_ ) _y_ + _λ_ ~~_t_~~



_,_ _ct_ ( _y_ ) =



_rt_ ( _y_ ) =












 _y · r_ ( _y_ ) + (1 _−_ _y_ ) _λt_ if 0 _≤_ _y ≤_ 1 _,_





 _λt_ if _y >_ 1 _,_



 _r_ ( _y_ ) if _y >_ 1 _._



Table 1 summarizes our axiomatic analysis. Both MMR and SDR are robust mechanisms

that satisfy all axioms unconditionally. Our CP-EMM, representative of AMMs derived

from strictly quasi-concave potentials (e.g., Log-EMM), also satisfies the axioms, with a

single conditional exception for Monotonicity.


22


**Axiom** **BS** **MMR** **SDR** **CP-EMM**


Anonymity ✓ ✓ ✓ ✓


Coalition-Proof ✓ ✓ ✓ ✓


No-Arbitrage ✓ ✓ ✓ ✓


Budget-Balance ✓ ✓ ✓ ✓


Individual Rationality ✗ ✓ ✓ ✓
### Monotonicity ✗ ✓ ✓ • Responsiveness ✓ ✓ ✓ •


Homogeneity ✓ ✓ ✓ ✓


Table 1: Comparison of pricing mechanisms against key design axioms. The CP-EMM, the
Log-bonding curve and the GMM satisfy the same axioms.

### • Axiom holds only if λt > 0.

#### **3.4 Market Design Guarantees**


We now formalize the link between the properties of the underlying trading function and the

axiomatic compliance of the resulting AMM.


**Proposition 3** (Axiom Compliance via Geometric Construction) **.** _Let an AMM be con-_

_structed using batch execution, proportional payment rules, and with its liquidity concentrated_

_**strictly within**_ _the grid’s prices, ρt_ ( _E, M_ ) _∈_ ( _λ_ ~~_t_~~ _, λt_ ) _. Then, a market mechanism satisfies_

_the axioms of Anonymity, Coalition-Proofness, Budget-Balance, Individual Rationality, No-_

_Arbitrage, Monotonicity, Homogeneity, and Responsiveness if and only if the underlying_

_trading function ψ_ ( _E, M_ ) _is_ _**(i) strictly increasing in E and M, (ii) homothetic,**_

_**and (iii) quasi-concave**_ _._


Both directions of the equivalence arise from the interaction between the axioms of Sec
tion 2 and the geometry of the trading function.

In the forward direction, once batch execution and proportional payments are fixed,

the mechanism is entirely determined by the trajectory traced along a single bonding curve

during internal matching. Increasingness of the curve then guarantees that both reserves rep
resent positively valued assets, ensuring strictly positive prices. Homotheticity guarantees

that only the supply–demand ratio matters, yielding homogeneous pricing. Quasi-concavity


23


ensures convex level sets and thus a price schedule that reacts monotonically to imbal
ances, producing the responsiveness required for peak shaving and strategic substitutability.

Finally, concentrating liquidity strictly within the grid’s bid–ask interval ensures that all

internal trades occur at strictly better prices than the outside option, enforcing individual

rationality, preventing arbitrage with the main grid, and, together with proportional sharing,

guaranteeing budget balance.

In the reverse direction, the axioms themselves impose strong shape restrictions that

precisely recover the geometric structure of such a trading function. Anonymity eliminates

dependence on order identity and forces the mechanism to aggregate trades into a single

batch, while coalition-proofness requires that payments be linear in individual quantities,

leaving proportional sharing as the unique feasible allocation rule. No-arbitrage, individual

rationality, and budget-balance together imply the existence of a well-defined _demand curve_,

describing how much energy the mechanism is willing to hold at a given price. Under the

axioms, this curve must be flat outside the interval [ _λ_ ~~_t_~~ _, λt_ ] and strictly decreasing within it;

as shown in the Myersonian framework of Milionis et al. (2024), such curves are in one-to-one

correspondence with strictly increasing, homothetic, quasi-concave trading potentials whose

liquidity is concentrated inside the same interval. Thus the axioms force the mechanism to

admit exactly the geometric representation used in our construction, completing the necessity

direction.


**Remark.** Since MMR and SDR also satisfy the axioms, we can simply derive the quasi
concave curves for them. It turns out that they are all a special type of a linear trading

function. Specifically, they can all be represented as _M_ + _ρE_ = _c_, where _ρ_ is ( _λt_ + _λ_ ~~_t_~~ ) _/_ 2 for




~~�~~
the arithmetic MMR,



SDR pricing rules.



_λt · λt_
_λtλ_ ~~_t_~~ for the geometric MMR, and for the
( _λt −_ _λt_ ) min(1 _, y_ ) + _λt_


### **4 Prosumer Optimization**

Having defined a market mechanism, we now model the behavior of individual prosumers

operating within it. This section develops a dynamic optimization model for a single pro
sumer facing the AMM prices. We will use this formalism analyze a prosumer’s optimal

decision (their best-response) given a belief on the price path. This forms the basis for the

equilibrium characterization of Section 5. We also use the prosumer model to quantify the

benefits of participating in the AMM compared to direct grid trading in Section 6.


24


#### **4.1 Prosumer Model**

We model the prosumer’s decision-making process using (epoch-based) discrete-time dynamic

programming. Time unfolds over epochs _e_ = 1 _,_ 2 _, . . ._, here representing days. Each epoch

is divided into _T_ timesteps _t_ = 1 _, . . ., T_, each of duration ∆hours (e.g., ∆= 0 _._ 25 for 15
minute intervals, _T_ = 96). Table 2 summarizes the notation needed to define the prosumer’s

optimization problem.


**Prosumer Characteristics.** A prosumer _n_ is characterized by a set of static parameters

and dynamic (state) variables. The static parameters include physical constraints—battery

energy capacity _Bn_ (kWh), battery power limit _Kn_ (kW), and grid connection limit _Xn_

(kW)—and parameters governing energy generation and consumption profiles. Within each

epoch _e_, the prosumer observes their initial battery state _bn_ 0( _e_ ) (kWh) and forecasts for
their net load profile over the _T_ timesteps. This profile consists of local generation _ωnt_ (kW)
and baseline consumption _αnt_ [base] (kW). Additionally, the prosumer has a total flexible energy
requirement _αn_ [flex] (kWh) that must be met cumulatively over the epoch.


**Decision Variables.** In each timestep _t_ of epoch _e_, the prosumer chooses three power

flows: consumption _pnt ≥_ 0, battery charge/discharge _knt ∈_ [ _−Kn, Kn_ ] (with _knt >_ 0 indicating charging), and net grid trade _xnt ∈_ [ _−Xn, Xn_ ]. We decompose _xnt_ into non-negative
power sold, _snt_ = max _{xnt,_ 0 _}_, and power bought, _dnt_ = max _{−xnt,_ 0 _}_ .


**Power Balance.** At each timestep _t_, the instantaneous power flows must balance. For
mally, local generation ( _ωnt_ ) plus power imported from the grid ( _dnt_ ) must equal the power

consumed locally ( _pnt_ ), power stored in the battery ( _knt_, positive if charging), and power
exported to the grid ( _snt_ ): _ωnt_ + _dnt_ = _pnt_ + _knt_ + _snt_ (kW).


**Consumption Constraints.** Power consumption _pnt_ must always cover the essential, nonshiftable baseline load, _pnt ≥_ _αnt_ [base] (kW). Additionally, the total energy consumed _above_ this
baseline over the entire epoch must exactly meet the flexible load target: - _Tt_ =1 [(] _[p][nt]_ _[−]_ _[α]_ _nt_ [base][) =]
_αn_ [flex][.][6][ This cumulative constraint models deferrable energy needs, such as electric vehicle]
charging or running specific appliances, that must be completed within the epoch but whose
timing can be optimized. [7]


6It is equivalent to have ~~[�]~~ _t_ _[T]_ =1 [(] _[p][nt][ −]_ _[α]_ _nt_ [base][)] _[ ≥]_ _[α]_ _n_ [flex] since the constraint will bind at the optimum.
7For notational simplicity we treat the timestep as the unit of time in the constraints. This makes energy
quantities (kWh) numerically equivalent to average power (kW). To ensure the objective function is correctly
calculated in Euros, we multiply the price parameters by the timestep duration ∆. This converts hourly
tariffs (€/kWh) into effective prices per unit of power (€/kW).


25


**Battery Constraints.** For prosumers equipped with storage ( _Bn >_ 0), the battery’s state
of charge (SoC) _bnt_ (kWh) at the end of timestep _t_ evolves according to the battery dynamics
_bnt_ = _bn,t−_ 1( _e_ ) + _knt_, where _knt_ is the charging ( _>_ 0) or discharging ( _<_ 0) power and _bn,_ 0( _e_ )

is the initial state for the epoch. The SoC is constrained by the physical battery capacity

limits, 0 _≤_ _bnt ≤_ _Bn_ (kWh). Furthermore, the rate of charge or discharge is limited by the
battery power limits, _−Kn ≤_ _knt ≤_ _Kn_ (kW).


**Grid Connection Limits.** Power exchanged with the grid is constrained by the connec
tion capacity _Xn_ . Both selling _snt_ and buying _dnt_ are non-negative power flows, individually
bounded by this limit: 0 _≤_ _snt ≤_ _Xn_ (kW) and 0 _≤_ _dnt ≤_ _Xn_ (kW). These bounds implicitly
enforce the net trade constraint _|snt −_ _dnt| ≤_ _Xn_ .


**Inter-Epoch Link.** The prosumer value function is connected across consecutive epochs

through the battery state. The terminal state of charge at the end of epoch _e_, _bnT_ ( _e_ ),

becomes the initial state of charge for the subsequent epoch _e_ + 1: _bn_ 0( _e_ + 1) = _bnT_ ( _e_ ).


**Objective Function.** The prosumer’s objective is to maximize the total expected dis
counted (net) profit over an infinite horizon. This dynamic optimization problem can be

expressed recursively using the Bellman equation. For a single epoch _e_, given the initial bat
tery state _bn_ 0( _e_ ), the value function Π _n_ ( _bn_ 0( _e_ )) represents the maximum achievable expected
future profit: [8]







(24)



Π _n_ ( _bn_ 0( _e_ )) = _{_ **p** max _,_ **k** _,_ **s** _,_ **d** _}_ [E]




- _T_

 


_Pn_ ( **x** _t_ ( _e_ )) + _γ_ Π _n_ ( _bn_ 0( _e_ + 1))
_t_ =1



Here, the maximization is over the sequences of decisions within epoch _e_ . The term

- _T_
_t_ =1 _[P][n]_ [(] **[x]** _[t]_ [(] _[e]_ [)) represents the total net profit (€) accumulated within the current epoch]
_e_, where _Pn_ ( **x** _t_ ( _e_ )) is the net payment received (positive for revenue, negative for cost)

for the power allocation **x** _t_ ( _e_ ) at timestep _t_ . The term _γ_ Π _n_ ( _bn_ 0( _e_ + 1)) is the discounted
continuation value, starting from the next epoch’s initial state _bn_ 0( _e_ + 1), with _γ ∈_ [0 _,_ 1)

being the discount factor between epochs.


8To be fully rigorous, the prosumer’s payoff in a given epoch is quasi-linear and defined as [�] _t_ _[T]_ =1 _[P][n]_ [(] **[x]** _[t]_ [)+]
_In_ ( **p** ), where _In_ is the (convex) characteristic function of the feasible set: _In_ ( **p** ) = 0 if the consumption
schedule satisfies the load requirements, i.e., _pnt ≥_ _αnt_ [base] for all _t_ and [�] _t_ [(] _[p][nt][ −]_ _[α]_ _nt_ [base][) =] _[ α]_ _n_ [flex][, and] _[ I][n]_ [(] **[p]** [) =]

_−∞_ otherwise.


26


#### **4.2 The Best-Response Program**

We now analyze the prosumer’s problem of optimizing profits by best responding to a (per
fectly) forecasted path of prices ¯ **r** and ¯ **c** (€/kW):







(25)



max
_{_ **s** _,_ **d** _,_ **k** _,_ **p** _,_ **b** _}_




- _T_




�(¯ _rtsnt −_ _c_ ¯ _tdnt_ ) + _γ_ Π [¯] _n_ ( _bnT_ )

_t_ =1



subject to the following constraints for _t_ = 1 _, . . ., T_ :


- Power Balance: _ωnt_ + _dnt_ = _pnt_ + _knt_ + _snt_ (Lagrange multiplier: _θnt_ )


- Baseline Consumption: _pnt ≥_ _αnt_ [base]


- Flexible Load Target: - _Tt_ =1 [(] _[p][nt]_ _[−]_ _[α]_ _nt_ [base][) =] _[ α]_ _n_ [flex]


- Battery Dynamics: _bnt_ = _bn,t−_ 1( _e_ ) + _knt_


- Battery State Limits: 0 _≤_ _bnt ≤_ _Bn_


- Battery Power Limits: _−Kn ≤_ _knt ≤_ _Kn_


- Grid Transmission Limits: 0 _≤_ _snt ≤_ _Xn_, 0 _≤_ _dnt ≤_ _Xn_


Appendix B shows how to express Eq. (25) and its constraints in a more compact matrix

form. Since the objective function is concave and the feasible set defined by the linear

constraints is convex, this is a convex optimization problem.


**Remark.** The value function in Eq. (25) can account for intra-epoch discounting by scaling
prices (¯ _ct,_ ¯ _rt_ ) by _γ_ _[t/T]_ .


**Trading Behavior.** The optimal action plan of the prosumer follows from the KKT and

stationary condition of the Lagrangian associated to the above optimization problem. In

particular, the trading strategy can be understood looking at the dual space of the optimiza
tion problem, in particular by analyzing how the Lagrange multiplier of the Power Balance
constraint, _θnt_ _[∗]_ [relates to the market prices (¯] _[r][t][,]_ [ ¯] _[c][t]_ [).]
Intuitively, the multiplier _θ_ _[∗]_ represents the _shadow price_ of power, or the price that the

prosumer would attribute to its power budget. This leads the prosumer to sell power in
periods where _θnt_ _[∗]_ _[≤]_ _[r]_ [¯] _[t]_ [, to buy power in periods where] _[ θ]_ _nt_ _[∗]_ _[≥]_ _[r]_ [¯] _[t]_ [, and to not trade in the]
intermediate range, ¯ _rt < θnt_ _[∗]_ _[<]_ [ ¯] _[c][t]_ [. In the previous relationships for active trading, strict]


27


inequalities denote binding transmission limits ( _Xn_ ), whereas equalities imply internal con
straints (e.g., consumption constraints, battery capacity) determine the volume by equating

marginal value to price. Formally,



(26)



_Xn_ if _θnt_ _[∗]_ _[<]_ [ ¯] _[r][t]_ (Transmission-Constrained Selling)



_s_ _[∗]_ _nt_ _[∈]_ [(0] _[, X][n]_ [)] if _θnt_ _[∗]_ [= ¯] _[r][t]_ (Internally-Constrained Selling)



_x_ _[∗]_ _nt_ [=]


















0 if ¯ _rt < θnt_ _[∗]_ _[<]_ [ ¯] _[c][t]_ (No Trade)

















_−d_ _[∗]_ _nt_ _[∈]_ [(] _[−][X][n][,]_ [ 0)] if _θnt_ _[∗]_ [= ¯] _[c][t]_ (Internally-Constrained Buying)



_−Xn_ if _θnt_ _[∗]_ _[>]_ [ ¯] _[c][t]_ (Transmission-Constrained Buying)


#### **4.3 Computation via Model Predictive Control**

Directly solving the infinite-horizon problem (24) is computationally intractable. We there
fore approximate the solution using **Model Predictive Control (MPC)** on rolling-horizon

(Prat et al., 2024). In each epoch _e_, the prosumer solves a deterministic Linear Program (LP)

over a finite _lookahead window_ of _L_ epochs ( _e, . . ., e_ + _L −_ 1), based on available forecasts.
Let **z** [(] _[L]_ [)] denote the stacked vector of decision variables over these _L_ epochs. The opti
mization problem is given by:


max **c** [(] _π_ _[L]_ [)] _[⊤]_ **z** [(] _[L]_ [)] (27)
**z** [(] _[L]_ [)] _∈A_ _[L]_ _n_ [(] _[b][n]_ [0][(] _[e]_ [))]


where _A_ _[L]_ _n_ [(] _[b][n]_ [0][(] _[e]_ [)) represents the feasible set over] _[ L]_ [ epochs starting from state] _[ b][n]_ [0][(] _[e]_ [), and]
**c** [(] _π_ _[L]_ [)] is the vector of forecasted effective prices. After doing so, only the optimal plan for the
_first epoch_, _**a**_ _[∗]_ _n_ [(] _[e]_ [)] _[ ⊂]_ **[z]** _[∗]_ [(] _[L]_ [)][, is implemented.]
The lookahead horizon _L_ is adaptively increased until the terminal state stabilizes, en
suring the finite window approximation is sufficiently precise. The resulting terminal state

_bnT_ ( _e_ ) then serves as the initial state _bn_ 0( _e_ + 1) for the subsequent epoch’s optimization.

Algorithm 1 shows the full implementation of this procedure.


28


**Algorithm 1** Rolling-Horizon MPC for Prosumer Optimization


**Require:** Total epochs (i.e., horizon) _H_, prosumer type _θn_, initial state _bn_ 0(1), price forecasts _{_ ¯ **r** ( _e_ _[′]_ ) _,_ ¯ **c** ( _e_ _[′]_ ) _}_ _[H]_ _e_ _[′]_ =1 [+] _[L][max]_, tolerance _ϵ_ .
**Ensure:** Sequences of optimal plans _{_ _**a**_ _[∗]_ _n_ [(] _[e]_ [)] _[}]_ [, profits] _[ {]_ [Π] _[∗]_ _n_ [(] _[e]_ [)] _[}]_ [, first-epoch dual vars]
_{_ Λ _[∗]_ ( _e_ ) _}_ _[H]_ _e_ =1 [.]

1: Initialize storage: _**A**_ _[∗]_ _n_ _[,]_ **[ Π]** _[∗]_ _n_ _[,]_ **[ Λ]** _[∗]_ _[←∅]_ [.]

2: _b_ [current] _n_ 0 _←_ _bn_ 0(1).

3: **for** _e_ = 1 **to** _H_ **do** _▷_ Outer loop: Rolling horizon

4: _L ←_ 1; converged _←_ false; _b_ [(0)] _res_ _[←−∞]_ [.] _▷_ Inner loop: Find lookahead horizon _L_

5: **while not** converged **do**

Ä
6: ( **z** _[∗]_ [(] _[L]_ [)] _,_ Λ _[L]_ ) _←_ arg max **z** ( _L_ ) _∈ALn_ [(] _[b]_ [current] _n_ 0 ) **c** [(] _π_ _[L]_ [)] _[⊤]_ **z** [(] _[L]_ [)][ä] . _▷_ Solve L-epoch LP

7: Extract L-epoch battery plan **k** _[∗]_ [(] _[L]_ [)] _⊂_ **z** _[∗]_ [(] _[L]_ [)] .

8: _b_ [(] _res_ _[L]_ [)] _[←]_ _[b]_ _n_ [current] 0 + [�] _e_ _[e][′]_ [+] = _[L]_ _e_ _[−]_ [1]  - _Tt_ =1 _[k]_ _nt_ _[∗]_ [(] _[e][′]_ [).] _▷_ Terminal state after L epochs

9: **if** _L >_ 1 **and** _|b_ [(] _res_ _[L]_ [)] _[−]_ _[b]_ _res_ [(] _[L][−]_ [1)] _| < ϵ_ **then**

10: converged _←_ true.

11: **else**

12: _b_ [(] _res_ _[L][−]_ [1)] _←_ _b_ [(] _res_ _[L]_ [)][;] _[ L][ ←]_ _[L]_ [ + 1.]

13: **if** _e_ + _L −_ 1 _> H_ + _Lmax_ **then** converged _←_ true.

14: **end if**

15: **end if**

16: **end while**

_▷_ Extract results for the first epoch ( _e_ ) from converged solution:

17: _**a**_ _[∗]_ _n_ [(] _[e]_ [)] _[ ←{][s][∗]_ _nt_ [(] _[e]_ [)] _[, d][∗]_ _nt_ [(] _[e]_ [)] _[, k]_ _nt_ _[∗]_ [(] _[e]_ [)] _[, p][∗]_ _nt_ [(] _[e]_ [)] _[}][T]_ _t_ =1 _[⊂]_ **[z]** _[∗]_ [(] _[L]_ [)][.]

18: Λ _[∗]_ ( _e_ ) _←{θnt_ _[∗]_ [(] _[e]_ [)] _[, µ][∗]_ _nt_ [(] _[e]_ [)] _[, ν]_ _n_ _[∗]_ [(] _[e]_ [)] _[, . . .][ }][T]_ _t_ =1 _[⊂]_ [Λ] _[L]_ [.]

19: Π _[∗]_ _n_ [(] _[e]_ [)] _[ ←]_ [�] _[T]_ _t_ =1 [(¯] _[r][t]_ [(] _[e]_ [)] _[s][∗]_ _nt_ [(] _[e]_ [)] _[ −]_ _[c]_ [¯] _[t]_ [(] _[e]_ [)] _[d][∗]_ _nt_ [(] _[e]_ [)).]

_▷_ Store results and update state for next epoch:

20: _**A**_ _[∗]_ _n_ _[←]_ _**[A]**_ _n_ _[∗]_ _[∪{]_ _**[a]**_ _n_ _[∗]_ [(] _[e]_ [)] _[}]_ [;] **[ Π]** _[∗]_ _n_ _[←]_ **[Π]** _n_ _[∗]_ _[∪{]_ [Π] _n_ _[∗]_ [(] _[e]_ [)] _[}]_ [;] **[ Λ]** _[∗]_ _[←]_ **[Λ]** _[∗]_ _[∪{]_ [Λ] _[∗]_ [(] _[e]_ [)] _[}]_ [.]

21: _bnT_ ( _e_ ) _←_ _b_ [current] _n_ 0 + [�] _t_ _[T]_ =1 _[k]_ _nt_ _[∗]_ [(] _[e]_ [).]

22: _b_ [current] _n_ 0 _←_ _bnT_ ( _e_ ). _▷_ Update initial state for epoch _e_ + 1

23: **end for**

24: **return** _**A**_ _[∗]_ _n_ _[,]_ **[ Π]** _[∗]_ _n_ _[,]_ **[ Λ]** _[∗]_ [.]

### **5 Equilibrium Analysis**


In the previous section, we analyzed a single prosumer’s optimization problem by assuming

perfect foresight of the price path. We now relax this assumption and study the strategic

interactions among all prosumers in a multi-agent setting.

As prosumers’ decision-making unfolds over an infinite horizon, the appropriate frame
work to study their interaction is a dynamic stochastic game. We first characterize the


29


**Bayes-Nash Equilibrium (BNE)** for a single epoch, taking continuation values as given.

We then concatenate these stage games to analyze the resulting **Markov Perfect Equilib-**

**rium (MPE)** of the stochastic game.

#### **5.1 Equilibrium Concept**


**Strategic Environment and Prosumer Beliefs.** At the beginning of each epoch _e_, the

stage game is determined a public state _ze_ (e.g., meteorological conditions) and by each
prosumer _n_ ’s private state, consisting of their battery level _bn_ 0( _e_ ) and their epoch-specific

type _θn_ ( _e_ ).

The public state captures common sources of randomness as the joint distribution of

types is conditional on it, _F_ ( _**θ**_ _| ze_ ). Each prosumer observes their own type but only holds

probabilistic beliefs about the types of others.

We focus on mixed-strategy equilibria. A prosumer with type _θ_ has a feasible action set

_A_ ( _θ_ ). Because prosumers are atomistic, their individual optimization problem is a linear

program (see Section 4.2). Thus, any best response to an expected price path is an extreme

point of this set, _**a**_ _∈_ ext( _A_ ( _θ_ )). A mixed strategy is therefore a measurable mapping
Ä ä
_σ_ : Θ _→_ _∆_ ext( _A_ ( _θ_ )) _,_ which assigns to each _type_ a probability distribution over the

extreme points available to that type. Therefore, a **mixed-strategy profile** for the _N_ prosumer game is given by the following mapping: [9]



_**σ**_ : _×_ _[N]_ _n_ =1 [Θ] _[n]_ _[→]_



_N_

- _∆_ Ä ext( _A_ ( _θn_ ))ä _._

_n_ =1



Given a mixed-strategy profile, and conditional on a realized type profile _**θ**_, a pure action
profile **a** is played with probability [�] _n_ _[N]_ =1 _[σ][n]_ [(] **[a]** _[n]_ _[|][ θ][n]_ [)] _[.]_
Under the common prior assumption, all prosumers hold the same belief about the ex
pected price paths, which can be computed by taking expectations over types and induced

actions:



_rt_ ( _yt_ ( **a** )) _·_


_ct_ ( _yt_ ( **a** )) _·_



_N_









      _r_ ¯ _t_ ( _**σ**_ _| ze_ ) =

**Θ**









_N_




_σn_ ( **a** _n|θn_ )
_n_ =1



_σn_ ( **a** _n|θn_ )
_n_ =1



_dF_ ( _**θ**_ _| ze_ ) (28)


_dF_ ( _**θ**_ _| ze_ ) (29)








      _c_ ¯ _t_ ( _**σ**_ _| ze_ ) =

**Θ**






**a** _∈A_ ext




**a** _∈A_ ext



where _yt_ ( **a** ) is the aggregate supply-to-demand ratio resulting from the action profile **a** .


9Since _A_ ( _θ_ ) depends only on a prosumer’s type and not on their index, the strategy space is typesymmetric.


30


**Equilibrium Definitions.** A strategy profile _**σ**_ _[∗]_ is a BNE if each prosumer’s strategy
is a best response to the strategies of all others, _**σ**_ _−_ _[∗]_ _n_ [. Since prices are determined by the]
aggregate behavior induced by _**σ**_ _[∗]_, equilibrium solves a fixed-point problem in which beliefs
about prices coincide with the expected prices arising in equilibrium. Let ¯ _**ρ**_ _[∗]_ = (¯ _**r**_ _[∗]_ _,_ ¯ _**c**_ _[∗]_ ) denote
these equilibrium expected prices. [10] Given ¯ _**ρ**_ _[∗]_, the payoff from a pure (extreme-point) action

plan **a** _n_ for prosumer _n_ is



_πn_ ( **a** _n,_ ¯ _**ρ**_ _[∗]_ ) =



_T_



_t_ =1



Ä ä
_r_ ¯ _t_ _[∗]_ _[s][nt]_ _[−]_ _[c]_ [¯] _[∗]_ _t_ _[d][nt]_ _._



Since we consider a large population of prosumer, we model each prosumer as _atomistic_

and hence _price-taker_ : a unilateral deviation of a single prosumer from the strategy profile

does not affect the net marginal prices quoted by the AMM. Formally,


**Assumption 1** (Atomicity) **.** _For any prosumer n and type θn, a deviation form σn_ ( _· | θn_ )
_to σn_ _[′]_ [(] _[· |][ θ][n]_ [)] _[ leaves the prices quoted by the AMM unchanged:]_


_r_ ( _s_ ( _**σ**_ ) _, d_ ( _**σ**_ )) = _r_ ( _s_ ( _σn_ _[′]_ _[,]_ _**[ σ]**_ _[−][n]_ [)] _[, d]_ [(] _[σ]_ _n_ _[′]_ _[,]_ _**[ σ]**_ _[−][n]_ [))] _[,]_ _c_ ( _s_ ( _**σ**_ ) _, d_ ( _**σ**_ )) = _c_ ( _s_ ( _σn_ _[′]_ _[,]_ _**[ σ]**_ _[−][n]_ [)] _[, d]_ [(] _[σ]_ _n_ _[′]_ _[,]_ _**[ σ]**_ _[−][n]_ [))] _[.]_


We can now define BNE in this context as follows: [11]


**Definition 2** (Mean-Field BNE) **.** _A pair_ ( _**σ**_ _[∗]_ _,_ ¯ _**ρ**_ _[∗]_ ) _is a Mean-Field Bayes-Nash Equilibrium_

_of the stage game if:_


_(a)_ _**Incentive-Compatibility:**_ _For every prosumer n and type θn ∈_ Θ _n, the mixed strat-_
_egy σn_ _[∗]_ [(] _[·|][θ][n]_ [)] _[ maximizes the prosumer’s expected profit given the equilibrium prices]_ [ ¯] _**[ρ]**_ _[∗][:]_



_σn_ _[∗]_ [(] _[·|][θ][n]_ [)] _[ ∈]_ [arg] max
_σn∈_ ∆( _ext_ ( _An_ ))




 - _σn_ ( **a** _n_ ) _· πn_ ( **a** _n,_ ¯ _**ρ**_ _[∗]_ ) (30)

**a** _n∈ext_ ( _An_ )



_(b)_ _**Rational Expectations:**_ _The expected price vector_ ¯ _**ρ**_ _[∗]_ _is generated by the aggregate_
_behavior of all prosumers playing according to the strategy profile_ _**σ**_ _[∗]_ _, conditional on_

_the public state ze, according to Eqs._ (28) _and_ (29) _:_


_r_ ¯ _t_ _[∗]_ [= ¯] _[r][t]_ [(] _**[σ]**_ _[ |][ z][e]_ [)] _c_ ¯ _[∗]_ _t_ [= ¯] _[c][t]_ [(] _**[σ]**_ _[ |][ z][e]_ [)] _[.]_

10For notational convenience, we use variations of the symbol _ρ_ to define AMM prices in different contexts:
in Section 3, _ρ_ ( _E, M_ ) denotes the AMM _internal_ marginal price, while in the current section, ¯ _**ρ**_ _[∗]_ denotes the
rational expectation of “final” AMM prices, accounting for the pro-rata repartition of the trading surplus or
deficit.
11An equivalence definition of incentive-compatibility can be stated requiring indifference among pure
strategies in the mixing support: for each type _θn_ and any **a** _n,_ **a** _n_ _[′]_ _[∈]_ [ext(] _[A]_ [(] _[θ][n]_ [)) with] _[ σ]_ _n_ _[∗]_ [(] **[a]** _[n]_ _[|][ θ][n]_ [)] _[ >]_ [ 0 and]
_σn_ _[∗]_ [(] **[a]** _n_ _[′]_ _[|][ θ][n]_ [)] _[ >]_ [ 0, we have] _[ π][n]_ [(] **[a]** _[n][,]_ [ ¯] _**[ρ]**_ _[∗]_ [) =] _[ π][n]_ [(] **[a]** _n_ _[′]_ _[,]_ [ ¯] _**[ρ]**_ _[∗]_ [) = max] **a** _∈_ ext( _A_ ( _θn_ )) _[π][n]_ [(] **[a]** _[,]_ [ ¯] _**[ρ]**_ _[∗]_ [).]

31


_(c)_ _**Atomicity**_ _: The prices quoted by the AMM r_ ( _s_ ( _**σ**_ ) _, d_ ( _**σ**_ )) _and c_ ( _s_ ( _**σ**_ ) _, d_ ( _**σ**_ )) _are not_
_affected by a deviation of single prosumer n from strategy σn_ ( _.|θn_ ) _to σn_ _[′]_ [(] _[.][|][θ][n]_ [)] _[ (Assump-]_
_tion 1)._


**Dynamic Extension: Markov Perfect Equilibrium.** The definition of BNE describes

equilibrium interaction for a single epoch. However, prosumers interact with the AMM

repeatedly over epochs to maximize discounted future profits. The previous Equilibrium

definition 2 can thus be extended to the dynamic setting by requiring strategies to be Marko
vian in payoff-relevant state variables, such as the initial battery level and the public signal.

Letting Π _n_ denote prosumer _n_ ’s value function, we now define:


**Definition 3** (MPE) **.** _A triple_ ( _**σ**_ _[∗]_ _,_ ¯ _**ρ**_ _[∗]_ _,_ Π _[∗]_ ) _is a Markov Perfect Equilibrium if, for every_

_prosumer n, the value function satisfies_



Π _n_ ( _bn_ 0( _e_ ) _, ze_ ) = max
_σn_ ( _·|θn_ )




- _πn_ ( _σn,_ _**σ**_ _−_ _[∗]_ _n_ _[,]_ [ ¯] _**[ρ]**_ _[∗]_ [) +] _[ γ]_ [ E] îΠ _n_ ( _bn_ 0( _e_ + 1) _, ze_ +1) _σn,_ _**σ**_ _−∗_ _n_ ó [�] _,_
���



_and the maximizer is the equilibrium strategy σn_ _[∗]_ [(] _[· |][ θ][n]_ [)] _[.]_ _The continuation value_ Π _[∗]_ _is_
_stationary under the equilibrium strategy profile._

#### **5.2 Characterization of prosumer equilibria**


So far, we have analyzed how prosumers would best-respond to a market making mechanism.

Given their response, the question still remains whether the resulting power flows and prices

maximize some notion of welfare.

To this end, we now show a powerful equivalence based on the Axioms of Section 2.

Under those axioms indeed the BNE of the prosumers’ stage game leads to a (randomized)

allocation of power flows that is the same as the one a Social Planner would choose to

maximize the expected trade profits of the prosumer community with the power grid.


**Proposition 4** (Welfare Equivalence) **.** _A strategy profile is a BNE of the stage-game if and_

_only if it maximizes the expected value of trade profits with the grid:_



Ä ä [�]
_sAt_ ( _**σ**_ ( _**θ**_ )) _· λ_ ~~_t_~~ _−_ _dAt_ ( _**σ**_ ( _**θ**_ )) _· λt_



_W_ ( _**σ**_ ) = E _**θ**_ _∼F_ ( _·|ze_ )




- _T_



_t_ =1



_._ (31)



This result is powerful because it establishes that, in this context, the First and Second

Welfare Theorems hold (Mas-Colell et al., 1995) and the AMM essentially implements a

_competitive equilibrium_ among prosumers: The AMM serves as a “zero-sum redistribution


32


engine” that _complements_ the main electrical market to coordinate prosumers into solving

collectively a (soft) market clearing problem.

To better see this, we can express the objective of the Planner (and hence of the prosumer
collective) in terms of netput vectors: [12]



ô



_W_ ( _**σ**_ ) = E _**θ**_ _∼F_ ( _·|ze_ )



ñ

_**λ**_ _[⊤]_ **mid** **[X]** [(] _**[σ]**_ [(] _**[θ]**_ [))] _[ −]_ _**[λ]**_ _[⊤]_ **spread** _[||]_ **[ X]** [(] _**[σ]**_ [(] _**[θ]**_ [))] _[ ||]_ [1]



(32)



where **X** = ( _x_ 1 _, . . ., xT_ ), and _**λ**_ **mid**, _**λ**_ **spread** are vectors of mid-prices and mid-spreads. with
respective elements ( _**λ**_ _[⊤]_ **mid** [)] _[t]_ [= (] _[λ][t]_ [+] _[ λ]_ _t_ [)] _[/]_ [2, and (] _**[λ]**_ **[spread]** [)] _[t]_ [= (] _[λ][t]_ _[−]_ _[λ]_ ~~_t_~~ [)] _[/]_ [2.]
According to Eq. (32), the Planner achieves optimality by matching internal demand

with supply to avoid the bid-ask spread (with penalty coming from the _L_ 1-norm), while

shifting any residual grid trades to periods where the mid-price is favorable. Since the

community’s total net energy balance over an epoch is mostly fixed, the planner objective

is usually dominated by the minimization of the weighted _L_ 1-minimization of a weighted

netput vector:

                   -                   min _**σ**_ [E] _**[θ]**_ _[∼][F]_ [(] _[·|][z][e]_ [)] ��� _**λ**_ spread _·_ **X** ( _**σ**_ ( _**θ**_ ))���1 _._


The sufficiency part of Proposition 4 (BNE = _⇒_ Max Welfare) can be established solely

based on Exact Budget Balance (Axiom 4) and Atomocity (Assumption 1). In particular,

from these two assumptions it emerges that the AMM creates a Potential Game (Monderer

and Shapley, 1996b) where the potential function is exactly the community welfare.


**Proposition 5** (Potential Game) **.** _The prosumer game is a potential game with potential_

_function equal to the expected global welfare, W_ ( _**σ**_ ) _._


This is intuitive since Budget Balance establishes that internal transfers net-out and

Atomicity ensures that a single prosumer’s deviation has a negligible effect on the prices

faced by others, effectively eliminating price externalities. This potential game structure

guarantees no efficiency loss due to decentralization (i.e., a Price of Anarchy of 1).

The necessity direction of Proposition 4 (Max Welfare = _⇒_ BNE) is slightly trickier

to prove and relies on two additional axioms on top of those needed for proving sufficcy,

namely Individual Rationality (Axiom 5) and Responsiveness (Axiom 7). These two axioms

ensure that whenever internal clearing is not optimized, there exists a profitable arbitrage

opportunity on AMM prices that prosumers can be exploit to increase profits.

It is important to notice that Proposition 4 holds _regardless_ of which internal price

functions or trading function _ψ_ ( _·_ ) is used—as long as it is axiom-compliant and prosumers


12The transformation follows using the properties of the absolute value operator: _x_ + = ( _|x|_ + _x_ ) _/_ 2,
_x_ _[−]_ = ( _|x| −_ _x_ ) _/_ 2.


33


behave atomistically. In this sense, Proposition 4 provides us with a benchmark result. One

way to pin down a specific curve or pricing mechanism would be by attributing priorities

among prosumers, which would relax the linearity assumption on welfare. Doing so could be

done for example by assigning different utility functions in accordance to assigned priorities

(for example, the hospital would have higher priority than residential households.) We will

discuss more this aspect in the conclusion (Section 7).

Besides of theoretical importance, Proposition 4 has also practical implication for com
puting equilibria. Thanks to it we can reduce a complex equilibrium problem to solving a

Planner’s problem and then decentralizing the solution satisfying individual feasibility (see

Section 5.4).


**Dynamic Extension**


The stage-game analysis above focuses on a single epoch. When we consider how strategies

evolve over time, we extend these efficiency results to the dynamic setting.


**Proposition 6** (Markov Perfect Equilibria) **.** _The dynamic game exhibits a multiplicity of_
_mixed-strategy MPEs. However, every equilibrium strategy profile_ _**σ**_ _[∗]_ _implements the same_

_unique aggregate outcome that maximizes the expected discounted profit of the local grid:_




- _T_



_t_ =1



Ä ä [�]
_sAt ·_ _λt −_ _dAt · λt_



_V_ _[∗]_ = max
_**σ**_



_∞_


_γ_ _[e]_ E _**θ**_ _∼F_ ( _·|ze_ )
_e_ =1



_._ (33)



This proposition confirms that the static welfare equivalence extends to the dynamic

case: any MPE maximizes the long-term discounted net trade profits.
While the aggregate value _V_ _[∗]_ and the optimal path of grid trades are unique, the specific
strategy profile _**σ**_ _[∗]_ is not. Because (in every interesting application) the number of degrees

of freedom in the choice of the mixing weights vastly exceeds the number of aggregate

constraints, there exists a continuum of mixed strategies that all map to the exact same

optimal aggregate outcome.

#### **5.3 Efficiency and Mechanism Comparison**


We benchmark the proposed AMM by comparing its welfare properties against the theo
retical first-best outcome achievable by an omniscient social planner. While Proposition 4

establishes that the AMM maximizes the _expected_ welfare of the community, this is an **ex-**

**ante** notion of efficiency, as prosumers optimize their strategies based on probabilistic beliefs

about others. An ideal planner who observes the realization of all types _**θ**_ _before_ allocating


34


resources could achieve a higher **ex-post** welfare by making the power flows contingent on

the realization of the private state ( _**θ**_ _,_ _**b**_ **0** ) (as well as the the public state). The relationship

is captured by the following inequality:


             -             _W_ VCG _≡_ E _**θ**_ max _w_ ( **x** _,_ _**θ**_ ) _≥_ max E _**θ**_    - _w_ ( **x** ( _**σ**_ ) _,_ _**θ**_ )� _≡_ _W_ AMM (34)
**x** _**σ**_


where _w_ ( _·_ ) denotes the realized global welfare for a specific type profile. The gap between

these two values can be interpreted as the “price” of higher privacy and decentralization.


**The Vickrey-Clarke-Groves (VCG) Benchmark.** The canonical mechanism for im
plementing the ex-post social optimum ( _W_ VCG) is the Vickrey-Clarke-Groves (VCG) mecha
nism (Vickrey, 1961; Clarke, 1971; Groves, 1973). In this direct-revelation setup, each agent
_n_ reports their type _θ_ [ˆ] _n_ . The mechanism then implements the socially optimal allocation
**x** _[∗]_ ( _**θ**_ [ˆ] ) and charges each agent a payment equal to the externality they impose on others:




_−_ - _wj_ ( **x** _[∗]_ ( _**θ**_ [ˆ] ) _,_ _θ_ [ˆ] _j_ ) _._

_j_ = _n_




    
- _wj_ ( **x** _−n,_ _θ_ [ˆ] _j_ )

_j_ = _n_



_Pn_ [VCG] ( _**θ**_ [ˆ] ) =





max
**x** _−n_



VCG is **strategy-proof** (truthful reporting is a dominant strategy) and achieves the un
constrained ex-post maximum welfare. However, its theoretical optimality is hardly practical

for local energy communities.

First, VCG is not budget-balanced (it generally runs a deficit), implying that the commu
nity would require an external subsidy to operate. Also, it requires prosumers to reveal their

full private types (e.g., battery states and consumption/generation profiles) to the Planner

_before_ choosing their power flows. Besides raising possibly privacy concerns, it can be par
ticularly inconvenient for residential prosumers having to commit ahead of time to an energy

schedule.

In contrast, the AMM described in this paper is an **indirect mechanism** that can better

deal with these issues. It sacrifices strategy-proofness and ex-post optimality to guarantee

the two properties that VCG lacks: By satisfying Budget Balance (Axiom 4), the AMM

ensures the market is self-sustaining without external subsidies. Furthermore, pricing is

purely based on traded quantities rather than the full prosumer type, and payments are

determined _after_ recording the power flows.

For these reasons, the AMM is a practical alternative to a full VCG implementation: It

is an optimal mechanism within the class of budget-balanced, anonymous, and responsive

mechanisms, and achieves the maximum possible welfare without subsidies and with lower

informational requirements on the prosumers.


35


#### **5.4 Equilibrium Computation**

Computing the Markov Perfect Equilibrium (MPE) for a dynamic game with a continuum of

heterogeneous agents can be challenging. However, the Welfare Equivalence result (Propo
sition 4) provides a crucial simplification: instead of solving for the fixed point of _N_ coupled

Bellman equations, we can simply solve a single concave Planner’s Problem and then decen
tralize the allocation. We leverage this insight to construct the numerical procedure applied

in Section 6 to data from metropolitan Paris.

The algorithm that we develop hereafter to approximate the infinite-horizon equilibrium

proceeds epoch by epoch. In each epoch _e_, given the current empirical distribution of battery
states _νe_ = _N_ [1] - _Nn_ =1 _[δ][b]_ _n_ 0 [(] _[e]_ [)][, we compute an approximate BNE over a lookahead horizon of] _[ L]_

epochs. This computation follows a four–stage procedure:

(i) the continuous population is quantized into **state-dependent representative**

**types**,

(ii) the dimensionality of the **action space is reduced** by restricting choices to a subset

of salient strategies for these types based on their current state,

(iii) a (potentially regularized) **planner problem** is solved to find the equilibrium strate
gies maximizing the mean-field welfare, and

(iv) the coordinated allocation is **decentralized** back to individuals via Euclidean pro
jection.

While the equilibrium calculation considers the full _L_ -epoch horizon to incorporate

forward-looking behavior, only the actions corresponding to the _first_ epoch ( _l_ = 1) are

implemented. The resulting distribution of terminal battery states then determines the ini
tial state distribution _νe_ +1 for the next epoch. Algorithm 2 summarizes this rolling-horizon

procedure that we will now outline in detail.


**Population Approximation.** To begin with, the equilibrium solver algorithm needs a

type population as input. We represent such population by approximating the type space Θ

with a _mixed histogram_ . This structure enables the joint modeling of **discrete categories**

_c ∈_ _C_ (e.g., simple consumers and solar prosumers) and **continuous attributes** (e.g.,

capacities, generation profiles). For each category _c_, we partition the attribute space into
cells _{Rc,j}_ _[J]_ _j_ =1 _[c]_ [with associated weights] _[ w][c,j]_ [, inducing a collection of uniform classes:]


           - ©
_H_ = ( _c, Rc,j, wc,j_ ) _| c ∈_ _C,_ 1 _≤_ _j ≤_ _Jc_ _._


36


We then generate a simulated population of _N_ agents by Monte-Carlo sampling from this

structure:
Ä ä
_θn ∼_ Unif _{c} × Rc,j_ with probability _ωc,j._


In each epoch _e_, an agent’s full state consists of their static type _θn_ and their initial
state of charge _bn_ 0( _e_ ). To maintain tractability as battery levels evolve, we group the _N_

agents into _J_ **state-dependent representative types** corresponding to the static bins.
The representative for bin _j_ in epoch _e_ is defined as the tuple ( _θ_ [¯] _j,_ [¯] _bj_ ( _e_ )), where _θ_ [¯] _j_ is the
midpoint (centroid) of cell _Rc,j_ and [¯] _bj_ ( _e_ ) is the current average state of charge of all agents

belonging to that bin.


**Dimensionality Reduction of the Action Space.** The feasible action set _A_ _[L]_ _j_ [(] _[b][j]_ [0][) is]
depends on the agent’s initial state of charge. Therefore, to ensure the BNE approximation

remains accurate as the population state distribution _νe_ evolves, the strategy banks that

form the mixed-strategy support are **recomputed in every epoch** _e_ .

For each state-dependent representative type ( _θj, bj_ ( _e_ )), we generate a new strategy bank
for a lookahead window of _L_ epochs: _Bj_ _[L]_ [(] _[e]_ [) =] _[ {]_ **[a]** _jk_ [1:] _[L][}]_ _Kk_ =1 _j_ _[⊂]_ [ext(] _[A]_ _j_ _[L]_ [(] _[b][j]_ [(] _[e]_ [))). We take the]
support of the equilibrium mixed strategy _σj_ ( _e_ ) to be a the strategy bank _Bj_ _[L]_ [(] _[e]_ [) populated]
by solving the _L_ -epoch best-response LP using Algorithm 1 (with parameters _θj_ and _bj_ ( _e_ ))

under a large number of diverse price profiles. The resulting equilibrium strategy for type _j_
is a distribution over this bank, _σj_ _[⋆]_ [(] _[e]_ [)] _[ ∈]_ _[∆][K][j]_ [, and the support for the overall mixed strategy]
profile _**σ**_ ( _e_ ) is the Cartesian product of these dynamic banks, _B_ _[L]_ ( _e_ ) = _×_ _[J]_ _j_ =1 _[B]_ _j_ _[L]_ [(] _[e]_ [).]


**Planner Problem for Ex-Ante Welfare Maximization.** With the strategy banks _Bj_ _[L]_
populated, we can now determine how agents should mix among these candidate plans. We
accomplish this by solving for the equilibrium strategy profile _**σ**_ _[⋆]_ that maximizes the **ex-ante**

**expected community welfare** .

To handle the non-differentiable absolute value in the welfare function (Equation 31), we
introduce auxiliary variables for the aggregate export **X** [+] _∈_ R _[TL]_ and import **X** _[−]_ _∈_ R _[TL]_ .

The problem of the Equilibrium Solver can thus be defined as maximizing the linear welfare
term with an optional Tikhonov regularization term: [13]


**Definition 4** (Equilibrium Solver) **.** _The Equilibrium Solver is given by the following_

_Quadratic Programming problem:_



max
_**σ**_ _,_ **X** [+] _,_ **X** _[−]_



_L_

- ~~(~~ _l_ ) _⊤_ _−_ ( _l_ ) [�]

_γ_ _[l][−]_ [1][ �] _**λ**_ [(] _[l]_ [)] _[⊤]_ **X** [+(] _[l]_ [)] _−_ _**λ**_ **X** _−_ _η∥Diff_ **X** [¯] ( _**σ**_ ) _∥_ [2] 2 (35)
_l_ =1



13The regularization term increases the smoothness of the resulting equilibrium aggregate profiles.


37


_subject to:_



**X** ¯ ( _**σ**_ ) =



_J_

- _ωj_ - _Sjσj −_ _Djσj_ - _._ (36)

_j_ =1



**X** ¯ ( _**σ**_ ) _−_ **X** [+] + **X** _[−]_ = 0 _(Net trade decomposition)_


**X** [+] _≥_ 0 _,_ **X** _[−]_ _≥_ 0 _(Non-negativity)_


**1** _[⊤]_ _σj_ = 1 _∀j_ _(Probability simplex)_


_σj ≥_ 0 _∀j_ _(Non-negativity)_


In the objective function of the Solver, _η ≥_ 0 is a scalar and Diff _∈_ R [(] _[TL][−]_ [1)] _[×][TL]_ is the temporal
difference matrix. [14] The choice variable for type _j_ is the probability vector _σj ∈_ R _[K][j]_ . The

constraints enforce consistency between the net trade and the auxiliary variables and restrict
the vector _**σ**_ = ( _σ_ 1 _, . . ., σJ_ ) _∈_ R� _Kj_ so that probabilities are correctly defined over the
relevant simplices ( [�] _[K]_ _k_ =1 _[j]_ _[σ][j,k]_ [ = 1).]
The connection between the decision variables _**σ**_ and the action aggregates is given by
the aggregate netput vector **X** [¯] ( _**σ**_ ) _∈_ R _[TL]_ . We will now see how to compute it: Let _Kj_ be the
number of strategies in the bank _Bj_ _[L]_ [for representative type] _[ j]_ [. Each plan] _[ k][ ∈{]_ [1] _[, . . ., K][j][}]_ [ in]
the bank induces specific supply and demand trajectories, denoted **s** _j,k ∈_ R _[TL]_ and **d** _j,k ∈_ R _[TL]_ .
We construct the supply matrix _Sj ∈_ R _[TL][×][K][j]_ and the demand matrix _Dj ∈_ R _[TL][×][K][j]_ by

stacking these trajectories as columns:















_|_ _|_

**d** _j,_ 1 _. . ._ **d** _j,Kj_
_|_ _|_






 _,_ _Dj_ =






 _._



_Sj_ =







_|_ _|_

**s** _j,_ 1 _. . ._ **s** _j,Kj_
_|_ _|_



The resulting aggregate netput in Eq. (36) is thus the sum of these expected power (net)

injections weighted by _ωj_ = P( _θ ∈_ bin _j|ze_ ) across all _J_ bins.


**Decentralization and Feasibility Projection.** Finally, to implement the equilibrium,
we decentralize the aggregate solution _**σ**_ _[⋆]_ via Monte-Carlo assignment.

Specifically, each agent _n_ (belonging to bin _j_ ) independently samples a candidate plan
**a** _n ∼_ Cat( _σj_ _[⋆]_ [) from the bank.] Then, since the agent’s realized state ( _θn, bn_ 0) generally
deviates from the bin archetype, we enforce feasibility by mapping the candidate to the

closest feasible action via Euclidean projection: **a** _n_ = Prj( **a** _n_ ; _θn, bn_ 0). This step restores
                 feasibility while preserving approximate incentive compatibility.


14Diff has entries Diff _t,t_ = _−_ 1 and Diff _t,t_ +1 = 1.


38


The procedure concludes by executing the first epoch of **a** _n_, determining the initial state
                             distribution _νe_ +1 for the subsequent loop.


**Algorithm 2** Rolling-Horizon Equilibrium Solver


**Require:** Mixed Histogram _H_, Grid prices _**λ**_ _,_ _**λ**_, Lookahead window _L_, Epoch-length _T_, Total
epochs _H_ .
**Ensure:** Equilibrium strategies _**σ**_ _[⋆]_ ( _e_ ), realized plans _{_ **a** _n_ ( _e_ ) _}_, state paths _{bn_ 0( _e_ ) _}_ .

                      
1: **Init:** Sample _θn ∼_ _H_ ; Init states _bn_ 0(1); Define bin centroids _{θ_ [¯] _j}_ _[J]_ _j_ =1 [.]
2: **for** _e_ = 1 **to** _H_ **do** _▷_ Rolling Horizon
3: **(i) Population Clustering**
4: **for** _j_ = 1 **to** _J_ **do**
5: Compute weight _ωj ←|Nj|/N_ and rep. state [¯] _bj_ ( _e_ ) _←_ mean( _bn_ 0) for _n ∈_ Bin _j_ .
6: **end for**
7: **(ii) Strategy Bank Generation** _▷_ Parallelizable
8: **for** _j_ = 1 **to** _J_ **do**
9: _Bj_ _[L]_ [(] _[e]_ [)] _[ ←∅]_ [; Parameters] _[ χ][j][ ←]_ [(¯] _[θ][j][,]_ [¯] _[b][j]_ [(] _[e]_ [)).]
10: **for** _k_ = 1 **to** _K_ samples **do**
11: Generate prices ˆ **r** _k,_ ˆ **c** _k_ . Solve LP: **a** _j,k ←_ arg max _π_ ( _·_ ; _χj,_ ˆ **r** _k,_ ˆ **c** _k_ ).
12: _Bj_ _[L]_ [(] _[e]_ [)] _[ ←]_ _[B]_ _j_ _[L]_ [(] _[e]_ [)] _[ ∪{]_ **[a]** _[j,k][}]_ [ (retain extreme points).]
13: **end for**
14: **end for**
15: **(iii) Planner Optimization**
16: Construct supply/demand matrices _Sj, Dj_ from banks _Bj_ _[L]_ [(] _[e]_ [).]
17: Solve QP (35) for mixing weights:
18: _**σ**_ _[⋆]_ ( _e_ ) _←_ arg max _**σ**_ [ _W_ Ex-Ante( _**σ**_ ) _−_ _η∥_ Diff **X** [¯] ( _**σ**_ ) _∥_ [2] 2 []]
19: Extract distributions _σj_ _[⋆]_ [(] _[e]_ [) from] _**[ σ]**_ _[⋆]_ [(] _[e]_ [).]
20: **(iv) Decentralization & State Update** _▷_ Parallelizable
21: **for** _n_ = 1 **to** _N_ **do**
22: Identify bin _j_ . Sample **a** _n ∼_ Cat( _σj_ _[⋆]_ [(] _[e]_ [)).]
23: **Project:** - **a** _n ←_ arg min **a** _∈ALn_ _[∥]_ **[a]** _[ −]_ **[a]** _[n][∥]_ [2][.]

24: Implement first epoch � **a** _n_ [(1)][. Update state:] _[ b]_ _n_ 0 [(] _[e]_ [ + 1)] _[ ←]_ [�] _[b]_ _nT_ [.]
25: **end for**
26: **end for**
27: **return** _{_ **a** _n_ ( _e_ ) _, bn_ 0( _e_ ) _}n,e_ and _{_ _**σ**_ _[⋆]_ ( _e_ ) _}e_ .

     
#### **5.5 Theoretical Guarantees for the Equilibrium Solver**


The careful reader will have noticed that the Solver in Eq. (35) maximizes the _welfare at the_

_average_ trade—evaluating welfare as if the entire community were composed of _N_ identical

“average” agents, each executing the same action—whereas the true objective (Eq. 31) is to

maximize the _expected total welfare_ of the community. This is a crucial simplification since

it allows us to optimize a deterministic proxy rather than integrating over the intractable

_N_ -dimensional joint distribution of types _F_ ( _**θ**_ _|ze_ ), which would be required to compute the

exact expectation of the piecewise-linear welfare function. We now explain why this approach

is valid.


39


First, thanks to the Homogeneity Axiom (Axiom 8), the welfare function **scales linearly**

**in aggregate netput** (i.e., it is 1-homogeneous). This allows us to relate total welfare and

welfare at the average trade: Let **X** _N_ be the total realized net trade and ¯ **x** _N_ = **X** _N_ _/N_ be

the _realized average_ net trade per agent. The total welfare is exactly _N_ times the welfare of

the average:

_W_ total( **X** _N_ ) = _N · W_ avg(¯ **x** _N_ ) _,_


where _W_ avg( _·_ ) is simply the standard welfare function defined in Eq. (32) applied to unit
normalized quantities. Because _N_ is a positive constant, maximizing the expected total

welfare is equivalent to maximizing the expected average welfare:


max _**σ**_ E _**θ**_ _|ze_     - _W_ total( **X** _N_ ( _**σ**_ ))� _⇐⇒_ max _**σ**_ E _**θ**_ _|ze_     - _W_ avg(¯ **x** _N_ ( _**σ**_ ))� _._


Nevertheless we did not eliminate yet the integration problem. Since _W_ avg is concave and
the realized average ¯ **x** _N_ is a random variable, and by Jensen’s Inequality, E[ _W_ avg(¯ **x** _N_ )] _≤_
_W_ avg(E[¯ **x** _N_ ]). The solver optimizes the right-hand side (the certainty-equivalent welfare of

the expectation), which overestimates the welfare function.

However, this “Jensen gap” is driven by the variance of the realized average, Var(¯ **x** _N | ze_ ).
As the population size _N →∞_, the Strong Law of Large Numbers (SLLN) ensures that the
realized average ¯ **x** _N_ converges almost surely to the sample mean **X** [¯] . Consequently, the

variance vanishes, and by continuity and boundedness of the welfare function, the welfare of

the stochastic average converges to the welfare of the deterministic mean field approximation.


**Proposition 7** (Convergence to the Mean-Field Welfare Limit) **.** _Let Wavg be the continuous_
_welfare function and let individual actions_ **y** _n be conditionally i.i.d. and bounded given ze._
_Let_ ¯ **x** _N_ = _N_ [1] - _Nn_ =1 **[y]** _[n]_ _[be the realized average and]_ [ ¯] **[X]** [ =][ E][[] **[y]** _[n]_ _[|][ z][e]_ []] _[ be the theoretical mean field.]_

_Then, the true expected welfare converges to the welfare of the mean field:_


lim               - = _Wavg_ ( ¯ **X** ) _._
_N_ _→∞_ [E][ �] _[W][avg]_ [(¯] **[x]** _[N]_ [)] _[ |][ z][e]_


**Approximation Error and** _ϵ_ **-Incentive Compatibility.** Finally, we note that quan
tizing the continuous type space into _J_ discrete bins and ensuring feasibility by projection
**a** - _n_ = Prj( **a** ; _θn_ ) can result in a strictly positive _regret_ relative to the true optimal strategy:


Regret _n_ = max **a** _∈A_ ( _θn_ ) _[π][n]_ [(] **[a]** [)] _[ −]_ [E] **[a]** [�] _[n][∼][σ]_ _j_ _[⋆][,]_ [Prj]           - _πn_ ( **a**           - _n_ )�


However, as the prosumer’s individual optimization problem (Eq. 25) is a linear program,

their optimal value functions and the feasible set boundaries are Lipschitz continuous with


40


respect to the elements of _θ_ (e.g., battery capacity, grid limits). Consequently, the regret is

bounded by the distance between the agent’s true type and the bin centroid.

As the histogram mesh becomes finer, this error vanishes linearly, ensuring that the
mechanism is asymptotically Incentive Compatible. [15]


**Proposition 8** (Vanishing Regret) **.** _Let δ_ = max _j_ diam( _Rj_ ) _be the maximum diameter of the_
_type bins. Under the assumption that the feasible set correspondence θ_ ⇒ _A_ ( _θ_ ) _is Lipschitz_

_continuous, the expected regret for any agent n is bounded linearly by the quantization error:_


_Regretn ≤_ _κ · δ_


_where κ is a problem-dependent Lipschitz constant. Thus, as the population approximation_

_becomes exact (δ →_ 0 _), the regret vanishes and the equilibrium becomes exact._

### **6 Quantitative Experiments**


Our goal in this section is to build simulations to quantify gains with our approach. We

explore two scales with this model, both advantages in the prosumer and in the community

level.

#### **6.1 Data description and source**


Two datasets are used and explored in this quantitative simulations. The first dataset con
tains historical weather information from Paris during the year of 2023. Paris was chosen

as the base of our simulation due to its economical importance and the access to informa
tion such as energy consumption, demographic, solar irradiance and eolic power potential

Hakkarainen et al. (2015). The contrast between different regions in France for energy poten
tial is shown in Figure 7a Solargris (2025), indicating differences in solar energy production

potential in relevant regions, while Figure 7b shows the average wind speed at 100 meters

which is the basis for eolic energy.

Historical data is taken for open-meteo weather Open-Meteo (Free Weather API) (2023),

containing information which impacts energy production, such as solar irradiance, cloud

cover percentage, and wind speed. These values are measured and recorded hourly. Irradiance is measured as the total radiation received in the preceding hour per meter squared, _[W]_

_m_ [2] [,]
taking into consideration Earth’s tilt for the non-normal incidence. Cloud cover is defined


15Notice that the regret bound is stronger than payoff continuity as the latter only implies
_|_ max _σ_ E[ _π_ ( _σ_ ; _θn_ )] _−_ max _σ_ E[ _π_ ( _σ_ ; _θ_ [¯] _j_ )] _| ≤_ _κδ_ while the regret bound ensures the specific mixed strategy _σj_ _[⋆]_
(optimized for _θ_ [¯] _j_ ) yields an expected payoff close to the true optimum when played by type _θn_ .


41


(a) Average solar irradiation. (b) Average wind Speed at 100 meter.


Figure 7: Weather characteristics for solar and eolic energy production in metropolitan
France.


as the fraction of the sky that is covered in clouds, affecting the performance and efficiency
of solar panels. Wind speed is measured in _km · h_ _[−]_ [1] at an altitude of 100 meters from the

ground.

Energy consumption is taken from France’s Transmission System Operator (RTE) RTE

(France’s Transmission System Operator) (2023) from 2023, the same time period as the

weather data, matching consumption and energy production, however consumption data is

recorded every 15 minutes while weather data is hourly. Household demand is computed as

the total consumption in the city scaled by the number of buildings in a community, the

average amount of people per building and the city population. Consumption information is

scaled down based on a population of around 12 million inhabitants in Paris, obtained from

the french population census.

Both datasets where broken down in 15 minutes steps, totaling 96 steps in each epoch or

each day. As weather data is hourly recorded, cleaning, processing and inferring values in

each timestep steps depends on the specific variable being analyzed. For solar energy, four

main features are taken into account: consumption, irradiance, cloud cover, and wind speed.

For consumption, irradiance and wind speed, non measured data or errors in measurement

(NaN or zeros) are approximated as the mean between the following and the previous values.

If this assumption is not possible, considering errors in whole the daily measure, they are

approximated using previous day measurements. Values are broken down equally for each

step, maintaining the same total hourly consumption. Filling data for and for wind speed


42


Figure 8: Community household energy profiles for demand and solar supply for prosumers
in Paris during a summer week (07/10/2023 to 07/16/2023) on the left side, and a winter
week (01/06/2023 to 01/12/2023) on the right side. Red lines indicate community demand,
while blue and black lines represent solar and Eolic energy supply respectively.


is the same as for the other features, prioritizing the mean between previous and following

values. On the other hand, breaking down values for time steps is done by maintaining the

same value as previously measured, so all values in one hour are the constant.



Solar energy production is computed using irradiance ( _G_ ), cloud cover ( _C_ ), and an aver
age efficiency ( _e_ ) for solar panel. Efficiency is set to 15% and a solar panel is considered to
have 1.6 _m_ [2], the energy production per panel ( _Es_ ) is computed as _Es_ = _G · C · e_ . For eolic
energy, its production is estimated as _Ee_ = 0 _._ 5 _· Cp · ρ · π · R_ [2] _· V_ [3] for a wind turbine, where
_cp_ is performance coefficient set to 0 _._ 4, _ρ_ is air density as 1 _._ 293 _[kg]_ [3] [,] _[ R]_ [ is the blade (rotor)]



_cp_ is performance coefficient set to 0 _._ 4, _ρ_ is air density as 1 _._ 293 _m_ [3] [,] _[ R]_ [ is the blade (rotor)]

length approximated to 1 _._ 9 meters, and _V_ the wind speed in _[m]_ [. To compute the demand]



length approximated to 1 _._ 9 meters, and _V_ the wind speed in

_s_ [. To compute the demand]
and the supply in Paris, its population was fixed in 12 million and 32 thousand solar panels

and wind turbines, the later was estimated based on the amount of private owned buildings

in Paris. These values where scaled down for a representative community of 1,000 buildings

with an average of 5 people per building.



Communities demand and energy production are computed using the scaling factor pre
viously described, accounting for a subset of the population with solar and eolic energy

production and consumption. A sample of the results are displayed in Figure 8, showing

a summer week on the left side and a winter week on the right side. In both cases the

dependence and volatility in energy production based on local weather is visible, being a

byproduct of factors such as hour of the day and time of the year.

Supply and demand fluctuate depending on the season, daily supply over demand is

displayed in Figure 9 showing Paris information and how it changes during the day and the

seasons. Each line corresponds to a two weeks moving average accounting for one week prior

and one week posterior to the specific day. A dashed line is displayed highlighting when


43


Figure 9: Yearly supply over demand for Paris. Each line represents the average over two
weeks and their colors indicate the season. A dashed line represents the equality between
supply and demand.


supply equals demand. During summer and spring, supply overcomes demand, mostly on

the solar energy production hours.

These pieces of information are used to simulate gains in the prosumer level using our

AMM approach, clarifying advantages and benefits with a real data example.

#### **6.2 Prosumer-Level Gains from Decentralization**


In this part, we explore monetary gains due to the implementation of AMM using solar

panels and wind turbines for energy production with batteries for energy storage, aiming in

analyzing profit differences a prosumer can achieve with and without AMM usage. Improving

prosumer gains and energy allocation based on pricing functions help the promotion of

decentralized clean energy production not only in an environmental point but also in a

monetary side, decreasing the break even time for equipment investments and increasing

their acquisition incentives.


Simulations are made using France energy price as a base with the distinction between
peak hour price _λ_ [¯] (moments which overall consumption are higher), off-peak hour price _λ_

(when consumption is lower) and resale price for prosumer production to the grid. Peak

hours are set from 8 am to 12 am and from 1 pm to 8 pm. Energy storage is done with a

20 kW battery, with a maximum charge/discharge power of 5 kW and a maximum energy

transaction with the grid of 5 kW each 15 minutes timestep. Demand is broken down into

two categories and their percentages are based on Enedis information Enedis (2024) about


44


Figure 10: Base and Flexible Consumption profile for 2023. On the left side is the daily base
load and its quantiles for the population distribution. On the right side the yearly yearly
flexible load for the hole population. Flexible load represents a percentage of the base load.


household items utilization and consumption optimization literature in France Agnetis et al.

(2013); De Lauretis et al. (2017), setting a base load equivalent to 70% of daily consumption

and 30% as flexible load.


Rolling-horizon simulation is performed over 360 days, with 15 minutes time steps and a
fixed look ahead window of 4 days. For energy prices, _λ_ [¯] is settled to 21.46 c€ per kWh, _λ_ to

16.96 c€ per kWh, and resale price is set to 8.86 c€ per kWh. The main pieces of information

are recorded during simulation, namely as battery information such as charge/discharge and

trade profile, monetary transactions are also monitored during simulation. Two distinct pro
files are used for simulations, the consumer and the prosumer, where the prosumer produces

and offers energy supply, solar or wind, besides only demanding it. Solar and eolic energy

production and quantities follow the same conditions as before. Consumption is broken

down into a daily base load and a flexible amount, the later can be allocated during different

moments of the day. Daily base load and yearly flexible loads are shown in Figure 10, where

the hourly base load distribution is displayed in the left side, and the right side indicates

daily flexible.


Household appliances scheduling, known as demand-side management (DSM), is a strat
egy for allocating flexible energy consumption based on energy price and usage plausibility

Agnetis et al. (2013); Warren (2014); Strbac (2008); Arteconi et al. (2012). In our framework,

optimized consumption is dynamically allocated and Figure 11 shows a two weeks moving

average for dynamic allocation results, so each line represents the average allocation account
ing for one week prior and one week posterior the the analyzed day, their color represents

the day of the year. Allocation depends on weather, energy production and price, indicating


45


Figure 11: Optimized consumption taking into account flexible load allocation. Each line
represents the two weeks average value, with one week prior and one week posterior to the
analyzed curve. Colors represent the day of the year and its season.


Figure 12: Daily battery profile throughout the year. Battery charge and discharge profile
on the left graph, state of charge on the right graph. Curves represent a two weeks average
value and their colors the season of the year.


a seasonal dependency and an hourly dependency, where a more predominant part of the

allocation is performed during sunny hours for summer while more prominent consumption

is donne during off peak hours for winter months.

Besides consumption allocation, battery usage is a key factor for P2P energy trading

and financial gains. Figure 12 shows a two weeks average battery charge/discharge profile

on the left side and SoC on the right side based on the hour of the day and the season of

the year. In both cases seasonal characteristics are identifiable, but SoC reflects a greater

sensibility with more distinguishable curves for summer and winter, where the shape of the

curves differs mostly based on the season.

Trades in the community, described in equation 26, are dictated by the prosumer’s internal value perception _θnt_ _[∗]_ [(the multiplier on the resource constraint for Eq. 25). The net grid]
trade profile and the internal price are shown in Figure 13, where the trading profiles are

displayed on the left side and the Lagrange Multiplier on the right side for the whole year


46


Figure 13: Daily grid trade profiles and Lagrange multiplier regimes during 2023. Net grid
trade is shown on the left side and the Lagrange multiplier on the right side. Colors represent
the time of the year for both images, shapes represent the trading regime (Buy, Sell, noTrade).


Figure 14: Cumulative gain using linear pricing function with and without AMM usage. Red
line represents the cumulative profit without AMM, the green line represents the cumulative
profit with AMM, and the black line the percentage gain considering both scenarios.


simulation.

Using the linear pricing function, cumulative profits are shown in Figure 14, indicating

the cumulative gain for the prosumer using both approaches, with and without AMM, on the

right axis and on the left axis the percentage indicating the difference between both models

over the minimal cumulative profit. These results highlight not only an absolute monetary

gain, but it also reflects a decrease in the break even time for solar panels and wind turbines

investments. Compared with the benchmark approach, AMM provides a monetary gain

around 60% with respect to the simulation without AMM.


47


Figure 15: Simulated curves for consumption and energy production during summer. Upper
side shows daily energy consumption, lower left side eolic energy supply and lower right side
solar supply. Colors represent their respective depth values with respect to the ensemble.

#### **6.3 Grid-Level Gains from Decentralization**


Following prosumer level gains, we aim in this part to model grid-level gains from decen
tralization in a community. We implement a simulation framework to model and analyze

the behavior of diverse energy agents interacting within a local energy market, facilitated

by an Automated Market Maker. For these simulations, three different profiles of agents are

used: a pure consumer, a solar prosumer, and a wind prosumer. All agents possess batteries,

as well as a base load and a flexible load, which are all randomly chosen. Solar and wind

prosumers supply solar and eolic energy respectively besides their energy consumption. For

each profile, synthetic daily curves for energy supply and consumption are independently

generated based on real data used on previous studies for Paris. Curves are generated for

each of the four seasons of the year, yet we focus her on summer during our simulations,

creating a set of distinct profiles describing a behavioral distribution. Used data is shown

in Figure 15, where the synthetic consumption is places in the upper part, eolic supply is

displayed in the lower left part, and solar supply in the lower right panel. To select the data

from a distribution we use the functional concept of data-depth, and the color of each curve

represents their depth value, determining the centrality and likelihood of a behavior Gijbels

and Nagy (2017); Mozharovskyi et al. (2020). Depth is calculated using projection depth

( _DP_ ) following new developments for its computational aspects Zuo and Serfling (2000); Zuo

(2003); Zuo and Lai (2011); Mosler and Mozharovskyi (2022); Leone et al. (2025) for function

data Gijbels and Nagy (2017), where the (projection) depth of a curve _Xi_ with respect to
all _n_ curves _X_ = ( _X_ 1 _, . . ., Xn_ ) is written as _DP_ ( _Xi|X_ ).

Depth values are used to create a way to select one out of all synthetic curves from a

uniform distribution, following ideas described in Mozharovskyi et al. (2020), such selection

is donne using the inverse mapping between the cumulative distribution of the depth values


48


_FDP_ ( _Xi|X_ ) and a uniform distributed random variable _U ∼_ _U_ [0 _,_ 1]. Depth distribution is shown
in Figure 16, on the left side the histogram for each synthetic dataset and on the right the

cumulative distribution. Depth values are normalize between [0 _,_ 1] keeping the underlying

distribution the same. As we aim to use a mixed strategy framework, the number of bins are

computed using the Freedman-Diaconis rule Diaconis and Freedman (1980), where number
of bins _N_ is selected for each distribution using _N_ = _[max]_ [(] _[D]_ [(] _[·|][X]_ [))] _[−][min]_ [(] _[D]_ [(] _[·|][X]_ [))], where _D_ ( _· | X_ )

2 _×IQR×n_ [1] _[/]_ [3]
represents all depth values, _IQR_ is the interquartile range, and _n_ is the number of points in

the distribution.


Figure 16: Data-depth distribution histogram and cumulative values for representative synthetic data for Paris. Each color represents a synthetic dataset depth value distribution.
Depth values are normalized to stretch between 0 and 1.


Simulations are performed with a total of 1,000 agents, where 30% are solar prosumers,

30% wind prosumers, and 40% are consumers, all of them with a two look-ahead days. Initial

battery levels and total battery capacity are randomly chosen for each agent. Flexible load

is formulated from base load and a random noise component, differentiating possible agents

with same consumption curves. For the mixed strategy, the profile representing the center of

each bin is chosen to be the profile whose depth value is the closest to the center depth, we

also distinguish behaviors above and bellow the median curve for the representative behavior.

Simulation is performed for two days. Consumption and production profiles for solar and

wind energy are in Figure 17, where full lines represent the mean profile, light blue regions

represent the interquartile region from 5% to 95%, in dark blue the 25% to 75% region and

the scattered dots the individual profiles. Scattered points are the individual profiles used

in the simulation, indicating aspects about the distribution of behaviors and the individual

profiles of agents.

During these simulations the profit of each individual agent is recorded and compared


49


Figure 17: Profile distribution for base supply and demand during first two simulated summer
days. On the left is the base load consumption accounting all agents, in the middle the solar
production, and the right eolic energy production. Continuous black line is the median of
the distribution, blue regions represent quantiles from 5% to 95% in light blue and 25% to
75% in dark blue, and scattered dots are the individual profiles.


with the benchmark profit using fixed prices with no dynamic approach. Both profit profiles

and distributions are shown in the left part of Figure 18, where green bars indicate the profits

with AMM and red ones the benchmark distribution. The total gains for the community is

displayed on the right side of Figure 18 accounting for all agent profiles, indicating a 42%

gain with respect to the benchmark when using our dynamic equilibrium approach.


Figure 18: Distribution of profits and gains from trading comparing approaches with and
without AMM. On the left side the distribution of profit for individual agents, on the right
the total gain from trades comparing both approaches.


To further explore these results we can analyze the trading prices during the day in

Figure 19, where buying and selling prices for AMM and for the benchmark are indicated

in full lines and dashed lines, respectively. Buy and sell prices are subject to changes due to

different aspects like energy supply, demand, and grid prices. Overall selling prices follow the

benchmark trend for sell prices, where agent effort to match supply and demand is reflected


50


Figure 19: Simulated AMM price bands for all epochs. Full red lines represent the median
buying price and red regions the 10% to 90% interquartile values, green lines represent the
median selling price and green regions the 10% to 90% interquartile values. Dotted and
dashed lines are the sell and buy benchmark prices for the grid, following the right axis.


on price changes.

These price differences, mainly the benchmark one, interfere in the flexible load con
sumption allocation, as indicated in Figure 20. Dynamic allocation favors assigning more

consumptions in low price regions. Dynamic pricing seems to cause a lower impact in the

placing of the flexible consumption, being mostly dictated by the (fixed) grid price, once it

also impact and dictates community buy and sell prices.


Figure 20: Aggregated community consumption. Peach color bars represent the base load
consumption, green bars the flexible load and the full green line the total consumption considering both pieces. Benchmark grid prices are indicated by the dashed gray line following
the right axis.


We can see the impact of the grid interaction with the community in Figure 21, where

green bars represent the community selling energy to the grid and red bars energy purchase

by the community. The blue line represents the net interaction between both agents, grid

and prosumers, which is overall the community buying from the grid to match supply and


51


demand. This net interaction is also impacted mostly by the grid price change, where agents

are more prone to buy from the grid once it is cheaper, influencing other aspects like demand

allocation and battery charge.


Figure 21: Aggregated grid interaction between grid and prosumers. Green bars represent
the aggregated energy sold to the grid and red bars the aggregated energy bought for the
community. Blue line indicate the net interaction between grid and community.


Battery dispatch follows a different trend than demand allocation and net interaction.

While both parameters are more sensible to the grid price, battery dispatch, in Figure 22, is

more sensible to the internal community energy supply, where charging occurs mostly during

solar hours and discharging when production is lower. Even thought another aspect impacts

the charging and discharging profiles, grid price decreases affect the charging characteristic.

In the image, blue bars represent moments where battery is being charged, while peach

bars when battery is being discharged, and the purple line is the outline of the aggregated

dispatch profile.

To deepen the visualization of the results of the mixed strategy, aggregated results for each

type of agent are analyzed. First, Figure 23 show the aggregated battery charge/discharge

for solar prosumers and wind prosumers on the left and right image respectively. These

results reflect the sensibility of each prosumer type regarding weather conditions, where

battery charging for solar prosumers is concentrated during sunny hours, and discharging

otherwise, while wind prosumers do not have such constrains and can charge regardless.

Scattered dots indicate individual behaviors during the simulation and the colored regions

are the interquartile ranges, indicting these distinctions in the mixed strategy.

Second, net trading profiles, in Figure 24, illustrate the differences between pure con
sumers on the left graph, solar prosumers on the center, and wind prosumers on the right.

Some similar hourly trends seen in the battery state are present for the trading profile, where

solar prosumers have their trades concentrated during sun hours and wind prosumers have


52


Figure 22: Aggregated battery dispatch profile. Blue bars indicate battery charging and
peach bars battery discharge. Purple line represents the net dispatch profile of the community.


Figure 23: Aggregated battery state for distinct prosumer profiles. Left image is the battery
state for solar prosumers, and the right image the battery state for wind prosumers. For all
images, black line represents the median value, light blue regions represent the 5% to 95%
interquartile range, dark blue regions represent the 25% to 75% interquartile range.


more disperse profiles during the day. Pure consumer agents present a more grid price sen
sible profile, where most of the trades occur during off-peak hours, both during night time

and at noon. Even thought off-peak prices play a role in the net trading of energy supplying

prosumers, its importance is greater for pure consumers, not being as robust as suppliers.


53


Figure 24: Aggregated net trading profiles for distinct agent types. Left image represents
consumer net trade, middle image is the net trade for solar prosumers, and the right image
net trade for wind prosumers. For all images, black line represents the median value, light
blue regions represent the 5% to 95% interquartile range, dark blue regions represent the
25% to 75% interquartile range.

### **7 Conclusion**


In this paper, we have provided a decentralized market clearing mechanism for local power

grids based on the design principles of Automated Market Makers in decentralized finance.

We started posing axioms that guarantee an ideal functioning of the market. We then showed

that our axioms are satisfied by an AMM based on batch execution, proportional payments,

and concentrated liquidity. The market so designed implements a potential game, enabling

an exact welfare equivalence between decentralized equilibrium and the solution of a social

planner’s problem. Numerical experiments based on data from the Paris metropolitan region

illustrate substantial gains from trade relative to grid-only benchmarks.

Several promising research directions extend naturally from our analysis. First, one may

endow the AMM with its own inventory: a community battery. This introduces the AMM’s

battery level as a new state variable. The pricing functions can be defined as using the

state of the battery rather than the energy supplied in a given time slot. Besides exporting

on importing energy, the community will have to decide on how much energy to charge or

discharge. Second, the aggregation and routing of _multiple interacting microgrids_ through a

hierarchy of AMMs opens the door to scalable regional coordination. The freamework can

later be extended to perform systemic risk analysis and compare shock propagation between

a centralized energy infrastructure and a decentralized one made of interconnected local grids

operating through AMMs.

Finally, while our potential-game characterization holds for any axiom-compliant curve

assuming linear prosumer payoffs, one can define a Planner with distributional objectives

and go beyond the linear model. This opens the question of how to design trading functions


54


or dynamic prices that encode such distributional preferences. Understanding how to extend

the our results in this direction—while retaining tractability—is an important direction for

future work.

### **References**


Agnetis, A., De Pascale, G., Detti, P., and Vicino, A. (2013). Load scheduling for household

energy consumption optimization. _IEEE Transactions on Smart Grid_, 4(4):2364–2373.


Alfaverh, F., Denai, M., and Sun, Y. (2023). A dynamic peer-to-peer electricity market

model for a community microgrid with price-based demand response. _IEEE Transactions_

_on Smart Grid_, 14(5):3976–3991.


Angeris, G., Agrawal, A., Evans, A., Chitra, T., and Boyd, S. (2022). Constant function

market makers: Multi-asset trades via convex optimization. In Tran, D. A., Thai, M. T.,

and Krishnamachari, B., editors, _Handbook on Blockchain_, pages 415–444. Springer, Cham.


Angeris, G. and Chitra, T. (2020). Improved price oracles: Constant function market makers.

In _Proceedings of the 2nd ACM Conference on Advances in Financial Technologies (AFT_

_’20)_, pages 80–91, New York, NY, USA. ACM.


Angeris, G., Evans, D., and Chitra, T. (2023). The geometry of constant function market

makers. _arXiv preprint_ .


Angeris, G., Kao, A., Chiang, R., Noyes, T., and Chitra, T. (2020). Improved price ora
cles: Constant function market makers. In _Proceedings of the 21st ACM Conference on_

_Economics and Computation_ . ACM.


Arteconi, A., Hewitt, N. J., and Polonara, F. (2012). State of the art of thermal storage for

demand-side management. _Applied energy_, 93:371–389.


Axler, S. (2015). _Linear Algebra Done Right_ . Springer, 3rd edition.


Banach, S. (1922). Sur les op´erations dans les ensembles abstraits et leur application aux

´equations int´egrales. _Fundamenta Mathematicae_, 3(1):133–181.


Blackwell, D. (1965). Discounted dynamic programming. _The Annals of Mathematical Statis-_

_tics_, 36(1):226–235.


55


Boyd, S., Parikh, N., Chu, E., Peleato, B., and Eckstein, J. (2011). Distributed optimization

and statistical learning via the alternating direction method of multipliers. _Foundations_

_and Trends in Machine Learning_, 3(1):1–122.


Canidio, A. and Fritsch, R. (2023). Batching trades on automated market makers. In

_Proceedings of the 5th Conference on Advances in Financial Technologies (AFT 2023)_,

volume 282 of _LIPIcs_, pages 24:1–24:25.


Clarke, E. H. (1971). Multipart pricing of public goods. _Public choice_, 11(1):17–33.


Crowley, B., Kazempour, J., and Mitridati, L. (2025). How can energy communities provide

grid services? a dynamic pricing mechanism with budget balance, individual rationality,

and fair allocation. _Applied Energy_, 382:125154.


De Lauretis, S., Ghersi, F., and Cayla, J.-M. (2017). Energy consumption and activity

patterns: an analysis extended to total time and energy use for french households. _Applied_

_Energy_, 206:634–648.


Diaconis, P. and Freedman, D. (1980). Finite exchangeable sequences. _The Annals of Prob-_

_ability_, pages 745–764.


Doncel, J., Gast, N., and Gaujal, B. (2019). Discrete mean field games: Existence of equilibria

and convergence. _Journal of Dynamics and Games_, 6(3):221–239.


Empresa de Pesquisa Energ´etica (2022). Nota t´ecnica epe/dea/gme/01/2022: An´alise dos

impactos da lei 14.300/2022. _Minist´erio de Minas e Energia_ .


Enedis (2024). Enedis open data. [https://data.enedis.fr/explore/dataset/](https://data.enedis.fr/explore/dataset/conso-inf36-region/information/?sort=-horodate&dataChart=eyJxdWVyaWVz...)

[conso-inf36-region/information. accessed 01.08.2025.](https://data.enedis.fr/explore/dataset/conso-inf36-region/information/?sort=-horodate&dataChart=eyJxdWVyaWVz...)


ENTSO-E (2025). Factual Report on the Grid Incident in Spain and Portugal on 28 April

2025. _European Network of Transmission System Operators for Electricity_ .


Erseghe, T. (2014). Distributed optimal power flow using admm. _IEEE Transactions on_

_Power Systems_, 29(5):2370–2380.


Fabi, M. and Prat, J. (2025). The economics of constant function market makers. _Journal_

_of Corporate Finance_, 91:102737.


Gabriel, S. A., Conejo, A. J., Fuller, J. D., Hobbs, B. F., and Ruiz, C. (2012). _Comple-_

_mentarity Modeling in Energy Markets_ . International Series in Operations Research &

Management Science. Springer, New York, NY.


56


Gautier, A., Jacqmin, J., and Poudou, J.-C. (2018). The prosumers and the grid. _Journal_

_of Regulatory Economics_, 53(1):100–126.


Gautier, A., Jacqmin, J., and Poudou, J.-C. (2024). The economics of prosumers. In

_Encyclopedia of Energy, Natural Resource, and Environmental Economics_ . Elsevier.


Gijbels, I. and Nagy, S. (2017). On a general definition of depth for functional data. _Statistical_

_Science_, 32(4):630–650.


Groves, T. (1973). Incentives in teams. _Econometrica_, 41(4):617–631.


Gu´eant, O., Lasry, J.-M., and Lions, P.-L. (2011). Mean field games and applications. In

_Paris-Princeton Lectures on Mathematical Finance 2010_, volume 2003 of _Lecture Notes in_

_Mathematics_, pages 205–266. Springer, Berlin, Heidelberg.


Guo, X., Hu, A., and Zhang, J. (2024). Mf-omo: An optimization formulation of mean-field

games. _SIAM Journal on Control and Optimization_, 62(1):243–270.


Hakkarainen, T., Tsupari, E., Hakkarainen, E., and Ik¨aheimo, J. (2015). The role and

opportunities for solar energy in finland and europe. _VTT technology_, 217:6–16.


Hasan, E., Galiana, F. D., and Conejo, A. J. (2008). Electricity markets cleared by merit

order—part i: Finding the market outcomes supported by pure strategy nash equilibria.

_IEEE Transactions on Power Systems_, 23(2):361–371.


He, X. D., Yang, C., and Zhou, Y. (2024). Optimal design of automated market makers on

decentralized exchanges.


Hobbs, B. F. (2000). Strategic gaming analysis for electric power systems: An mpec ap
proach. _IEEE Transactions on Power Systems_, 15(2):638–645.


Lasry, J.-M. and Lions, P.-L. (2007). Mean field games. _Japanese Journal of Mathematics_,

2(1):229–260.


Leone, L., Mozharovskyi, P., and Bounie, D. (2025). Massive parallelization of projection
based depths. _arXiv preprint_ .


Mas-Colell, A., Whinston, M. D., and Green, J. R. (1995). _Microeconomic Theory_ . Oxford

University Press.


Milionis, J., Ernstberger, J., Bonneau, J., Kominers, S. D., and Roughgarden, T. (2025).

Incentive-compatible recovery from manipulated signals, with applications to decentralized

physical infrastructure. _arXiv preprint_ .


57


Milionis, J., Moallemi, C. C., and Roughgarden, T. (2024). A myersonian framework for

optimal liquidity provision in automated market makers. In _15th Innovations in Theo-_

_retical Computer Science Conference (ITCS 2024)_, volume 287 of _Leibniz International_

_Proceedings in Informatics (LIPIcs)_, pages 81:1–81:19. Schloss Dagstuhl–Leibniz-Zentrum

f¨ur Informatik. Full version available at `arXiv:2303.00208` .


Monderer, D. and Shapley, L. (1996a). Potential games. _Games and Economic Behavior_,

14(1):124–143.


Monderer, D. and Shapley, L. S. (1996b). Potential games. _Games and economic behavior_,

14(1):124–143.


Moret, F., Baroche, T., Sorin, E., and Pinson, P. (2024). Negotiation algorithms for peer-to
peer electricity markets: Computational properties. _IEEE Transactions on Smart Grid_,

15(4):1257–1269.


Morstyn, T., Teytelboym, A., and Mcculloch, M. D. (2019a). Bilateral contract networks

for peer-to-peer energy trading. _IEEE Transactions on Smart Grid_, 10(2):2026–2035.


Morstyn, T., Teytelboym, A., and McCulloch, M. D. (2019b). Designing decentralized mar
kets for distribution system flexibility. _IEEE Transactions on Power Systems_, 34(3):2128–

2139.


Mosler, K. and Mozharovskyi, P. (2022). Choosing among notions of multivariate depth

statistics. _Statistical Science_, 37(3):348–368.


Mozharovskyi, P., Josse, J., and Husson, F. (2020). Nonparametric imputation by data

depth. _Journal of the American Statistical Association_, 115(529):241–253.


Muntasir, F., Chapagain, A., Maharjan, K., Baig, M. J. A., Jamil, M., and Khan, A. A.

(2023). Developing an appropriate energy trading algorithm and techno-economic analysis

between peer-to-peer within a partly independent microgrid. _Energies_, 16(3):1549.


[Open-Meteo (Free Weather API) (2023). Open-meteo. https://open-meteo.com/en/docs/](https://open-meteo.com/en/docs/historical-weather-api)

[historical-weather-api. accessed 01.08.2025.](https://open-meteo.com/en/docs/historical-weather-api)


Operador Nacional do Sistema El´etrico (2024). Plano da opera¸c˜ao energ´etica 2024-2028:

Avalia¸c˜ao das condi¸c˜oes de atendimento eletroenerg´etico do sistema interligado nacional.

_ONS_ . Analyzes transmission congestion and renewable curtailment (constrained-off) sce
narios, highlighting significant generation cuts in the Northeast region due to export limits.


58


Pinson, P. et al. (2020). Peer-to-peer electricity trading: Market design and operational

principles. _Energy Systems_ .


Prat, E., Lusby, R. M., Morales, J. M., Pineda, S., and Pinson, P. (2024). How long is

long enough? finite-horizon approximation of energy storage scheduling problems. _arXiv_

_preprint_ .


Rosenthal, R. W. (1973). A class of games possessing pure-strategy nash equilibria. _Inter-_

_national Journal of Game Theory_, 2(1):65–67.


RTE (France’s Transmission System Operator) (2023). Rte energy consumption. [https:](https://www.rte-france.com/en/eco2mix/download-indicators)

[//www.rte-france.com/en/eco2mix/download-indicators. accessed 01.08.2025.](https://www.rte-france.com/en/eco2mix/download-indicators)


Schlegel, J. C., Kwa´snicki, M., and Mamageishvili, A. (2023). Axioms for constant function

market makers. In _Proceedings of the 24th ACM Conference on Economics and Compu-_

_tation (EC)_, pages 1079–1109. ACM.


Solargris (2025). Solar resource map. [https://www.geni.org/globalenergy/library/](https://www.geni.org/globalenergy/library/renewable-energy-resources/world/europe/solar-europe/solar-france.shtml)

[renewable-energy-resources/world/europe/solar-europe/solar-france.shtml.](https://www.geni.org/globalenergy/library/renewable-energy-resources/world/europe/solar-europe/solar-france.shtml) accessed

01.08.2025.


Sousa, T., Soares, T., Pinson, P., Moret, F., Baroche, T., and Sorin, E. (2019). Peer-to
peer and community-based markets: A comprehensive review. _Renewable and Sustainable_

_Energy Reviews_, 104:367–378.


Strbac, G. (2008). Demand side management: Benefits and challenges. _Energy policy_,

36(12):4419–4426.


Vickrey, W. (1961). Counterspeculation, auctions, and competitive sealed tenders. _The_

_Journal of finance_, 16(1):8–37.


Warren, P. (2014). A review of demand-side management policy in the uk. _Renewable and_

_Sustainable Energy Reviews_, 29:941–951.


Xiong, X., Qing, G., and Li, H. (2022). Blockchain-based p2p power trading mechanism for

pv prosumer. _Energy Reports_, 8:300–310. ICPE 2021 - The 2nd International Conference

on Power Engineering.


Zuo, Y. (2003). Projection-based depth functions and associated medians. _The Annals of_

_Statistics_, 31(5):1460–1490.


59


Zuo, Y. and Lai, S. (2011). Exact computation of bivariate projection depth and the stahel–

donoho estimator. _Computational Statistics & Data Analysis_, 55(3):1173–1179.


Zuo, Y. and Serfling, R. (2000). General notions of statistical depth function. _Annals of_

_statistics_, pages 461–482.


60


### **A Notation Table**

Table 2: Notation for Prosumer Optimization Model

##### Symbol Description Domain Dim. Unit Type _Indices_ e Epoch index N [+] Scalar – Index t Timestep index within epoch { 1, . . ., T } Scalar – Index ∆ Physical timestep duration R [+] Scalar h Parameter T Number of timesteps per epoch N [+] Scalar – Parameter _Prosumer Parameters_ Bn Battery energy capacity R [+] 0 Scalar kWh Parameter Kn Battery power limit R [+] 0 Scalar kW Parameter Xn Grid connection limit R [+] 0 Scalar kW Parameter ωnt Local generation R [+] 0 T × 1 kW Parameter αnt [base] Baseline consumption R [+] 0 T × 1 kW Parameter αn [flex] Flexible energy requirement R [+] 0 Scalar kWh Parameter _Control Variables_ snt Power sold to market [0, Xn ] T × 1 kW Variable dnt Power bought from market [0, Xn ] T × 1 kW Variable knt Battery power flow (charge > 0) [ −Kn, Kn ] T × 1 kW Variable pnt Total consumption power R [+] 0 T × 1 kW Variable xnt Net power traded ( snt − dnt ) [ −Xn, Xn ] T × 1 kW Derived bnt Battery state of charge (end of t ) [0, Bn ] T × 1 kWh Derived Prices [*] λ t Effective Grid Feed-in Price R [+] 0 T × 1 €/kW Parameter λt Effective Grid Retail Price R [+] 0 T × 1 €/kW Parameter r ¯ t Effective Market Sell Price R [+] 0 T × 1 €/kW Parameter c ¯ t Effective Market Buy Price R [+] 0 T × 1 €/kW Parameter _Objective Function_ Pn ( x t ) Net payment for timestep t R T × 1 € Derived Π n ( · ) Prosumer value function R Scalar € Derived γ Inter-epoch discount factor [0, 1) Scalar – Parameter


 All price parameters in the optimization problem are scaled by the timestep duration ∆(hours).
This allows costs to be computed directly as the dot product of price and power: [€/kW] =

[€/kWh (Raw)] _×_ [h].


61


### **B Prosumer’s Best Response in Matrix Form and La-** **grangian**

Condier the prosumer’s single-epoch optimization problem of maximizing profit
given forecasted prices (¯ **r** _,_ ¯ **c** ). Let the stacked decision vector be **z** _∈_ R [5] _[T]_, where
Ä
**z** _[⊤]_ = **s** _[⊤]_ **d** _[⊤]_ **k** _[⊤]_ **p** _[⊤]_ **b** _[⊤]_ [ä] . The marginal effects of the controls on the objective are


Ä
given by the vector **c** _π ∈_ R [5] _[T]_, **c** _[⊤]_ _π_ [=] ¯ **r** _[⊤]_ _−_ **c** ¯ _[⊤]_ **0** _[⊤]_ **0** _[⊤]_ **0** _[⊤]_ [ä] . The optimization problem in
matrix form is:


max **z** **c** _[⊤]_ _π_ **[z]** [ +] _[ γ]_ [ ¯Π(] _[b][T]_ [)]


s.t. **A** eq **z** = **b** eq


**A** ineq **z** _≤_ **b** ineq


where _bT_ is the last element of the **b** sub-vector within **z** . The constraint matrices **A** eq _∈_
R [(2] _[T]_ [+1)] _[×]_ [5] _[T]_, **A** ineq _∈_ R [10] _[T]_ _[×]_ [5] _[T]_ and vectors **b** eq _∈_ R [2] _[T]_ [+1], **b** ineq _∈_ R [10] _[T]_ are defined as:



ê



ê



**A** eq =



Ü

_−_ **I** **I** _−_ **I** _−_ **I** **0**
**0** _[⊤]_ **0** _[⊤]_ **0** _[⊤]_ **1** _[⊤]_ **0** _[⊤]_


**0** **0** _−_ **L** **0** **I**



**b** eq =



Ü

_−_ _**ω**_
_α_ [flex] + **1** _[⊤]_ _**α**_ [base]


_b_ 0 **1**



**0**

_X_ **1**

**0**

_X_ **1**

_K_ **1**

_K_ **1**

_−_ _**α**_ [base]


**0**

_B_ **1**




_−_ **I** **0** **0** **0** **0**

**I** **0** **0** **0** **0**

**0** _−_ **I** **0** **0** **0**

**0** **I** **0** **0** **0**

**0** **0** _−_ **I** **0** **0**

**0** **0** **I** **0** **0**

**0** **0** **0** _−_ **I** **0**

**0** **0** **0** **0** _−_ **I**

**0** **0** **0** **0** **I**























































**A** ineq =
















































**b** ineq =



**Lagrangian.** Let _**χ**_ _∈_ R [2] _[T]_ [+1] be the Lagrange multipliers for the equality constraints,
partitioned as _**χ**_ = ( _**θ**_ _[⊤]_ _, ν,_ _**λ**_ _[⊤]_ ) _[⊤]_ . Let _**ϕ**_ _∈_ R [9] _[T]_, _**ϕ**_ _≥_ **0** be the multipliers for the inequality
constraints, partitioned as _**ϕ**_ = (( _**ζ**_ _[s]_ ) _[⊤]_ _,_ ( _**ξ**_ _[s]_ ) _[⊤]_ _,_ ( _**ζ**_ _[d]_ ) _[⊤]_ _,_ ( _**ξ**_ _[d]_ ) _[⊤]_ _,_ ( _**κ**_ _[L]_ ) _[⊤]_ _,_ ( _**κ**_ _[U]_ ) _[⊤]_ _,_ _**µ**_ _[⊤]_ _,_ ( _**ι**_ _[L]_ ) _[⊤]_ _,_ ( _**ι**_ _[U]_ ) _[⊤]_ ) _[⊤]_ .

The Lagrangian is given by:


î ó
_L_ ( **z** _,_ _**ψ**_ _,_ _**ϕ**_ ) = **c** _[⊤]_ _π_ **[z]** [ +] _[ γ]_ [ ¯Π(] _[b][T]_ [)] + _**χ**_ _[⊤]_ ( **b** eq _−_ **A** eq **z** ) + _**ϕ**_ _[⊤]_ ( **b** ineq _−_ **A** ineq **z** )


62


**KKT Stationarity Condition.** The gradient of the Lagrangian with respect to the
primal variables **z** must be zero at the optimum ( **z** _[∗]_ _,_ _**χ**_ _[∗]_ _,_ _**ϕ**_ _[∗]_ ). Let **e** _T_ = (0 _, . . .,_ 0 _,_ 1) _[⊤]_ _∈_
R _[T]_ select the last element, and define the corresponding selector vector in R [5] _[T]_ as **e** _[⊤]_ 5 _T_ [=]
( **0** _[⊤]_ _,_ **0** _[⊤]_ _,_ **0** _[⊤]_ _,_ **0** _[⊤]_ _,_ **e** _[⊤]_ _T_ [). Let] _[ π][b][ ∈]_ _[∂]_ [¯Π(] _[b]_ _T_ _[∗]_ [) be an element of the supergradient of the continua-]
tion value function evaluated at the optimal terminal state _b_ _[∗]_ _T_ [. The stationarity condition]
_∇_ **z** _L_ = **0** yields:
**c** _π_ + _γπ_ _[b]_ **e** 5 _T −_ **A** _[⊤]_ eq _**[χ]**_ _[∗]_ _[−]_ **[A]** _[⊤]_ ineq _**[ϕ]**_ _[∗]_ [=] **[ 0]**


Expanding this matrix equation by substituting the definitions of **A** eq, **A** ineq, _**χ**_ _[∗]_ =
( _**θ**_ _[∗⊤]_ _, ν_ _[∗]_ _,_ _**λ**_ _[∗⊤]_ ) _[⊤]_, and the partitioned _**ϕ**_ _[∗]_ gives the first-order conditions for each block of

variables:


_∇_ **s** _L_ = ¯ **r** + _**θ**_ _[∗]_ _−_ _**ζ**_ _[s][∗]_ + _**ξ**_ _[s][∗]_ = **0**

_∇_ **d** _L_ = _−_ **c** ¯ + _**θ**_ _[∗]_ _−_ _**ζ**_ _[d][∗]_ + _**ξ**_ _[d][∗]_ = **0**

_∇_ **k** _L_ = _**θ**_ _[∗]_ + **L** _[⊤]_ _**λ**_ _[∗]_ _−_ _**κ**_ _[L][∗]_ + _**κ**_ _[U]_ _[∗]_ = **0**

_∇_ **p** _L_ = _**θ**_ _[∗]_ _−_ _ν_ _[∗]_ **1** _−_ _**µ**_ _[∗]_ = **0** (assuming _**ζ**_ _[p][∗]_ = **0** )

_∇_ **b** _L_ = _γπ_ _[b]_ **e** _T −_ _**λ**_ _[∗]_ + _**ι**_ _[L][∗]_ _−_ _**ι**_ _[U]_ _[∗]_ = **0**


These equations define the relationships between the optimal primal variables (implicitly

through complementary slackness) and the optimal dual variables (shadow prices). For
instance, the condition for **p** implies _**θ**_ _[∗]_ = _ν_ _[∗]_ **1** + _**µ**_ _[∗]_, equating the marginal value of energy to
its marginal value in consumption. Similarly, combining the conditions for **k** and **b** relates _**θ**_ _[∗]_


to the discounted continuation value and the shadow prices of battery constraints over time.
The conditions for **s** and **d** directly link _**θ**_ _[∗]_ to the market prices, adjusted by the multipliers
for binding non-negativity ( _**ζ**_ _[∗]_ ) or grid capacity ( _**ξ**_ _[∗]_ ) constraints.


**Other KKT Conditions.** In addition to stationarity, the optimal solution must satisfy:


 - **Primal Feasibility: A** eq **z** _[∗]_ = **b** eq and **A** ineq **z** _[∗]_ _≤_ **b** ineq.

 - **Dual Feasibility:** _**ϕ**_ _[∗]_ _≥_ **0** .

 - **Complementary Slackness:** _**ϕ**_ _[∗⊤]_ ( **b** ineq _−_ **A** ineq **z** _[∗]_ ) = 0. This implies _ϕ_ _[∗]_ _i_ [= 0 for any]
non-binding inequality constraint _i_ .


These conditions collectively characterize the optimal primal-dual solution ( **z** _[∗]_ _,_ _**χ**_ _[∗]_ _,_ _**ϕ**_ _[∗]_ ) to the

prosumer’s best-response LP.


63


### **C Proofs**

**Proof of Proposition 1**


_Proof._ **(** _⇒_ **) Anonymity implies the existence of** Φ **.** Assume the market mechanism is
anonymous. Let _**x**_ _−n_ and _**x**_ _[′]_ _−n_ [be any two allocation vectors for the other prosumers that]
produce the same multiset, i.e., Σ( _**x**_ _−n_ ) = Σ( _**x**_ _[′]_ _−n_ [). By definition, this implies that] _**[ x]**_ _[′]_ _−n_
is a permutation of _**x**_ _−n_, which we denote by _π_ . The definition of anonymity states that
_Pn_ ( _xn,_ _**x**_ _−n_ ) = _Pn_ ( _xn, π_ ( _**x**_ _−n_ )), which is equivalent to _Pn_ ( _xn,_ _**x**_ _−n_ ) = _Pn_ ( _xn,_ _**x**_ _[′]_ _−n_ [). Since the]
payment _Pn_ is invariant for any vector that generates the same multiset, it must be a function

of the multiset itself. Thus, a function Φ as described exists and is well-defined.


**(** _⇐_ **) The existence of** Φ **implies Anonymity.** Conversely, assume there exists a function

Φ such that _Pn_ ( _xn,_ _**x**_ _−n_ ) = Φ( _xn,_ Σ( _**x**_ _−n_ )). Let _π_ be any permutation of the other prosumers.

A key property of multisets is that they are invariant to permutation, meaning Σ( _**x**_ _−n_ ) =

Σ( _π_ ( _**x**_ _−n_ )). This allows the following chain of equalities:


_Pn_ ( _xn, π_ ( _**x**_ _−n_ )) = Φ( _xn,_ Σ( _π_ ( _**x**_ _−n_ ))) (by assumption)


= Φ( _xn,_ Σ( _**x**_ _−n_ )) (by multiset invariance)


= _Pn_ ( _xn,_ _**x**_ _−n_ ) (by assumption)


The result satisfies the definition of anonymity.


**Proof of Proposition 2**


_Proof._ **(** _⇒_ **) Coalition-Proofness implies the Linear Form.** Assume the mechanism
is coalition-proof. For a coalition of sellers _I_, the definition requires [�] _n∈I_ [Ψ(] _[s]_ _n_ _[, s, d]_ [) =]
Ψ( [�] _n∈I_ _[s]_ _n_ _[, s, d]_ [). For a fixed aggregate state (] _[s, d]_ [), let us define] _[ f]_ [(] _[σ]_ [) := Ψ(] _[σ, s, d]_ [) for] _[ σ >]_
0. The condition thus becomes [�] _n∈I_ _[f]_ [(] _[s]_ _n_ [) =] _[ f]_ [(][�] _n∈I_ _[s]_ _n_ [), which is Cauchy’s functional]
equation. Its unique continuous solution is linear: _f_ ( _σ_ ) = _k · σ_ . Since the proportionality

constant _k_ may depend on the state ( _s, d_ ), we define it as _k_ := _r_ ( _s, d_ ), yielding Ψ( _sn, s, d_ ) =
_sn · r_ ( _s, d_ ) for sellers. A symmetric argument for a coalition of buyers yields Ψ( _−dn, s, d_ ) =
_−dn · c_ ( _s, d_ ). Combining these cases for any prosumer establishes the linear form _Pn_ ( _**x**_ ) =
_sn · r_ ( _s, d_ ) _−_ _dn · c_ ( _s, d_ ).


**(** _⇐_ **) The Linear Form implies Coalition-Proofness.** Conversely, assume the payment

function has the linear form Ψ( _xn, s, d_ ) = _sn · r_ ( _s, d_ ) _−_ _dn · c_ ( _s, d_ ). To verify the condition


64


for a coalition of sellers _I_ (where _dn_ = 0 for all _n ∈_ _I_ ), we show that both sides of the
additivity requirement are equal. The left-hand side is [�] _n∈I_ [Ψ(] _[s]_ _n_ _[, s, d]_ [) =][ �] _n∈I_ _[s]_ _n_ _[·][ r]_ [(] _[s, d]_ [) =]
(� _n∈I_ _[s]_ _n_ [)] _[·]_ _[r]_ [(] _[s, d]_ [). The right-hand side is Ψ(] - _n∈I_ _[s]_ _n_ _[, s, d]_ [) = (] - _n∈I_ _[s]_ _n_ [)] _[·]_ _[r]_ [(] _[s, d]_ [). Since the two]
sides are equal, the condition holds. A symmetric argument applies to buyers, completing

the proof.


**Proof of Proposition 3**


_Proof. Preliminaries._ Fix a session _t_ and suppress _t_ in notation when unambiguous. The

pool is (re-)anchored at the start with reserves ( _E_ 0 _, M_ 0) = ( _s,_ 0) and level _K_ = _K_ ( _s, λ, λ_ ).

The internal marginal price is the slope of the level set



_∈_ ( _λ, λ_ ) by concentrated liquidity.
�����



_ρ_ ( _E, M_ ) =



_∂Eψ_ ( _E, M_ )
_∂M_ _ψ_ ( _E, M_ )
�����



Let ∆ _E_ = min _{s, d}_ . The pool value gathered from internal trades is


Ä ä
_M_ ( _s,_ ∆ _E_ ) = _ψ_ _[−]_ _E_ [1] = _E_ 0 _−_ ∆ _E_ _K_ ( _s, λ, λ_ ) _._


Total costs/revenues and per-unit prices follow the construction in §3:



If _d_ = _s_ : _C_ tot = _R_ tot = _M_ ( _s, s_ ) _,_


If _d < s_ : _C_ tot = _M_ ( _s, d_ ) _,_ _R_ tot = _M_ ( _s, d_ ) + _λ_ ( _s −_ _d_ ) _,_


If _d > s_ : _R_ tot = _M_ ( _s, s_ ) _,_ _C_ tot = _M_ ( _s, s_ ) + _λ_ ( _d −_ _s_ ) _,_



_c_ ( _s, d_ ) = _[C]_ [tot]



_s_ _[.]_




[tot]

_r_ ( _s, d_ ) = _[R]_ [tot]
_d_ _[,]_ _s_



For prosumer _n_ with _xn_ = _sn −_ _dn_, payment is _Pn_ ( _**x**_ ) = _snr_ ( _s, d_ ) _−_ _dnc_ ( _s, d_ ).

We now prove the _if and only if_ statement by showing both directions.


**(** _⇒_ **) If the AMM is constructed from a trading function** _ψ_ **with the stated prop-**

**erties, then the mechanism satisfies all axioms.**


**Anonymity.** By batch execution and aggregation, _Pn_ depends only on ( _xn, s, d_ ). Hence
for any permutation _π_ of _**x**_ _−n_,


_Pn_ ( _xn,_ _**x**_ _−n_ ) = Ψ( _xn, s, d_ ) = _Pn_ ( _xn, π_ ( _**x**_ _−n_ )) _,_


which is Definition 1.


65


**Coalition-Proofness.** Since _Pn_ ( _**x**_ ) = _snr_ ( _s, d_ ) _−_ _dnc_ ( _s, d_ ) is linear in ( _sn, dn_ ), for any
coalitions _I ⊆{xn >_ 0 _}_, _J ⊆{xn <_ 0 _}_,







�Ψ( _sn, s, d_ ) = _r_ ( _s, d_ ) 
_n∈I_ _n∈I_







_sn_ = Ψ
_n∈I_





 


_sn, s, d_
_n∈I_



_,_



and analogously for buyers, which is exactly (5).


**Monotonicity (positive prices).** Strict monotonicity of _ψ_ in each argument yields _∂Eψ >_
0 and _∂M_ _ψ >_ 0 on R [2] + [. Hence] _[ ρ]_ [(] _[E, M]_ [)] _[ >]_ [ 0 for internal trades; imbalance terms use] _[ λ,][ λ >]_ [ 0.]
Therefore _r_ ( _s, d_ ) _>_ 0 and _c_ ( _s, d_ ) _>_ 0 for all _s, d >_ 0.


**Individual Rationality.** Concentrated liquidity enforces _ρ_ ( _E, M_ ) _∈_ ( _λ, λ_ ) internally. If

_s_ = _d_, then _λ < r_ ( _s, s_ ) = _c_ ( _s, s_ ) _< λ_ . If _s > d_ (surplus), the last _s −_ _d_ units clear at _λ_ ;

proportional sharing implies _r_ ( _s, d_ ) _→_ _λ_ as surplus grows and _c_ ( _s, d_ ) = _M_ ( _s, d_ ) _/d < λ_ . Thus


_r_ ( _s, d_ ) = _λ_ if _s ≥_ _d,_ _c_ ( _s, d_ ) _< λ_ if _s > d,_


with symmetric statements when _d ≥_ _s_ . This is precisely the IR boundary behavior.


**No-Arbitrage.** Internally, every marginal trade clears at _ρ ∈_ ( _λ, λ_ ). Under proportional

sharing, the average internal buy price does not fall below the average internal sell price;

external balancing only widens the spread because _λ > λ_ . Hence _r_ ( _s, d_ ) _≤_ _c_ ( _s, d_ ) for all

( _s, d_ ).


**Homogeneity.** Homotheticity of _ψ_ implies _ψ_ = _φ ◦_ _g_ for monotone _φ_ and homogeneous _g_

(degree _k >_ 0). Level sets of _ψ_ are radial scalings; the slope _ρ_ ( _E, M_ ) depends only on _M/E_ .

Under aggregation, ( _s, d_ ) enter via _y_ = _s/d_ . Therefore


_r_ ( _αs, αd_ ) = _r_ ( _s, d_ ) _,_ _c_ ( _αs, αd_ ) = _c_ ( _s, d_ ) ( _α >_ 0) _,_


so both prices are homogeneous of degree zero.


**Responsiveness.** Quasi-concavity of _ψ_ makes upper level sets _{ψ ≥_ _K}_ convex. This

implies that their slope _ρ_ is strictly decreasing along the energy axis (for fixed _K_ ) and

strictly increasing along the money axis. Increasing _s_ (holding _d_ fixed) shifts execution

toward portions with lower _ρ_ ; increasing _d_ shifts toward higher _ρ_ . Averaging via proportional


66


sharing preserves these comparative statics:


_∂r_ _∂r_ _∂c_ _∂c_
_∂s_ _[<]_ [ 0] _[,]_ _∂d_ _[>]_ [ 0] _[,]_ _∂s_ _[<]_ [ 0] _[,]_ _∂d_ _[>]_ [ 0] _[.]_


**Budget-Balance (accounting).** By the above definitions and external legs, the opera
tor’s net cash position is


_C_ tot + **1** _{s>d}λ_ ( _s −_ _d_ ) _−_ _R_ tot _−_ **1** _{d>s}λ_ ( _d −_ _s_ ) = 0 _._


Equivalently,

_d c_ ( _s, d_ ) _−_ _s r_ ( _s, d_ ) = **1** _{d>s}λ_ ( _d −_ _s_ ) _−_ **1** _{s>d}λ_ ( _s −_ _d_ ) _,_


so the mechanism is exactly balanced once the external trades are included, and the “self
sustaining” inequality in the axiom holds in the appropriate regions.


**(** _⇐_ **) Conversely, suppose a market mechanism satisfies Anonymity, Coalition-**

**Proofness, No-Arbitrage, Budget-Balance, Individual Rationality, Monotonic-**

**ity, Homogeneity, and Responsiveness. Then it must arise from such an AMM**

**with a trading function** _ψ_ **satisfying the stated properties and with concentrated**

**liquidity.**


**Step 1: From axioms to batch execution and proportional payments.** Anonymity

implies prices cannot depend on order identity or timing, only on the multiset of allocations.

Coalition-proofness implies that splitting or merging trades cannot change total payments

for a group of pure buyers or pure sellers. As in Proposition 2, this forces the payment to

be linear in own quantity:

_Pn_ ( _**x**_ ) = _snr_ ( _s, d_ ) _−_ _dnc_ ( _s, d_ ) _,_


with uniform marginal prices _r, c_ for all sellers and buyers. Thus trades must be executed in

a single batch with proportional payments.


**Step 2: Defining the demand curve.** Fix a session _t_ and a total initial energy supply

_s >_ 0. Consider posting a scalar price _ρ_ for energy. Let


_gt_ ( _ρ_ ) _∈_ [0 _, s_ ]


denote the quantity of energy the mechanism is willing to _continue to hold_ at price _ρ_ ; equiv
alently, _s −_ _gt_ ( _ρ_ ) is the quantity it is willing to sell at price _ρ_ . Formally, in the Myersonian


67


framework of Milionis et al. (2024), _gt_ is the (right-continuous) inventory demand curve

associated with the mechanism.


**Claim 1.** For all _ρ < λt_, we have _gt_ ( _ρ_ ) = _s_ .
_Proof._ Suppose there exists _ρ < λ_ ~~_t_~~ with _gt_ ( _ρ_ ) _< s_ . Then at price _ρ_ the mechanism is
willing to sell _s −_ _gt_ ( _p_ ) _>_ 0 units internally. A prosumer could buy this quantity from the

AMM at price _ρ_ and immediately resell it to the main grid at price _λ_ ~~_t_~~, realizing a risk-free
profit ( _λ_ ~~_t_~~ _−_ _ρ_ )( _s −_ _gt_ ( _ρ_ )) _>_ 0. This violates Individual Rationality and No-Arbitrage. Hence
_gt_ ( _ρ_ ) = _s_ for all _p < λt_ . □


**Claim 2** The function _gt_ ( _ρ_ ) is non-increasing in _ρ_ .
_Proof._ If _gt_ were not non-increasing, there would exist _ρ_ 1 _< ρ_ 2 with _gt_ ( _ρ_ 1) _< gt_ ( _ρ_ 2).
Then an agent could buy at _ρ_ 1 when the mechanism is willing to sell more (lower energy
reserves) and sell back at _ρ_ 2 when the mechanism is willing to hold more (lower energy

reserves), generating internal cyclic arbitrage. This is precisely ruled out by the no-arbitrage

characterization of inventory demand curves in Milionis et al. (2024, Prop. 2.1). Hence _gt_

must be nonincreasing. □


**Claim 3** For all _ρ > λt_, we have _gt_ ( _ρ_ ) = 0.

_Proof._ Suppose _gt_ ( _ρ_ ) _>_ 0 for some _ρ > λt_ . Consider a balanced market with _s_ = _d_ . At
price _ρ_, the mechanism sells only _s −_ _gt_ ( _ρ_ ), leaving a residual inventory _gt_ ( _ρ_ ) _>_ 0 and the

same aggregate demand. To clear the market while respecting IR, the AMM would have to

sell _gt_ ( _ρ_ ) units to the grid at _λt_ and simultaneously buy back the same amount from the
grid at _λt_ to satisfy demand, which strictly violates Budget-Balance. Therefore _gt_ ( _λt_ ) = 0;
by nonincreasingness, _gt_ ( _ρ_ ) = 0 for all _ρ > λt_ . □


**Step 3: Shape of** _gt_ **and existence of a quasi-concave potential.** Claims 1–3 imply
that _gt_ has the following form:



_s,_ _ρ < λt,_



_gt_ ( _ρ_ ) =













strictly decreasing from _s_ to 0 _,_ _ρ ∈_ [ _λ_ ~~_t_~~ _, λt_ ] _,_






0 _,_ _ρ > λt,_



i.e., _gt_ is flat outside the interval [ _λt, λt_ ] and strictly decreasing on that interval. By construction, the support of trading prices lies in [ _λt, λt_ ]; this is exactly “concentrated liquidity”.


68


The Myersonian characterization result Thm. 3.4 of Milionis et al. (2024) states that there

is a one-to-one correspondence between such arbitrage-free, budget-balanced, individually

rational inventory demand curves _gt_ and AMMs implemented by strictly increasing, quasiconcave, homothetic trading potentials _ψ_ whose level sets generate the same price schedule. [16]


Thus the axioms imply the existence of a trading function _ψ_ ( _E, M_ ) that is (i) strictly in
creasing in _E_ and _M_, (ii) homothetic, and (iii) quasi-concave, and whose level sets implement

precisely the same batch pricing rule with concentrated liquidity in [ _λt, λt_ ].


Combining the forward and reverse directions, we conclude that a mechanism satis
fies Anonymity, Coalition-Proofness, No-Arbitrage, Budget-Balance, Individual Rationality,

Monotonicity, Homogeneity, and Responsiveness _if and only if_ it can be implemented by an

AMM constructed from a trading function _ψ_ that is strictly increasing, homothetic, quasi
concave, and has liquidity concentrated within [ _λ_ ~~_t_~~ _, λt_ ].


**Proof of Proposition 5**


We show that the defintion of Potential Game applies.

Budget balance implies [�] _i∈N_ _[π]_ _i_ [(] _**[σ]**_ [) =] _[ W]_ [(] _**[σ]**_ [).]
For a unilateral deviation by agent _n_ from _σn_ to _σn_ _[′]_ [, the change in global welfare is:]


∆ _W_ = �( _πi_ ( _σn_ _[′]_ _[, σ][−][n]_ [)] _[ −]_ _[π][i]_ [(] _[σ][n][, σ][−][n]_ [))]

_i∈N_


Under the Atomicity assumption, prices are invariant to deviations by a single prosumer, so
_πi_ ( _σn_ _[′]_ _[, σ][−][n]_ [) =] _[ π][i]_ [(] _[σ][n][, σ][−][n]_ [) for all] _[ i][ ̸]_ [=] _[ n]_ [. The sum collapses to:]


_W_ ( _σn_ _[′]_ _[, σ][−][n]_ [)] _[ −]_ _[W]_ [(] _[σ][n][, σ][−][n]_ [) =] _[ π][n]_ [(] _[σ]_ _n_ _[′]_ _[, σ][−][n]_ [)] _[ −]_ _[π][n]_ [(] _[σ][n][, σ][−][n]_ [)]


Thus, _W_ is a potential function for the game.


**Proof of Proposition 4**


**Sufficiency.** We show that if _**σ**_ _[∗]_ maximizes _W_ [¯] ( _·_ ), then _**σ**_ _[∗]_ must be a BNE.


Suppose by contradiction that _**σ**_ _[∗]_ is not a BNE. Then, there exists a prosumer _i ∈_ _N_
and an alternative strategy _σi_ _[′]_ [such that ¯] _[π][i]_ [(] _[σ]_ _i_ _[′][,]_ _**[ σ]**_ _−_ _[∗]_ _i_ [)] _[ >]_ [ ¯] _[π][i]_ [(] _**[σ]**_ _[∗]_ [)] _[.]_ [ Consider the strategy profile]
_**σ**_ ˜ = ( _σi_ _[′][,]_ _**[ σ]**_ _−_ _[∗]_ _i_ [).]
By Atomicity (Assumption 1), ¯ _πn_ (˜ _**σ**_ ) = ¯ _πn_ ( _**σ**_ _[∗]_ ) _,_ _∀n ̸_ = _i._


16In our notation, the inventory axis corresponds to _E_ and the monetary axis to _M_ . The slope of level
sets of _ψ_ recovers the price _p_, and the induced inventory choices along those level sets recover _gt_ .


69


By Budget Balance (Axiom 4), _W_ [¯] ( _**σ**_ ) = [�] _n_ _[N]_ =1 _[π]_ [¯] _[n]_ [(] _**[σ]**_ [) for all] _**[ σ]**_ [.]
Combining the two properties: _W_ [¯] (˜ _**σ**_ ) = [�] _n_ _[N]_ =1 _[π]_ [¯] _[n]_ [(˜] _**[σ]**_ [) = ¯] _[W]_ [(] _**[σ]**_ _[∗]_ [) +][ �] _[π]_ [¯] _[i]_ [(˜] _**[σ]**_ [)] _[ −]_ _[π]_ [¯] _[i]_ [(] _**[σ]**_ _[∗]_ [)][�] _[.]_
Since ¯ _πi_ (˜ _**σ**_ ) _−_ _π_ ¯ _i_ ( _**σ**_ _[∗]_ ) _>_ 0, we must have _W_ [¯] (˜ _**σ**_ ) _>_ _W_ [¯] ( _**σ**_ _[∗]_ ) _._
This contradicts the initial assumption that _**σ**_ _[∗]_ maximizes _W_ [¯] ( _·_ ). Therefore, no such
profitable deviation _σi_ _[′]_ [can exist, and] _**[ σ]**_ _[∗]_ [must be a Bayes-Nash Equilibrium.]


**Necessity.** We show that If _**σ**_ _[∗]_ is a BNE, then _**σ**_ _[∗]_ maximizes _W_ [¯] ( _·_ ).


Suppose not. Then there exists a mixed profile _**σ**_ _[′]_ such that _W_ [¯] ( _**σ**_ _[′]_ ) _>_ _W_ [¯] ( _**σ**_ _[∗]_ ).

Define the expected net trade vector _x_ ( _**σ**_ ) = E _**θ**_ _,_ _**a**_ _∼_ _**σ**_ [ **s** ( _**a**_ ) _−_ **d** ( _**a**_ )].

          - _T_
Let the welfare function be _W_ [¯] ( **x** ) = _t_ =1 [[] _[λ]_ ~~_t_~~ _[x]_ _t_ [+] _[−]_ _[λ]_ _t_ _[x][−]_ _t_ [].][17]

Define also the piecewise-linear function _wt_ ( _x_ ) = _λtx_ [+] _−_ _λtx_ _[−]_ .
Since _λ_ ~~_t_~~ _< λt_, the piecewise-linear function _wt_ ( _x_ ) = _λ_ ~~_t_~~ _x_ [+] _−_ _λtx_ _[−]_ is concave. Therefore,
the welfare function _W_ [¯] ( **x** ) = [�] _t_ _[w]_ _t_ [(] _[x]_ _t_ [) is a concave function of the vector (] _[x]_ 1 _[, . . ., x]_ _T_ [).]
Since _W_ [¯] ( _**σ**_ _[′]_ ) _>_ _W_ [¯] ( _**σ**_ _[∗]_ ), concavity implies the existence of a subgradient _g ∈_ _∂W_ [¯] ( _x_ ( _**σ**_ _[∗]_ ))
such that _⟨g, x_ ( _**σ**_ _[′]_ ) _−_ _x_ ( _**σ**_ _[∗]_ ) _⟩_ _>_ 0. Moreover, the components of the subgradient are given by



_gt_ =




 _λ_ ~~_t_~~ _,_ if _xt_ ( _**σ**_ _[∗]_ ) _>_ 0 _,_

~~~~
~~~~

_λt,_ if _xt_ ( _**σ**_ _[∗]_ ) _<_ 0 _,_






 _∈_ [ _λt, λt_ ] _,_ if _xt_ ( _**σ**_ _[∗]_ ) = 0 _._



This implies the existence of periods _t, τ_ where the direction of improvement is to move

energy from _τ_ to _t_ . Formally:


_gt_ [ _xt_ ( _**σ**_ _[′]_ ) _−_ _xt_ ( _**σ**_ _[∗]_ )] + _gτ_ [ _xτ_ ( _**σ**_ _[′]_ ) _−_ _xτ_ ( _**σ**_ _[∗]_ )] _>_ 0 _._


This inequality requires _xt_ ( _**σ**_ _[′]_ ) _> xt_ ( _**σ**_ _[∗]_ ) (increasing net flow at _t_ ) and _xτ_ ( _**σ**_ _[′]_ ) _< xτ_ ( _**σ**_ _[∗]_ )

(decreasing net flow at _τ_ ).

We analyze the three regimes in which the inequality can occur. In each, we show a

profitable deviation exists for a set of agents with positive _F_ ( _· | ze_ )-measure in the support
of _**σ**_ _[∗]_ .


**Case 1: Surplus-Reallocation** ( _x_ _[∗]_ _t_ _[>]_ [ 0] _[, x]_ _τ_ _[∗]_ _[>]_ [ 0).]
In this case, the subgradients are _gt_ = _λ_ ~~_t_~~ and _gτ_ = _λτ_, with the condition _λ_ ~~_t_~~ _> λ_ ~~_τ_~~ . By
Individual Rationality (Axiom 5), the AMM sell prices are anchored at the grid floor: ¯ _rt_ = _λt_
and ¯ _rτ_ = _λ_ ~~_τ_~~ .


17Recall that _x_ + = max( _x,_ 0) and _x−_ = max( _−x,_ 0).


70


Define the set of active sellers at _τ_ : _Sτ_ = _{_ ( _n, θn_ ) : _snτ >_ 0 under _σn_ _[∗][}][.]_
Since _x_ _[∗]_ _τ_ _[>]_ [ 0, this set has positive measure. Any agent in] _[ S][τ]_ [can profitably deviate by]
shifting supply to _t_, gaining ∆ _π_ = ¯ _rt −_ _r_ ¯ _τ_ = _λt −_ _λ_ ~~_τ_~~ _>_ 0.


**Case 2: Deficit-Reallocation** ( _x_ _[∗]_ _t_ _[<]_ [ 0] _[, x]_ _τ_ _[∗]_ _[<]_ [ 0).]
Here, _gt_ = _λt_ and _gτ_ = _λτ_, with _λt < λτ_ . By Individual Rationality, the AMM buy prices
are anchored at the grid ceiling: ¯ _ct_ = _λt_ and ¯ _cτ_ = _λτ_ .
Define the set of active buyers at _τ_ : _Bτ_ = _{_ ( _n, θn_ ) : _dnτ >_ 0 under _σn_ _[∗][}][.]_
Since _x_ _[∗]_ _τ_ _[<]_ [ 0, this set has positive measure. Any agent in] _[ B][τ]_ [can profitably deviate by]
shifting demand to _t_, saving ∆ _π_ = ¯ _cτ −_ _c_ ¯ _t_ = _λτ −_ _λt >_ 0.


**Case 3: Cross-Reallocation** ( _x_ _[∗]_ _t_ _[<]_ [ 0] _[, x]_ _τ_ _[∗]_ _[>]_ [ 0).]
Here, _gt_ = _λt_ and _gτ_ = _λ_ ~~_τ_~~ . The condition for welfare improvement is _λt > λτ_ . By Individual
Rationality, prices are set at the unfavorable bounds: ¯ _ct_ = _λt_ and ¯ _rτ_ = _λ_ ~~_τ_~~ .
Define the sets of active traders in the support of _**σ**_ _[∗]_ :

_Bt_ = _{_ ( _n, θn_ ) : _dnt >_ 0 _},_ _Sτ_ = _{_ ( _n, θn_ ) : _snτ >_ 0 _}._
Since active trade implies non-zero measure, both sets have positive measure given _x_ _[∗]_ _t_ _[<]_ [ 0]
and _x_ _[∗]_ _τ_ _[>]_ [ 0. Consider two potential deviations:]


 - **Demand Shift** (for _n ∈_ _Bt_ ): Shift demand from _t_ to _τ_ . Gain: _πD_ = _λt −_ _c_ ¯ _τ_ .


 - **Supply Shift** (for _n ∈_ _Sτ_ ): Shift supply from _τ_ to _t_ . Gain: _πS_ = ¯ _rt −_ _λ_ ~~_τ_~~ .


We need not verify which specific deviation is profitable, only that at least one of them must

be. Summing the payoff differences:


_πD_ + _πS_ = ( _λt −_ _c_ ¯ _τ_ ) + (¯ _rt −_ _λ_ ~~_τ_~~ ) = ( _λt −_ _λτ_ ) + (¯ _rt −_ _c_ ¯ _τ_ ) _._


The first term ( _λt −_ _λ_ ~~_τ_~~ ) is strictly positive by the welfare improvement assumption. The
second term (¯ _rt −_ _c_ ¯ _τ_ ) represents the internal price spread.

Notice that Responsiveness (Axiom 7) combined with Individual Rationality imply that

_r_ ¯ _t > λ_ ~~_t_~~, and ¯ _cτ < λτ_ (see Eq.11).
Consequently, _πD_ + _πS >_ 0. This implies max( _πD, πS_ ) _>_ 0. So almost surely there exists
an agent (either in _Bt_ or _Sτ_ ) with a strictly profitable deviation.
In all cases, the hypothesis that _**σ**_ _[∗]_ does not maximize welfare leads to the existence of

a profitable unilateral deviation, contradicting the definition of a BNE.


71


**Proof of Proposition 6**


To prove existence and multiplicity of the MPE, we first aggregate the individual equilibrium

conditions into a single Planner’s Problem.


**Equivalence to Planner’s Problem.** Let ( _**σ**_ _[∗]_ _,_ ¯ _**ρ**_ _[∗]_ _,_ Π _[∗]_ ) be an MPE. Summing the indi
vidual Bellman equations for all _n ∈_ _N_ :







max  - _πn_ ( _σn,_ _**σ**_ _−∗_ _n_ _[,]_ [ ¯] _**[ρ]**_ _[∗]_ [) +] _[ γ]_ [E][[Π] _[n]_ [(] _[b][′][, z][′]_ [)]][�] _[.]_
_n_ _σn_



Π _n_ ( _b, z_ ) = _n_ _n_



By Proposition 5 (Potential Game), [�] _n_ _[π]_ _n_ [=] _[ W]_ [.]
By Atomicity, cross-terms in the prosumer optimization problems vanish. Thus,




- - 
_πn_ ( _**σ**_ _,_ ¯ _**ρ**_ _[∗]_ ) + _γ_ E[Π _n_ ( _b_ _[′]_ _, z_ _[′]_ )] _._
_n_




- max

_n_ _σn_




- _πn_ ( _σn,_ _**σ**_ _−_ _[∗]_ _n_ _[,]_ [ ¯] _**[ρ]**_ _[∗]_ [) +] _[ γ]_ [E][[Π] _[n]_ [(] _[b][′][, z][′]_ [)]] = max
_**σ**_



Defining the aggregate value function _V_ ( _b, z_ ) _≡_ [�] _n_ [Π] _n_ [(] _[b, z]_ [), the sum of the prosumer]
Bellman equations yields the single Bellman equation of the Social Planner, where the strategy profile _**σ**_ _[∗]_ maximizes the aggregate objective:


_V_ ( _b, z_ ) = max   - _W_ ( _**σ**_ _, b, z_ ) + _γ_ E[ _V_ ( _b′, z′_ ) _|_ _**σ**_ ]� _,_ _A_ ( _b_ ) _≡×nAn_ ( _bn_ ) _._ (37)
_**σ**_ _∈_ ∆ext( _A_ ( _b_ ))


Thus, any MPE strategy profile _**σ**_ _[∗]_ must be an optimal policy for the Planner.


**Existence.** Let _B_ ( _S_ ) be the Banach space of bounded continuous functions on the state
space of the game _S ≡_ _B_ agg _× Z ⊂_ R _[N]_ [+] _[Z]_, where _B_ agg = [�] _n_ _[N]_ =1 [[0] _[, B][n]_ [] is the hyperrectangle]
of joint battery states and _Z ⊆_ R _[Z]_ is the state space of public variables (with _Z_ denoting

the dimension of the public signal vector _z_ ). Define the Bellman operator _T_ : _B_ ( _S_ ) _→_ _B_ ( _S_ )

associated with (37):


( _T V_ )( _b, z_ ) = max             - _W_ ( _**σ**_ _, b, z_ ) + _γ_ E[ _V_ ( _b′, z′_ )]� _._
_**σ**_


Since the stage welfare _W_ is bounded (by constraints _Bn, Xn_ ) and _γ ∈_ (0 _,_ 1), _T_ satisfies
Blackwell’s sufficiency conditions (Blackwell, 1965): _monotonicity_ holds ( _V ≤_ _U_ = _⇒_ _T V ≤_

_T U_ ) by the linearity of the expectation operator, and _discounting_ holds ( _T_ ( _V_ + _c_ ) = _T V_ + _γc_ )

due to the discount factor _γ ∈_ [0 _,_ 1).

By the Banach Fixed Point Theorem (Banach, 1922), _T_ is a contraction mapping with
a unique fixed point _V_ _[∗]_ . The set of optimal policies is non-empty, implying existence of an

MPE.


72


**Multiplicity.** While the aggregate value function _V_ _[∗]_ is unique, the strategy profile _**σ**_ _[∗]_ is

not. Multiplicity arises from the many-to-one mapping from individual strategies to aggre
gate outcomes.
Let _Mn ≡|_ ext( _An_ ) _|_ be the number of pure strategies for agent _n_ so that _**σ**_ _n ∈_ _∆_ _[M][n][−]_ [1] .
The set of mixed strategy profiles implementing a given optimal aggregate path (¯ **s** _,_ **d** [¯] ) is
given by the inverse image of the linear aggregation map A : [�] _n_ _[∆][M][n][−]_ [1] _[ →]_ [R][2] _[T]_ [. That is,]




- [] -  ¯ **s**

¯
 [=][ A] _[−]_ [1] **d**



A _**σ**_ =
������




¯ **s**
¯
**d**



Σ _[∗]_ (¯ **s** _,_ **d** [¯] ) [=]






 _**[σ]**_ _[ ∈]_



_N_

- _∆_ _[M][n][−]_ [1]


_n_ =1



_∩_ _P,_



where _P_ = [�] _n_ _[∆][M][n][−]_ [1][ is the product of strategy simplices, and][ A][ is the linear aggregation]
operator:








**s** _n,k_

**d** _n,k_



_Mn_

- _σn,k_

_k_ =1



A _**σ**_ _≡_



_N_



_n_ =1



_,_



with ( **s** _n,k,_ **d** _n,k_ ) representing the _k_ -th extreme point (pure strategy) for agent _n_ .
Since (¯ **s** _,_ **d** [¯] ) lies in the convex hull of the extreme points—i.e., (¯ **s** _,_ **d** [¯] ) _∈_ [�] _[N]_ _n_ =1 [conv(ext(] _[A][n]_ [))—]
Σ _[∗]_
(¯ **s** _,_ **d** [¯] ) [is a non-empty convex polytope. By the Fundamental Theorem of Linear Maps (e.g.,]
Theorem 3.21 in Axler, 2015), we can lower-bound its dimension:



dim(Σ _[∗]_ ) _≥_



_N_
�( _Mn −_ 1) _−_ rank(A) _._

_n_ =1



Unless the linear system A _**σ**_ = (¯ **s** _,_ **d** [¯] ) is over-determined (2 _T ≥_ [�] _n_ [(] _[M]_ _n_ _[−]_ [1)) and the]

extreme point images are linearly independent—a measure-zero event with heterogeneous

prosumers—this dimension is _strictly_ positive. This confirms the existence of a continuum

of payoff-equivalent equilibria.


**Proof of Proposition 7**


The proof proceeds in two steps: first establishing almost sure convergence of the realized

welfare via the Law of Large Numbers, and then proving the convergence of the expected

welfare via the Dominated Convergence Theorem.


**Almost Sure Convergence of the Realized Welfare.** Conditioned on the public state

_ze_, the sequence of realized net trade vectors _{_ **y** _n}n≥_ 1 is i.i.d. by construction. Since _A_ ( _θn_ )
are compact sets, the support of **x** _n_ is uniformly bounded, ensuring that E _∥_ **x** _n∥_ _< ∞_ .
_a.s._
Consequently, the SLLN applies component-wise, guaranteeing: ¯ **x** _N_ _−−→_ **X** [¯] .


73


Since the welfare function _W_ avg( _·_ ) is continuous, the Continuous Mapping Theorem im
plies that:

_a.s._ _a.s._
**x** ¯ _N_ _−−→_ **X** [¯] = _⇒_ _W_ avg(¯ **x** _N_ ) _−−→_ _W_ avg( **X** [¯] ) _._


**Convergence of the Expected Welfare** From the previous part of the proof, we have

_a.s._
almost sure convergence: _W_ avg(¯ **x** _N_ ) _−−→_ _W_ avg( **X** [¯] ). To interchange limit and expectation, we

invoke the Dominated Convergence Theorem.

The feasible domain lies in the convex hull of the action spaces _A_ ( _θ_ ), a compact subset
of R _[TL]_ . Since _W_ avg( _·_ ) is continuous on this compact set, it is uniformly bounded by some
finite constant _κ_ . The sequence of random variables _{W_ avg(¯ **x** _N_ ) _}_ is thus dominated by _κ_ .

The DCT applies, yielding:


ï ò
lim lim = _W_ avg( **X** [¯] ) _._
_N_ _→∞_ [E][ �] _[W]_ [avg][(¯] **[x]** _[N]_ [)][�] [=][ E] _N_ _→∞_ _[W]_ [avg][(¯] **[x]** _[N]_ [)]


**Proof of Proposition 8**


Let _θn_ be the agent’s true type and _θ_ [¯] _j_ be the centroid of the bin _Rj_ containing _θn_ . The
quantization error is _∥θn −_ _θ_ [¯] _j∥≤_ _δ_ .

The regret is defined as the difference between the agent’s true optimal value and the

expected value obtained from the projected strategy recommended by the solver:


Regret _n_ = _V_ ( _θn_ ) _−_ E **a** _∼σj_ _[⋆]_            - _πn_ (Prj( **a** ; _θn_ ))� _,_


where _V_ ( _θ_ ) = max **a** _∈A_ ( _θ_ ) _π_ ( **a** ) is the optimal value function.

Since the prosumer’s optimization problem is a Linear Program (LP), its value function

_V_ ( _θ_ ) is Lipschitz continuous with respect to _θ_ . Thus, there exists a constant _L_ 1 such that:


_|V_ ( _θn_ ) _−_ _V_ ( _θ_ [¯] _j_ ) _| ≤_ _L_ 1 _∥θn −_ _θ_ [¯] _j∥≤_ _L_ 1 _δ._


Now let **a** _k_ be a pure strategy in the support of the equilibrium strategy _σj_ _[⋆]_ [. This action]
is feasible for the centroid _θ_ [¯] _j_ (i.e., **a** _k ∈_ _A_ ( _θ_ [¯] _j_ )). The projection Prj( **a** _k_ ; _θn_ ) maps it to the
closest point in the true feasible set _A_ ( _θn_ ). Since the feasible set correspondence _θ_ ⇒ _A_ ( _θ_ )

is Lipschitz continuous in the Hausdorff metric, the distance between the sets is bounded by

_L_ 2 _δ_ . Thus:
_∥_ **a** _k −_ Prj( **a** _k_ ; _θn_ ) _∥≤_ _L_ 2 _δ._


Since the profit function _πn_ ( _·_ ) is linear (and thus Lipschitz with constant _Lπ_ ), the profit loss


74


from projection is:

_|πn_ ( **a** _k_ ) _−_ _πn_ (Prj( **a** _k_ ; _θn_ )) _| ≤_ _LπL_ 2 _δ._


Combining these bounds:


Regret _n_ = _V_ ( _θn_ ) _−_ E **a** _∼σj_ _[⋆]_ [[] _[π][n]_ [(Prj(] **[a]** [;] _[ θ][n]_ [))]]



= _V_ ( _θn_ ) _−_ _V_ ( _θ_ [¯] _j_ )

 - ~~�~~  - ~~�~~
_≤L_ 1 _δ_



+ _V_ ( _θ_ [¯] _j_ ) _−_ E **a** _∼σj_ _[⋆]_ [[] _[π][n]_ [(] **[a]** [)]]

 - ~~�~~  - ~~�~~
=0 (Optimality of _σj_ _[⋆]_ [for ¯] _[θ][j]_ [)]



+ E **a** _∼σj_ _[⋆]_ [[] _[π][n]_ [(] **[a]** [)] _[ −]_ _[π][n]_ [(Prj(] **[a]** [;] _[ θ][n]_ [))]]

~~�~~ ~~�~~  - ~~�~~
_≤LπL_ 2 _δ_



_._



The middle term is zero because _σj_ _[⋆]_ [is optimal for the representative type ¯] _[θ][j]_ [, so its expected]
payoff equals _V_ ( _θ_ [¯] _j_ ). The regret is thus bounded by ( _L_ 1 + _LπL_ 2) _δ_ . Letting _κ_ = _L_ 1 + _LπL_ 2,
we have Regret _n ≤_ _κδ_ .


75


