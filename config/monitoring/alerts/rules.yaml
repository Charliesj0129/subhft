groups:
- name: HFT_Critical
  rules:
  # Feed Health
  - alert: FeedGapCritical
    expr: rate(feed_events_total[30s]) == 0
    for: 5s
    labels:
        severity: critical
    annotations:
        summary: "Market Data Gap Detected"
        description: "No feed events for >5s during uptime."

  - alert: BusOverflowCritical
    expr: increase(bus_overflow_total[1m]) > 0
    for: 1s
    labels:
        severity: critical
    annotations:
        summary: "Event Bus Overflow"
        description: "Events dropped due to full ring buffer."

  # Risk
  - alert: StormGuardHalt
    expr: stormguard_mode == 3
    for: 0s
    labels:
        severity: critical
    annotations:
        summary: "StormGuard HALT Triggered"
        description: "Strategy {{ $labels.strategy }} hit HALT threshold."

  - alert: HighRejectRate
    expr: rate(order_reject_total[1m]) / (rate(order_actions_total[1m]) + 1) > 0.1
    for: 1m
    labels:
        severity: warning
    annotations:
        summary: "High Order Reject Rate"
        description: "Reject rate > 10%."

  # Execution Health
  - alert: ExecutionLagHigh
    expr: histogram_quantile(0.99, sum(rate(execution_router_lag_ns_bucket[30s])) by (le)) > 1e7
    for: 30s
    labels:
        severity: warning
    annotations:
        summary: "Execution Lag High"
        description: "P99 execution report lag > 10ms."

  - alert: QueueDepthSpike
    expr: max_over_time(queue_depth[30s]) > 1000
    for: 30s
    labels:
        severity: warning
    annotations:
        summary: "Queue Depth Spike"
        description: "Queue depth exceeded 1000 in the last 30s."

  # Infra
  - alert: RecorderFailure
    expr: increase(recorder_failures_total[5m]) > 0
    for: 0s
    labels:
        severity: critical
    annotations:
        summary: "Recorder Write Failed"
        description: "ClickHouse ingestion failing."
