
name: HFT CI

on:
  push:
  pull_request:

concurrency:
  group: hft-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality (Lint/Format/Types)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: uv sync --dev
      - name: Ruff lint
        run: uv run ruff check src tests
      - name: Ruff format
        run: uv run ruff format --check src tests
      - name: Mypy
        run: uv run mypy

  tests:
    name: Tests (Unit/Integration/Spec)
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: uv sync --dev
      - name: Run tests
        env:
          PYTHONPATH: src
        run: |
          uv run pytest -m "not stress and not system and not acceptance" \
            --ignore=tests/stress --ignore=tests/benchmark \
            --cov=src/hft_platform --cov-branch --cov-fail-under=50
