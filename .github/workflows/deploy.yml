name: Deploy HFT Platform
on:
  push:
    branches: [main, temp_reset_branch]
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt
          pip install -e .

      - name: Run tests
        run: |
          . .venv/bin/activate
          pytest -q


      - name: Debug Secrets
        run: |
          echo "Checking Secrets availability..."
          if [ -z "${{ secrets.VM_HOST }}" ]; then echo "VM_HOST is empty"; else echo "VM_HOST is set"; fi
          if [ -z "${{ secrets.VM_PUBLIC_IP }}" ]; then echo "VM_PUBLIC_IP is empty"; else echo "VM_PUBLIC_IP is set"; fi

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v0.1.10
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          SHIOAJI_API_KEY: ${{ secrets.SHIOAJI_API_KEY }}
          SHIOAJI_SECRET_KEY: ${{ secrets.SHIOAJI_SECRET_KEY }}
        with:
          host: ${{ secrets.VM_HOST || secrets.VM_PUBLIC_IP }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          envs: SHIOAJI_API_KEY,SHIOAJI_SECRET_KEY,GITHUB_REF_NAME,SHIOAJI_PERSON_ID,SHIOAJI_PASSWORD
          script: |
            # Export Envs for the script
            set -ex
            export SHIOAJI_API_KEY=$SHIOAJI_API_KEY
            export SHIOAJI_SECRET_KEY=$SHIOAJI_SECRET_KEY
            export SHIOAJI_PERSON_ID=$SHIOAJI_API_KEY
            export SHIOAJI_PASSWORD=$SHIOAJI_SECRET_KEY
            
            # Kill existing service safely using PID file
            if [ -f hft.pid ]; then
              kill $(cat hft.pid) || true
              rm hft.pid
            fi
            
            # Setup dependencies
            # Ensure python3-venv is installed (missing on minimal Ubuntu images)
            sudo apt-get update
            # DEBIAN_FRONTEND=noninteractive to avoid prompts
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y python3-venv python3-pip
            
            # Setup deployment directory
            cd ~/hft_platform || git clone https://github.com/Charliesj0129/subhft.git ~/hft_platform && cd ~/hft_platform
            git fetch origin
            # Use the branch that triggered the workflow
            CURRENT_BRANCH=${GITHUB_REF_NAME:-main}
            git reset --hard origin/$CURRENT_BRANCH
            
            # Install dependencies
            python3 -m venv .venv
            . .venv/bin/activate
            # Ensure shioaji and other deps are installed
            pip install -r requirements.txt
            pip install -e .
            
            # Run subscription discovery FIRST to generate config/symbols.yaml
            echo "Discovering contracts..."
            # Fix: Run as script directly, use unbuffered output
            python -u scripts/subscribe_futures.py
            
            # Start Platform (reads config/symbols.yaml on startup)
            echo "Starting Platform..."
            mkdir -p logs
            nohup python -m hft_platform.main > logs/run.log 2>&1 &
            echo $! > hft.pid
            
            # Wait for startup and check logs
            sleep 5
            tail -n 20 logs/run.log
