name: Deploy HFT Platform
on:
  push:
    branches: [main, temp_reset_branch]
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt

      - name: Run tests
        run: |
          . .venv/bin/activate
          pytest -q


      - name: Debug Secrets
        run: |
          echo "Checking Secrets availability..."
          if [ -z "${{ secrets.VM_HOST }}" ]; then echo "VM_HOST is empty"; else echo "VM_HOST is set"; fi
          if [ -z "${{ secrets.VM_PUBLIC_IP }}" ]; then echo "VM_PUBLIC_IP is empty"; else echo "VM_PUBLIC_IP is set"; fi

      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_HOST || secrets.VM_PUBLIC_IP }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          script: |
            # Kill existing service if running
            pkill -f hft_platform.main || true
            
            # Setup deployment directory
            cd ~/hft_platform || git clone https://github.com/Charliesj0129/subhft.git ~/hft_platform && cd ~/hft_platform
            git fetch origin
            git reset --hard origin/main
            
            # Install dependencies
            python3 -m venv .venv
            . .venv/bin/activate
            # Ensure shioaji and other deps are installed
            pip install -r requirements.txt
            
            # Run subscription script (generates config/symbols.yaml or similar if implemented, 
            # or just subscribes if it can communicate with a running service, 
            # BUT here we are running it BEFORE main loop or AFTER?)
            
            # Strategy: As per plan, run platform then subscribe.
            # But the subscribe script needs to know what to subscribe to?
            # Our script logic (see previous step) fetches open contracts.
            # If main.py reads config on start, we should generate config FIRST.
            
            # Let's run subscribe script to generate/update config if needed?
            # Or if it's a "live" subscriber, run it after.
            # The current script logic just prints "Subscribed...". 
            # It doesn't write to config yet.
            # For this MVP, we will stick to the plan: Run main, then run subscription script.
            # (Assuming the user might have logic in main to handle dynamic subs or the script does something useful).
            
            # Start Platform
            nohup python -m hft_platform.main > logs/run.log 2>&1 &
            
            # Wait for startup
            sleep 5
            
            # Run subscription script
            python -m hft_platform.scripts.subscribe_futures
