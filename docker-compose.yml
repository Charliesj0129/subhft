services:
  hft-base:
    build: .
    image: ${HFT_IMAGE:-hft-platform:latest}
    restart: always
    # Common Environment for all HFT services
    environment:
      - SHIOAJI_API_KEY=${SHIOAJI_API_KEY}
      - SHIOAJI_SECRET_KEY=${SHIOAJI_SECRET_KEY}
      - SHIOAJI_PERSON_ID=${SHIOAJI_PERSON_ID}
      - SHIOAJI_PASSWORD=${SHIOAJI_PASSWORD}
      - SHIOAJI_ACCOUNT=${SHIOAJI_ACCOUNT}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SYMBOLS_CONFIG=${SYMBOLS_CONFIG:-config/base/symbols.yaml}
      - HFT_CLICKHOUSE_HOST=clickhouse
      - HFT_CLICKHOUSE_ENABLED=1
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      - ./.wal:/app/.wal
      - ./data:/app/data
      - ./config:/app/config
      - ./scripts:/app/scripts
      - ./src:/app/src
    ulimits:
      memlock: -1
      nofile: 65535
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import psutil; exit(0)'"]
      interval: 30s
      timeout: 10s
      retries: 3

  hft-engine:
    extends: hft-base
    container_name: hft-engine
    command: ["python", "-m", "hft_platform.main"]
    # Switch to 'host' mode for low latency (set HFT_NETWORK_MODE=host in .env or via ops.sh)
    network_mode: ${HFT_NETWORK_MODE:-bridge}
    ports:
      - "${HFT_API_PORT:-9090}:9090"
    volumes:
      # Hugepages mount (only works if mapped on host)
      - /dev/hugepages:/dev/hugepages
    deploy:
      resources:
        limits:
          cpus: '${HFT_CPU_LIMIT:-0.50}'
          memory: ${HFT_MEM_LIMIT:-1500M}

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ports:
      - "8123:8123"
      - "9000:9000"
    ulimits:
      nofile: 262144
    volumes:
      # Always inject storage config (it handles default paths gracefully)
      - ./config/clickhouse_storage.xml:/etc/clickhouse-server/config.d/storage.xml
      # Configurable Data Root (Tiered Storage)
      - ${CH_DATA_ROOT:-ch_data_vol}/hot:/var/lib/clickhouse/data/hot
      - ${CH_DATA_ROOT:-ch_data_vol}/cold:/var/lib/clickhouse/data/cold
      # Metadata volume
      - ch_metadata:/var/lib/clickhouse 

  wal-loader:
    extends: hft-base
    container_name: wal-loader
    command: ["python", "-m", "hft_platform.recorder.loader"]
    depends_on:
      - clickhouse

  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/notebooks
      - ./src:/home/jovyan/src
    environment:
      - JUPYTER_TOKEN=hft

volumes:
  ch_data_vol:
  ch_metadata:
