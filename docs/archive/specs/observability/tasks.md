# Tasks – Observability & Audit Logging

| ID | Title | Description & Acceptance | Dependencies |
| --- | --- | --- | --- |
| T1 | Define logging/metrics schemas | Document standardized structlog formats (fields per component) and Prometheus metric names/labels in `contracts/observability.md`. Include audit log retention policy and ClickHouse table schemas. **Acceptance**: reviewed with ops/risk; schema published. | — |
| T2 | Instrument logging across components | Apply structured logging helper to market data, strategy, risk, order, execution, recorder modules; ensure required fields present (intent IDs, risk mode, etc.). Configure log rotation and shipping to ClickHouse/ELK. **Acceptance**: integration tests show logs emitted with schema; shipper ingests successfully. | T1 |
| T3 | Implement metrics registry & /metrics endpoint | Add Prometheus counters/gauges/histograms for feed, event bus, strategy latency, risk rejects, order actions, execution, recorder, and infra health. Expose `/metrics` endpoint without impacting hot path. **Acceptance**: Prometheus scrape returns metrics; unit tests verify labels/buckets. | T1 |
| T4 | Build Grafana dashboards | Create Feed & Gateway Health, Strategy & Order Path, PnL & Exposure, and Recorder/ClickHouse dashboards (JSON). **Acceptance**: dashboards load with live metrics; reviewed with trading/ops. | T3 |
| T5 | Configure alert rules & routing | Define Prometheus alert rules for CRIT/WARN scenarios (feed gap, bus overflow, StormGuard HALT, reject spikes, rate limits, latency, recorder/ClickHouse failures) and Alertmanager routes (Slack + pager/email). **Acceptance**: alerts fire in simulated scenarios; routing verified. | T3 |
| T6 | Audit log storage & retention | Set up ClickHouse tables for audit logs (orders, risk decisions, guardrail transitions, connectivity) with TTL policies, access controls, and ingestion pipeline (fluent-bit/vector). **Acceptance**: logs visible via SQL; retention policy documented. | T2 |
| T7 | Correlation IDs & tracing prep | Ensure correlation IDs/intent IDs propagate through logs/metrics and provide hooks for future OTEL spans. **Acceptance**: sample transaction can be traced end-to-end via log correlation; optional OTEL stub integrated. | T2, T3 |
| T8 | Runbooks & operator guides | Document dashboards, alert meanings, response procedures, and config-change logging. Include sections for feed gap, StormGuard HALT, recorder failure, ClickHouse issues. **Acceptance**: reviewed by ops; stored in repo. | T4, T5, T6 |
| T9 | Failure drills & validation tests | Simulate feed disconnection, bus overflow, StormGuard HALT, order reject spike, recorder failure to confirm alerts/dashboards behave as expected and logging captures events. **Acceptance**: recorded results demonstrating alert firing and runbook steps executed. | T2–T8 |
| T10 | Instrument ClickHouse & system metrics (v2) | Deploy/configure ClickHouse exporter and node/process exporters (or psutil agent) to collect insertion latency, merge backlog, disk usage, CPU/mem/NIC/disk metrics; extend dashboards/alerts accordingly. **Acceptance**: Prometheus scrape shows new metrics, Grafana dashboards include ClickHouse/system panels, alerts fire on simulated high disk/CPU or insert latency conditions. | T3–T5 |
