# Tasks – Execution Events & Position State

| ID | Title | Description & Acceptance | Dependencies |
| --- | --- | --- | --- |
| T1 | Define execution schemas & config | Document `OrderEvent`, `FillEvent`, `PositionDelta`, and snapshot formats in `contracts/execution.md`. Create `config/execution.yaml` for snapshot intervals, reconciliation thresholds, and API polling cadence. **Acceptance**: schemas reviewed with risk/ops; config validated. | — |
| T2 | Implement callback bridge & raw queue | Hook Shioaji `on_order/on_deal` callbacks, capture ingest timestamps, and enqueue lightweight `RawExecEvent`s without heavy processing. Include heartbeat monitoring and metrics. **Acceptance**: simulation demonstrates zero dropped callbacks; handlers return within microseconds. | T1 |
| T3 | Build execution normalizer | Consume raw events, enrich with intent metadata (`strategy_id`, `symbol`), dedupe via `(ordno, seqno, match_ts)`, and emit normalized `OrderEvent`/`FillEvent` to bus/recorder queues. **Acceptance**: unit tests with recorded payloads pass; dedupe counters verified. | T2 |
| T4 | Implement PositionStore & delta emission | Create in-memory store keyed by account/symbol/strategy, update on fills, compute realized/unrealized PnL, and emit delta + periodic snapshots. Expose read snapshots to StrategyRunner/Risk. **Acceptance**: integration tests show ≤10 ms latency from fill to risk visibility; snapshots serialized correctly. | T3 |
| T5 | Develop reconciliation service | Implement startup rebuild via broker snapshot APIs (respecting 25 calls/5 s limit) and runtime reconciliation when heartbeat gaps detected. Provide CLI command to trigger manual reconcile. **Acceptance**: restart test completes rebuild in ≤10 s; mismatch detection adjusts PositionStore. | T4 |
| T6 | Wire integrations & recorder feed | Connect normalized events to event bus, StrategyRunner, Risk, and Async Recorder (ClickHouse). Ensure schema mapping to `schemas/orders.sql`, `fills.sql`, `positions.sql`. **Acceptance**: end-to-end test shows strategies receiving fills, recorder writing rows, and metrics populated. | T3–T5 |
| T7 | Telemetry & alerting | Add metrics (event throughput, latency, reconciliation durations), structured logs, and alert thresholds (callback gaps, mismatches). **Acceptance**: dashboards show metrics; alert conditions verified via simulation. | T6 |
| T8 | Failure/mismatch tests | Simulate callback loss, duplicate fills, broker rejects, and reconciliation discrepancies to ensure corrections, alerts, and safe halts work as intended. **Acceptance**: pytest suite covers scenarios; HALT triggered when recovery exceeds thresholds. | T5–T7 |
| T9 | Documentation & runbooks | Document execution flow, PositionStore data model, reconciliation process, and operator procedures (snapshot, reconcile, troubleshoot mismatches). **Acceptance**: reviewed by ops; includes reference to relevant `sinotrade_tutor_md` APIs/limits. | T7, T8 |
