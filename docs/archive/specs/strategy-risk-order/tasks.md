# Tasks – Strategy Execution, Risk & Order Path

| ID | Title | Description & Acceptance | Dependencies |
| --- | --- | --- | --- |
| T1 | Define strategy/risk contracts & config | Specify `OrderIntent`, `RiskDecision`, `OrderCommand`, and StormGuard enums in `contracts/strategy.md`; add `config/strategy_limits.yaml` (per-symbol caps, price bands, PnL thresholds) and `config/order_adapter.yaml` (rate limits, coalescing windows). **Acceptance**: schemas reviewed with trading/risk; configs validated by CI. | — |
| T2 | Implement StrategyRunner thread | Build single-threaded runner consuming market events, invoking strategies with context, enforcing 100–200 µs budgets, and emitting intent lists into risk queue. Include latency metrics and automatic disable on repeated budget violations. **Acceptance**: unit tests simulate multiple strategies showing deterministic ordering and budget enforcement. | T1 |
| T3 | Build risk validators & StormGuard FSM | Implement price-band, size/notional, order-rate, and PnL validators; integrate StormGuard states (NORMAL/WARM/STORM/HALT) with configurable thresholds and enforcement behaviors (close-only, size reductions). **Acceptance**: table-driven tests cover transitions and rejection reason codes. | T1 |
| T4 | Implement risk worker pipeline | Wire validators into risk worker thread that consumes intents, applies checks, publishes approvals/rejects, and emits StormGuard events. Include soft/hard order-rate enforcement tied to sliding windows. **Acceptance**: integration test shows intents accepted/rejected per config; metrics exported for rejects. | T2, T3 |
| T5 | Develop OrderAdapter with coalescing | Create adapter worker that maps intents to Shioaji `place_order/update_order/cancel_order`, coalesces rapid amend/cancel bursts, and maintains live order map. **Acceptance**: simulated load shows coalescing reduces API calls; duplicate cancels suppressed. | T1, T4 |
| T6 | Add rate limiting & circuit breaker | Integrate sliding-window tracker for order actions (soft cap 180/10 s, hard 250/10 s) plus circuit-breaker states for repeated rejects/timeouts. Provide feedback signals to risk/strategies when throttling kicks in. **Acceptance**: tests drive action count past thresholds; system enters WARM/HALT and resumes correctly. | T5 |
| T7 | End-to-end integration & telemetry | Connect StrategyRunner → Risk → OrderAdapter, ensure ≤1 ms median tick→intent→command latency under benchmark. Expose metrics/logs for latency, rejects, StormGuard state, API usage; implement operator commands (enable/disable strategy, force StormGuard state). **Acceptance**: benchmark report demonstrates SLA; CLI commands verified. | T2–T6 |
| T8 | Failure-handling tests | Simulate broker rejects, rate-limit errors, and timeouts to verify retry policy (no blind retry on NEW, conservative on CANCEL/AMEND), cancel-all on HALT, and StormGuard escalations. **Acceptance**: pytest suite covers all failure cases with assertions on state transitions. | T5–T7 |
| T9 | Documentation & runbooks | Document StrategyRunner API, risk limits, StormGuard behavior, order adapter controls, and troubleshooting (e.g., what to do on circuit breaker). Include diagrams referencing Shioaji limits from `sinotrade_tutor_md/limit.md`. **Acceptance**: reviewed by trading + ops teams. | T7, T8 |
