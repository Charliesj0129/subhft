# Tasks – Market Data Ingestion, LOB, Event Bus

| ID | Title | Description & Acceptance | Dependencies |
| --- | --- | --- | --- |
| T1 | Define symbol catalog & market-event contracts | Create `config/symbols.yaml` with ≤200 curated instruments (per Shioaji `api.subscribe` cap) including tick size, exchange, odd-lot flag, and feed type. Document `MarketEvent` schema in `contracts/market_event.md` covering Tick/BidAsk/Quote fields from `sinotrade_tutor_md/market_data/streaming`. **Acceptance**: config validated against schema; docs reviewed by strategy team. | — |
| T2 | Embed Shioaji client & session manager | Integrate Python 3.11 Shioaji SDK via `pyo3`, implement login/token refresh, and enforce limits. **Critical**: Implement strict callback discipline where callbacks only decode/timestamp/enqueue and return. **Acceptance**: Callback execution time <50 µs; can connect to simulation endpoint and block additional subscriptions beyond 200. | T1 |
| T3 | Snapshot fetcher & bootstrap pipeline | Implement batch snapshot retrieval (`api.snapshots`) with ≤500 contracts per call and ≤50 data queries per 5 seconds. Apply snapshots to initialize LOB state and emit `L2Snapshot` events. **Acceptance**: integration test seeds 100 symbols in <1 s; snapshot batching respects rate limits. | T2 |
| T4 | Timestamp capture & normalization | Add `rdtsc` capture, calibration thread, and payload normalization (Decimal → fixed-point). Build `MarketEvent` structs carrying both timestamps and all fields (tick type, diff volumes, odd-lot flag). **Acceptance**: benchmark shows <100 ns overhead; unit tests ensure field parity with sample docs. | T2 |
| T5 | LOB engine implementation | Preallocate per-symbol state, apply snapshots and incremental BidAsk updates, maintain derived metrics, and validate monotonic exchange timestamps. **Acceptance**: deterministic tests for snapshot rebuild, incremental diffs, and regression detection. | T3, T4 |
| T6 | Disruptor-style event bus | Implement single-producer ring buffer with multi-consumer gating, timer injection, and fail-fast overflow logic as per design table. **Acceptance**: synthetic test achieves <1 µs publish latency, overflow triggers `FeedControl::FailFast`. | T4 |
| T7 | Integrate feed → LOB → bus pipeline | Wire Shioaji callbacks through normalization, LOB engine, and event bus; implement state machine (`INIT`, `TRADING`, `DISCONNECTED`, `RECOVERING`). **Acceptance**: replay harness feeds recorded ticks and verifies strict FIFO delivery and correct state transitions during simulated disconnect. | T3–T6 |
| T8 | Observability & compliance metrics | Emit structured logs (connection events, snapshot batches, heartbeat lag), Prometheus metrics (tick rate, buffer utilization, timestamp skew), and expose CLI to query `api.usage()` counters. **Acceptance**: dashboards show live metrics; alerts fire when tick silence >1 s or buffer >80%. | T7 |
| T9 | Performance, failover, and documentation | Run load/perf tests (≥5 kHz per symbol) and failover drills; record latency, throughput, rebuild time. Update runbook with recovery procedure, CPU pinning instructions, traffic-limit guidance. **Acceptance**: report demonstrates targets met; runbook approved by ops. | T7, T8 |
